<!DOCTYPE html>
<html lang="kr" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.104.1" />
    <meta name="description" content="COM2018 OOP Class Lecture Note">
<meta name="author" content="Soo Young Kim">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Lecture13. Useful ROS 2 Examples (Sensor Part) - Documentation for Hugo Learn Theme</title>

    
    <link href="/css/nucleus.css?1684950311" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1684950311" rel="stylesheet">
    <link href="/css/hybrid.css?1684950311" rel="stylesheet">
    <link href="/css/featherlight.min.css?1684950311" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1684950311" rel="stylesheet">
    <link href="/css/auto-complete.css?1684950311" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1684950311" rel="stylesheet">
    <link href="/css/theme.css?1684950311" rel="stylesheet">
    <link href="/css/tabs.css?1684950311" rel="stylesheet">
    <link href="/css/hugo-theme.css?1684950311" rel="stylesheet">
    
    <link href="/css/theme-green.css?1684950311" rel="stylesheet">
    
    <link href="/css/foo.css?1684950311" rel="stylesheet"><link href="/css/bar.css?1684950311" rel="stylesheet">

    <script src="/js/jquery-3.3.1.min.js?1684950311"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/kr/ros2_foxy/lecture13/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <img width="1097" alt="image" src="https://user-images.githubusercontent.com/12381733/209764275-05dcbdbf-cef7-47ad-94a6-6d61febad01e.png">
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1684950311"></script>
<script type="text/javascript" src="/js/auto-complete.js?1684950311"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/kr";
    
</script>
<script type="text/javascript" src="/js/search.js?1684950311"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/kr'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/kr/ros_basic_noetic/" title="ROS Basics" class="dd-item
        
        
        
        ">
      <a href="/kr/ros_basic_noetic/">
          <b>ROS Noetic. </b>ROS Basics
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture1/" title="Lecture1 - Introduction to ROS" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture1/">
        Lecture1 - Introduction to ROS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture2/" title="Lecture2 - Dev Env Setup" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture2/">
        Lecture2 - Dev Env Setup
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture3/" title="Lecture3 - Core of ROS" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture3/">
        Lecture3 - Core of ROS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture4/" title="Lecture4 - ROS Launch, RViz" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture4/">
        Lecture4 - ROS Launch, RViz
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture5/" title="Lecture5 - First Programming, ROS Topic" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture5/">
        Lecture5 - First Programming, ROS Topic
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture6/" title="Lecture6 - ROS Service, Parameter" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture6/">
        Lecture6 - ROS Service, Parameter
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture7/" title="Lecture7 - Rqt Tools and rosbag, ROS Time" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture7/">
        Lecture7 - Rqt Tools and rosbag, ROS Time
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture8/" title="Lecture8 - Deal with Open Source Projects, Custom Interfaces" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture8/">
        Lecture8 - Deal with Open Source Projects, Custom Interfaces
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture9/" title="Lecture9 - ROS TF and Examples" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture9/">
        Lecture9 - ROS TF and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture10/" title="Lecture10 - TF2 Examples, Outro" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture10/">
        Lecture10 - TF2 Examples, Outro
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/advanced_contents_ros1/" title="ROS" class="dd-item
        
        
        
        ">
      <a href="/kr/advanced_contents_ros1/">
          <b>Advanced Contents. </b>ROS
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros1/lecture1/" title="Lecture1 - ROSCPP" class="dd-item ">
        <a href="/kr/advanced_contents_ros1/lecture1/">
        Lecture1 - ROSCPP
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros1/lecture2/" title="Lecture2 - More About ROS System" class="dd-item ">
        <a href="/kr/advanced_contents_ros1/lecture2/">
        Lecture2 - More About ROS System
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros1/lecture3/" title="Lecture3 - SROS" class="dd-item ">
        <a href="/kr/advanced_contents_ros1/lecture3/">
        Lecture3 - SROS
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/ros2_basic_foxy/" title="ROS 2 Basics" class="dd-item
        
        
        
        ">
      <a href="/kr/ros2_basic_foxy/">
          <b>[Old]ROS 2 Foxy. </b>ROS 2 Basics
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture1/" title="Lecture1 - Introduction to ROS 2" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture1/">
        Lecture1 - Introduction to ROS 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture2/" title="Lecture2 - ROS 2 Node, Package" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture2/">
        Lecture2 - ROS 2 Node, Package
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture3/" title="Lecture3 - ROS 2 Node Programming, ROS 2 parameter" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture3/">
        Lecture3 - ROS 2 Node Programming, ROS 2 parameter
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture4/" title="Lecture4 - ROS 2 Node C&#43;&#43; Programming" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture4/">
        Lecture4 - ROS 2 Node C&#43;&#43; Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture5/" title="Lecture5 - ROS 2 Topic and Examples" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture5/">
        Lecture5 - ROS 2 Topic and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture6/" title="Lecture6 - ROS 2 Service and Examples" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture6/">
        Lecture6 - ROS 2 Service and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture7/" title="Lecture7 - Useful ROS 2 Example, Navigation2" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture7/">
        Lecture7 - Useful ROS 2 Example, Navigation2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture8/" title="Lecture8 - ROS 2 Action and Examples" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture8/">
        Lecture8 - ROS 2 Action and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture9/" title="Lecture9 - C&#43;&#43; Programming Again, Outro" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture9/">
        Lecture9 - C&#43;&#43; Programming Again, Outro
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/ros2_foxy/" title="ROS 2 Basics" class="dd-item
        parent
        
        
        ">
      <a href="/kr/ros2_foxy/">
          <b>[New]ROS 2 Foxy. </b>ROS 2 Basics
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture1/" title="Lecture1. What is ROS?" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture1/">
        Lecture1. What is ROS?
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture2/" title="Lecture2. Dev Env Setup" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture2/">
        Lecture2. Dev Env Setup
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture3/" title="Lecture3. Core of ROS" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture3/">
        Lecture3. Core of ROS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture4/" title="Lecture4. ROS 2 Node and Parameter Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture4/">
        Lecture4. ROS 2 Node and Parameter Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture5/" title="Lecture5. ROS 2 Communication Mechanisms" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture5/">
        Lecture5. ROS 2 Communication Mechanisms
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture6/" title="Lecture6. ROS 2 Tools" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture6/">
        Lecture6. ROS 2 Tools
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture7/" title="Lecture7. ROS 2 Topic and Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture7/">
        Lecture7. ROS 2 Topic and Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture8/" title="Lecture8. ROS 2 Service and Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture8/">
        Lecture8. ROS 2 Service and Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture9/" title="Lecture9. ROS 2 Action Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture9/">
        Lecture9. ROS 2 Action Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture10/" title="Lecture10. TF and ROS 2" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture10/">
        Lecture10. TF and ROS 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture11/" title="Lecture11. About Gazebo - 1" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture11/">
        Lecture11. About Gazebo - 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture12/" title="Lecture12. About Gazebo - 2" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture12/">
        Lecture12. About Gazebo - 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture13/" title="Lecture13. Useful ROS 2 Examples (Sensor Part)" class="dd-item active">
        <a href="/kr/ros2_foxy/lecture13/">
        Lecture13. Useful ROS 2 Examples (Sensor Part)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture14/" title="Lecture14. Useful ROS 2 Examples (Control Part)" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture14/">
        Lecture14. Useful ROS 2 Examples (Control Part)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture15/" title="Lecture15. Advanced ROS 2, Package Management" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture15/">
        Lecture15. Advanced ROS 2, Package Management
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture16/" title="Lecture16. Useful ROS 2 Examples (Misc)" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture16/">
        Lecture16. Useful ROS 2 Examples (Misc)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture17/" title="Lecture17. Real Hardware Examples" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture17/">
        Lecture17. Real Hardware Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture18/" title="Lecture18. Point Cloud Deep Learning Example (PointNet)" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture18/">
        Lecture18. Point Cloud Deep Learning Example (PointNet)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture19/" title="Lecture19. NVIDIA Isaac Sim" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture19/">
        Lecture19. NVIDIA Isaac Sim
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture20/" title="Lecture20. NVIDIA Jetson Platform" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture20/">
        Lecture20. NVIDIA Jetson Platform
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/advanced_contents_ros2/" title="ROS 2" class="dd-item
        
        
        
        ">
      <a href="/kr/advanced_contents_ros2/">
          <b>Advanced Contents. </b>ROS 2
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros2/lecture1/" title="Lecture1 - About DDS" class="dd-item ">
        <a href="/kr/advanced_contents_ros2/lecture1/">
        Lecture1 - About DDS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros2/lecture2/" title="Lecture11 - About DDS (2)" class="dd-item ">
        <a href="/kr/advanced_contents_ros2/lecture2/">
        Lecture11 - About DDS (2)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros2/lecture3/" title="Lecture12 - SROS2" class="dd-item ">
        <a href="/kr/advanced_contents_ros2/lecture3/">
        Lecture12 - SROS2
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/ros_and_gazebo/" title="Gazebo and ROS" class="dd-item
        
        
        
        ">
      <a href="/kr/ros_and_gazebo/">
          <b>Gazebo. </b>Gazebo and ROS
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_and_gazebo/lecture1/" title="Lecture1 - Gazebo and Robot" class="dd-item ">
        <a href="/kr/ros_and_gazebo/lecture1/">
        Lecture1 - Gazebo and Robot
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_and_gazebo/lecture2/" title="Lecture2 - Gazebo and Robot(2)" class="dd-item ">
        <a href="/kr/ros_and_gazebo/lecture2/">
        Lecture2 - Gazebo and Robot(2)
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/RB2023ROS/du2023-ros1"><i class='fab fa-fw fa-github'></i> GitHub repo - ROS 1</a>
              </li>
          
              <li>
                  <a class="padding" href="https://github.com/RB2023ROS/du2023-ros2"><i class='fab fa-fw fa-github'></i> GitHub repo - ROS 2</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="kr" value="/kr/ros2_foxy/lecture13/" selected>Korean</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      

      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='' href="https://github.com/com2018-fa22/hugo-blog/tree/main/content/ros2_foxy/lecture13.kr.md" target="blank">
                      <i class="fas fa-code-branch"></i>
                      <span id="top-github-link-text"></span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Lecture13. Useful ROS 2 Examples (Sensor Part)
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#useful-ros-2-examples-sensor-part">Useful ROS 2 Examples (Sensor Part)</a>
      <ul>
        <li><a href="#cv2-and-ros-2">CV2 and ROS 2</a></li>
        <li><a href="#cv2-and-rclpy">cv2 and rclpy</a></li>
        <li><a href="#코드-분석">코드 분석</a></li>
        <li><a href="#image-subscribe---python">Image Subscribe - Python</a></li>
        <li><a href="#rosbag2-to-seperate-image">rosbag2 to seperate image</a></li>
      </ul>
    </li>
    <li><a href="#cv2-and-rclcpp">CV2 and rclcpp</a>
      <ul>
        <li><a href="#image-publish---python-1">Image Publish - Python</a></li>
        <li><a href="#image-subscribe---python-1">Image Subscribe - Python</a></li>
      </ul>
    </li>
    <li><a href="#pcl-and-ros-2">PCL and ROS 2</a>
      <ul>
        <li><a href="#about-point-cloud">About Point Cloud</a></li>
        <li><a href="#pcd-format">PCD Format</a></li>
        <li><a href="#pcl-설치">PCL 설치</a></li>
        <li><a href="#pcl-python">PCL python</a></li>
        <li><a href="#voxel-grid-sampling">Voxel Grid Sampling</a></li>
        <li><a href="#pass-through-filter">Pass Through Filter</a></li>
        <li><a href="#ransac-plane-fitting">RANSAC Plane Fitting</a></li>
        <li><a href="#statistical-outlier-removal-filter">Statistical Outlier Removal Filter</a></li>
        <li><a href="#kd-tree-search">KD-Tree Search</a></li>
        <li><a href="#euclidean-clustering-dbscan">Euclidean Clustering (DBSCAN)</a></li>
      </ul>
    </li>
    <li><a href="#pcl-python-ros-2-연동">PCL python ROS 2 연동</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Lecture13. Useful ROS 2 Examples (Sensor Part)
            </h1>
          

        


<h2 id="useful-ros-2-examples-sensor-part">Useful ROS 2 Examples (Sensor Part)</h2>
<blockquote>
<p>Topic, Service, Action, Gazebo 예시들을 진행하면서 다양한 센서 데이터들을 다루어보았습니다. 이번 시간에는 예시들과 함께 해당 센서 데이터들의 ROS 2 연동 프로그램을 작성해 보겠습니다.</p>
</blockquote>
<h3 id="cv2-and-ros-2">CV2 and ROS 2</h3>
<p><img src="/kr/ros2_foxy/images13/Untitled.png?height=300px" alt="Untitled.png"></p>
<p>다양한 컴퓨터 비전 알고리즘을 담고 있는 오픈소스 비전 라이브러리인 OpenCV를 ROS 2와 연동하여 사용해 봅시다.</p>
<h3 id="cv2-and-rclpy">cv2 and rclpy</h3>
<blockquote>
<p>첫번째 시간으로 ROS 2의 이미지 데이터를 OpenCV Python, cv2와 연동하는 방법에 대해 알아보겠습니다.</p>
</blockquote>
<h4 id="image-publish---python">Image Publish - Python</h4>
<ul>
<li>우선, 항상 그렇듯이 예시를 실행해 보겠습니다.</li>
</ul>
<ol>
<li>온라인상에서 아무 영상 하나를 다운받아 위치를 기억해주세요.</li>
<li>img_pub.py 코드의 VIDEO_FILE_ROOT 변수를 해당 위치로 변경해줍니다.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Import the necessary libraries</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> rclpy <span style="color:#75715e"># Python Client Library for ROS 2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> rclpy.node <span style="color:#f92672">import</span> Node <span style="color:#75715e"># Handles the creation of nodes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sensor_msgs.msg <span style="color:#f92672">import</span> Image <span style="color:#75715e"># Image is the message type</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> cv_bridge <span style="color:#f92672">import</span> CvBridge <span style="color:#75715e"># Package to convert between ROS and OpenCV Images</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2 <span style="color:#75715e"># OpenCV library</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VIDEO_FILE_ROOT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/home/kimsooyoung/ros2_ws/rosbag2/img_pub_test.mp4&#34;</span>
</span></span></code></pre></div><ul>
<li>패키지를 빌드한 뒤, 예시를 실행합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Terminal 1 - pkg build and run</span>
</span></span><span style="display:flex;"><span>cbp py_cv_tutorial <span style="color:#f92672">&amp;&amp;</span> source install<span style="color:#f92672">/</span>local_setup<span style="color:#f92672">.</span>bash
</span></span><span style="display:flex;"><span>ros2 run py_cv_tutorial img_pub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terminal 2 - rqt_image_view</span>
</span></span><span style="display:flex;"><span>ros2 run rqt_image_view rqt_image_view
</span></span></code></pre></div><p>⇒ rqt image view는 이미지 topic만을 위한 rqt tool로 이미지 데이터를 시각화해줍니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled1.png?height=400px" alt="Untitled1.png"></p>
<h3 id="코드-분석">코드 분석</h3>
<ul>
<li>OpenCV에서는 이미지 데이터를 다룰 때 cv::Mat를 사용합니다. 반면 ROS 2는 sensor_msgs/msg/Image를 사용합니다. 따라서 Image &lt;=&gt; Mat 변환을 위해 <strong>CV Bridge</strong>를 사용합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> cv_bridge <span style="color:#f92672">import</span> CvBridge <span style="color:#75715e"># Package to convert between ROS and OpenCV Images</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2 <span style="color:#75715e"># OpenCV library</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImagePublisher</span>(Node):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Create an ImagePublisher class, which is a subclass of the Node class.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Used to convert between ROS and OpenCV images</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>br <span style="color:#f92672">=</span> CvBridge()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">timer_callback</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ret <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Publish the image.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># The &#39;cv2_to_imgmsg&#39; method converts an OpenCV</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># image to a ROS 2 image message</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>publisher_<span style="color:#f92672">.</span>publish(self<span style="color:#f92672">.</span>br<span style="color:#f92672">.</span>cv2_to_imgmsg(frame, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bgr8&#34;</span>))
</span></span></code></pre></div><p>⇒ CvBridge 객체의 imgmsg_to_cv2를 사용하면 손쉽게 Image data로 변환이 가능합니다.</p>
<h3 id="image-subscribe---python">Image Subscribe - Python</h3>
<blockquote>
<p>일전 학습하였던 rosbag2을 사용하여 예시를 실행해보고자 합니다. 제가 미리 준비한 데이터셋을 제공드리니, 기억하기 쉬운 위치에 다운받아 주세요.</p>
</blockquote>
<p>📁 <a href="https://drive.google.com/file/d/1HYLQHlbKDzDz6f5WP7esofm-k3X-2b7B/view?usp=sharing">quadrupped_train.zip</a></p>

<div class="notices note" ><p>Windows + WSL2 유저의 경우 <code>explorer.exe</code> 명령어를 통해 파일 탐색기를 열 수 있습니다.</p>
</div>

<ul>
<li>파일을 적당한 위치에 저장하고 replay 해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 예제 실행 준비</span>
</span></span><span style="display:flex;"><span>colcon build --packages-select py_cv_tutorial
</span></span><span style="display:flex;"><span>source install/local_setup.bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terminal 1 – 데이터 위치로 이동하여 ros2 bag 실행</span>
</span></span><span style="display:flex;"><span>cd &lt;데이터를 저장한 위치&gt;
</span></span><span style="display:flex;"><span>ros2 bag play quadrupped_train.bag_0.db3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terminal 2 – image_view 실행</span>
</span></span><span style="display:flex;"><span>ros2 run rqt_image_view rqt_image_view
</span></span></code></pre></div>
<div class="notices note" ><p>사진과 같이 기차 선로 모습이 보인다면 성공입니다.</p>
</div>

<p><img src="/kr/ros2_foxy/images13/Untitled2.png?height=300px" alt="Untitled2.png"></p>
<p>해당 데이터셋은 <strong>기차 선로에서 주행하는 4족 보행 로봇</strong>으로부터 취득한 것입니다. 기차 선로는 주기적으로 관리가 필요하며, 길고 긴 선로를 로봇이 자동으로 검사해준다면 아주 유용할 것입니다. 이러한 상상을 해보면서 실습에 임해봅시다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled3.png?height=400px" alt="Untitled3.png"></p>
<ul>
<li>다음은 ros2 bag을 재생하면서 생기는 Image topic을 subscribe한 뒤, 이를 cv2.imshow()로 시각화하는 예시입니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Terminal 1</span>
</span></span><span style="display:flex;"><span>$ cd &lt;bag 파일 위치&gt;
</span></span><span style="display:flex;"><span>$ ros2 bag play quadruped_train/quadruped_train.bag_0.db3
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1667077909.362223100<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>rosbag2_storage<span style="color:#f92672">]</span>: Opened database <span style="color:#e6db74">&#39;quadrupped_train/quadrupped_train.bag_0.db3&#39;</span> <span style="color:#66d9ef">for</span> READ_ONLY.
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terminal 2</span>
</span></span><span style="display:flex;"><span>$ ros2 run py_cv_tutorial img_sub
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1667077909.613586300<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>image_subscriber<span style="color:#f92672">]</span>: Receiving video frame
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1667077910.934147000<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>image_subscriber<span style="color:#f92672">]</span>: Receiving video frame
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><ul>
<li>이번에는 ROS2 msg를 cv데이터 포멧으로 변환해야 하지요? cv_bridge를 통해 imgmsg_to_cv2 함수를 실행하여 이 작업을 수행합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> cv_bridge <span style="color:#f92672">import</span> CvBridge <span style="color:#75715e"># Package to convert between ROS and OpenCV Images</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cv2 <span style="color:#75715e"># OpenCV library</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImageSubscriber</span>(Node):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Used to convert between ROS and OpenCV images</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>br <span style="color:#f92672">=</span> CvBridge()
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">listener_callback</span>(self, data):
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Convert ROS Image message to OpenCV image</span>
</span></span><span style="display:flex;"><span>        current_frame <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>br<span style="color:#f92672">.</span>imgmsg_to_cv2(data, <span style="color:#e6db74">&#34;bgr8&#34;</span>)
</span></span><span style="display:flex;"><span>        edge_frame <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>hough_transform(current_frame)
</span></span></code></pre></div><ul>
<li>imgmsg_to_cv2를 통해 CV::Mat으로 변환된 이미지 데이터를 OpenCV의 다양한 기능들과 함께 사용할 수 있습니다. 코드의 imshow 부분을 위와 같이 주석 토글하여 이미지 처리를 적용해 봅시다. 예시를 위해 직선검출 알고리즘을 사용해 보았습니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images13/Untitled4.png?height=300px" alt="Untitled4.png"></p>
<blockquote>
<p>직선 검출을 위해 사용된 OpenCV 기능들은 아래와 같습니다. 로직을 업그레이드하여 여러분만의 로직을 만들어 보세요!</p>
</blockquote>
<ul>
<li><a href="https://opencv-python.readthedocs.io/en/latest/doc/11.imageSmoothing/imageSmoothing.html">cv2.GaussianBlur</a></li>
<li><a href="https://www.geeksforgeeks.org/draw-a-filled-polygon-using-the-opencv-function-fillpoly/">cv2.fillPoly</a> / <a href="https://opencv-python.readthedocs.io/en/latest/doc/07.imageArithmetic/imageArithmetic.html">cv2.bitwise_and</a> ROI 설정</li>
<li><a href="https://opencv-python.readthedocs.io/en/latest/doc/25.imageHoughLineTransform/imageHoughLineTransform.html">cv2.HoughLinesP</a></li>
</ul>
<h3 id="rosbag2-to-seperate-image">rosbag2 to seperate image</h3>
<blockquote>
<p>컴퓨터 비전만으로 완벽한 선로 인식을 구현하기는 너무나 힘듭니다. 딥러닝을 사용해서 이를 극복할 수 있을 것이며, 데이터셋의 제작을 위해 rosbag2 데이터에서 이미지를 추출하는 예시를 준비하였습니다.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ros2 run py_cv_tutorial rosbag2_to_timedimg
</span></span><span style="display:flex;"><span>/home/kimsooyoung/ros2_ws/rosbag2/quadrupped_train/quadrupped_train.bag_0.db3
</span></span><span style="display:flex;"><span>saved: color_1666796292992515592.png
</span></span><span style="display:flex;"><span>saved: color_1666796293035428479.png
</span></span><span style="display:flex;"><span>saved: color_1666796293079139778.png
</span></span><span style="display:flex;"><span>saved: color_1666796293120768031.png
</span></span><span style="display:flex;"><span>saved: color_1666796293161406687.png
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><ul>
<li>예제 실행 전 main 함수에서 bag 파일의 위치를 여러분의 것으로 수정해야 합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(args<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Change below roots to your ros2 bag locations</span>
</span></span><span style="display:flex;"><span>    ROOT_DIR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/home/kimsooyoung/ros2_ws/rosbag2/quadrupped_train&#34;</span>
</span></span><span style="display:flex;"><span>    FILENAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/quadrupped_train.bag_0.db3&#34;</span>
</span></span><span style="display:flex;"><span>    DESCRIPTION <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;color_&#34;</span>
</span></span></code></pre></div><ul>
<li>예제 실행 후 사진과 같이 생성된 이미지들이 보인다면 성공입니다. wsl을 사용중이신 분들은 아래와 같이 파일 탐색기를 사용하세요</li>
</ul>
<p><img src="/kr/ros2_foxy/images13/Untitled5.png?height=400px" alt="Untitled5.png"></p>
<h2 id="cv2-and-rclcpp">CV2 and rclcpp</h2>
<blockquote>
<p>파이썬을 통해 ROS 2와 OpenCV를 연동하는 기본적인 맥락은 이해하셨으리라 생각합니다. 동일한작업을 C++에서 작업하면서 몇가지 유의점을 살펴보겠습니다.</p>
</blockquote>
<ul>
<li>코딩을 시작하기 전에, 제가 사용한 opencv 버전을 확인하고 가겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> pkg<span style="color:#f92672">-</span>config <span style="color:#f92672">--</span>modversion opencv4
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4.2.0</span>
</span></span></code></pre></div><h3 id="image-publish---python-1">Image Publish - Python</h3>
<ul>
<li>이번에 사용되는 파일은 img_pub.cpp이며, 정상 실행을 위해 VIDEO_FILE_ROOT 변수를 여러분의 영상 경로로 수정합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;rclcpp/rclcpp.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;std_msgs/msg/header.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;sensor_msgs/msg/image.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// cv_bridge converts between ROS 2 image messages and OpenCV image representations.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cv_bridge/cv_bridge.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">// Using image_transport allows us to publish and subscribe to compressed image streams in ROS2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;image_transport/image_transport.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">// We include everything about OpenCV as we don&#39;t care much about compilation time at the moment.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;opencv2/opencv.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string VIDEO_FILE_ROOT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/home/kimsooyoung/ros2_ws/go1_lidar.mp4&#34;</span>;
</span></span></code></pre></div><ul>
<li>예시 자체는 python과 동일합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Terminal 1 - run demo</span>
</span></span><span style="display:flex;"><span>ros2 run cpp_cv_tutorial img_pub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terminal 2 - rqt_image_view</span>
</span></span><span style="display:flex;"><span>ros2 run rqt_image_view rqt_image_view
</span></span></code></pre></div><ul>
<li>c++에서는 CvImage 객체를 굳이 생성해야 할 필요 없이 toImageMsg를 사용해 변환합니다. 대신 실제 msg로 사용할 때는 get() 함수를 통한 forwarding이 필요합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cv_bridge/cv_bridge.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;image_transport/image_transport.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;opencv2/opencv.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> timer_callback() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// // Create a new 640x480 image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// cv::Mat my_image(cv::Size(640, 480), CV_8UC3);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//--- GRAB AND WRITE LOOP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    cap.read(my_img);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (my_img.empty()){
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;ERROR! blank frame grabbed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>      rclcpp<span style="color:#f92672">::</span>shutdown();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write message to be sent. Member function toImageMsg() converts a CvImage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// into a ROS image message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    img_msg <span style="color:#f92672">=</span> cv_bridge<span style="color:#f92672">::</span>CvImage(std_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Header(), <span style="color:#e6db74">&#34;bgr8&#34;</span>, my_img).toImageMsg();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Publish the image to the topic defined in the publisher
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    image_pub<span style="color:#f92672">-&gt;</span>publish(<span style="color:#f92672">*</span>img_msg.get());
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h3 id="image-subscribe---python-1">Image Subscribe - Python</h3>
<ul>
<li>예제 실행을 위해 gazebo world를 실행해보겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ros2 launch chess_world chess_world.launch.py
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images13/chess_world.png?height=400px" alt="chess_world.png"></p>
<ul>
<li>사용하고 싶은 topic 이름을 img_sub.cpp에 반영한 뒤 예시를 실행합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImageSubscriber</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> rclcpp<span style="color:#f92672">::</span>Node{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>Subscription<span style="color:#f92672">&lt;</span>Image<span style="color:#f92672">&gt;::</span>SharedPtr m_img_sub;
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>Publisher<span style="color:#f92672">&lt;</span>Image<span style="color:#f92672">&gt;::</span>SharedPtr m_img_pub;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  ImageSubscriber()<span style="color:#f92672">:</span> Node(<span style="color:#e6db74">&#34;image_subscriber&#34;</span>){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string topic_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;video_frames&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    m_img_sub <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>create_subscription<span style="color:#f92672">&lt;</span>Image<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      topic_name, <span style="color:#ae81ff">10</span>, std<span style="color:#f92672">::</span>bind(<span style="color:#f92672">&amp;</span>ImageSubscriber<span style="color:#f92672">::</span>image_cb, <span style="color:#66d9ef">this</span>, std<span style="color:#f92672">::</span>placeholders<span style="color:#f92672">::</span>_1)
</span></span><span style="display:flex;"><span>    );
</span></span></code></pre></div><ul>
<li>예시 실행 - 아마 단순 이미지 프레임만 반복될 것입니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ros2 run cpp_cv_tutorial img_sub
</span></span></code></pre></div><ul>
<li>이번 예시는 일종의 template 처럼 작성해보았습니다.</li>
</ul>
<ol>
<li>image topic을 받아</li>
<li>프로세싱을 거치고</li>
<li>이 결과를 화면에 보여주는 예시입니다.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>cv<span style="color:#f92672">::</span>Mat image_processing(<span style="color:#66d9ef">const</span> cv<span style="color:#f92672">::</span>Mat img_in){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Create output image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  cv<span style="color:#f92672">::</span>Mat img_out;
</span></span><span style="display:flex;"><span>  cv<span style="color:#f92672">::</span>Mat img_small;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> img_out;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">image_cb</span>(<span style="color:#66d9ef">const</span> Image<span style="color:#f92672">::</span>SharedPtr msg) <span style="color:#66d9ef">const</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Convert ROS Image to CV Image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  cv<span style="color:#f92672">::</span>Mat frame <span style="color:#f92672">=</span> cv_bridge<span style="color:#f92672">::</span>toCvCopy(
</span></span><span style="display:flex;"><span>    msg, sensor_msgs<span style="color:#f92672">::</span>image_encodings<span style="color:#f92672">::</span>BGR8
</span></span><span style="display:flex;"><span>  )<span style="color:#f92672">-&gt;</span>image;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Image processing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  cv<span style="color:#f92672">::</span>Mat proced_img <span style="color:#f92672">=</span> image_processing(frame);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>현 시스템에서 OpenCV는 CMake의 find_package를 사용할 수 있기 때문에 C++ 예시를 빌드할 때 CMakeLists.txt에서 <strong>ament_target_dependencies를</strong> 명시합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>find_package(OpenCV REQUIRED)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add_executable(img_pub src<span style="color:#f92672">/</span>img_pub.cpp)
</span></span><span style="display:flex;"><span>ament_target_dependencies(img_pub rclcpp std_msgs sensor_msgs cv_bridge image_transport OpenCV)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add_executable(img_sub src<span style="color:#f92672">/</span>img_sub.cpp)
</span></span><span style="display:flex;"><span>ament_target_dependencies(img_sub rclcpp std_msgs sensor_msgs cv_bridge image_transport OpenCV)
</span></span></code></pre></div><h2 id="pcl-and-ros-2">PCL and ROS 2</h2>
<p><img src="/kr/ros2_foxy/images13/Untitled6.png?height=200px" alt="Untitled6.png"></p>
<blockquote>
<p>이번 시간부터 3D PointCloud Data 처리를 위한 다양한 기능을 제공하는 PCL(Point Cloud Library)을 실습하고 ROS 2와 연동해보고자 합니다.</p>
</blockquote>

<div class="notices note" ><p>사실 기본적인 PCL에 대한 이해가 있다면 일전 cv2 예시처럼 ROS 2 ⇒ PCL, PCL ⇒ ROS 2의 Mapping 작업만 잘 수행하면 되는데요. 따라서 python, c++에서 pcl을 다루는 방법에 대해 먼저 익숙해진 뒤 ROS 2에서 이를 구현하는 방식으로 진행하겠습니다.</p>
</div>

<h3 id="about-point-cloud">About Point Cloud</h3>
<ul>
<li>Point Cloud Data는 수많은 3차원 상의 데이터들이 모인 집합체입니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images13/Untitled7.png?height=300px" alt="Untitled7.png"></p>
<p>⇒ 하지만 x,y,z를 비롯해서 Point Cloud의 추가 데이터 항목들이 있습니다. 자주 사용되는 point cloud 포멧들을 살펴봅시다.</p>
<h4 id="pointxyz">PointXYZ</h4>
<p>가장 많이 사용하는 기본 데이터 타입으로 xyz 위치 데이터만 담고 있습니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled8.png?height=300px" alt="Untitled8.png"></p>
<h4 id="pointxyzi">PointXYZI</h4>
<p>intensity라는 필드가 추가된 형태로 이는 물체로부터 되돌아온 빛의 양을 뜻합니다. 바닥에 고인 물이나 투명한 물체의 경우 이 I 필드를 통해 detection 가능하여 최근 활발히 연구되고 있습니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled9.png?height=300px" alt="Untitled9.png"></p>
<h4 id="pointxyzrgb">PointXYZRGB</h4>
<p>RGB 3색이 포함된 데이터 타입으로 rgbd camera에서 주로 사용됩니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled10.png?height=400px" alt="Untitled10.png"></p>
<h3 id="pcd-format">PCD Format</h3>
<p>Point Cloud는 여러 데이터 포맷으로 사용 가능하지만 가장 자주 사용되는 것은 pcd 포맷입니다. 이는 크게 header/data로 구분되어 있으며 예시를 통해 함께 익숙해져보겠습니다.</p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Header</td>
<td>전체 포인트 수, 데이터 타입, 크기 등의 정보</td>
</tr>
<tr>
<td>Data</td>
<td>x,y,z 또는 x,y,z + 추가정보</td>
</tr>
</tbody>
</table>
<ul>
<li>example - xyzrgb format</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># .PCD v0.7 - Point Cloud Data file format</span>
</span></span><span style="display:flex;"><span>VERSION <span style="color:#ae81ff">0.7</span>
</span></span><span style="display:flex;"><span>FIELDS x y z rgb
</span></span><span style="display:flex;"><span>SIZE <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>TYPE F F F U
</span></span><span style="display:flex;"><span>COUNT <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>WIDTH <span style="color:#ae81ff">4421</span>
</span></span><span style="display:flex;"><span>HEIGHT <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>VIEWPOINT <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>POINTS <span style="color:#ae81ff">4421</span>
</span></span><span style="display:flex;"><span>DATA ascii
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#ae81ff">0.8739934</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.342802</span> <span style="color:#ae81ff">0.73930842</span> <span style="color:#ae81ff">1577997</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#ae81ff">0.86556709</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.342802</span> <span style="color:#ae81ff">0.73930842</span> <span style="color:#ae81ff">1577997</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#ae81ff">0.85433203</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.3428019</span> <span style="color:#ae81ff">0.73930848</span> <span style="color:#ae81ff">1577997</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#ae81ff">0.84450132</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.3428019</span> <span style="color:#ae81ff">0.73930854</span> <span style="color:#ae81ff">1577997</span>
</span></span></code></pre></div><ul>
<li>ROS 2에서 사용하는 PointCloud 데이터 포맷은 크게 두가지가 있습니다.</li>
</ul>
<ol>
<li>sensor_msgs/msg/PointCloud</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std_msgs<span style="color:#f92672">/</span>Header header
</span></span><span style="display:flex;"><span>geometry_msgs<span style="color:#f92672">/</span>Point32[] points
</span></span><span style="display:flex;"><span>ChannelFloat32[] channels
</span></span></code></pre></div><ol start="2">
<li>sensor_msgs/msg/PointCloud2</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>std_msgs<span style="color:#f92672">/</span>Header header
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>uint32 height
</span></span><span style="display:flex;"><span>uint32 width
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PointField[] fields
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bool    is_bigendian <span style="color:#75715e"># Is this data bigendian?</span>
</span></span><span style="display:flex;"><span>uint32  point_step   <span style="color:#75715e"># Length of a point in bytes</span>
</span></span><span style="display:flex;"><span>uint32  row_step     <span style="color:#75715e"># Length of a row in bytes</span>
</span></span><span style="display:flex;"><span>uint8[] data         <span style="color:#75715e"># Actual point data, size is (row_step*height)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bool is_dense        <span style="color:#75715e"># True if there are no invalid points</span>
</span></span></code></pre></div>
<div class="notices note" ><p>PointCloud2가 더욱 풍부한 데이터를 담고 있는데요. ROS 2 Foxy 이상부터 PointCloud2를 지원하며 그 이후 버전부터 PointCloud는 거의 사용하지 않습니다.</p>
</div>

<h3 id="pcl-설치">PCL 설치</h3>
<p>PCL c++은 ROS 2 설치 시 자동으로 설치되므로 별도 설치는 필요 없습니다. (오히려 잘못 건들면 복잡해지므로 가만히 냅둡시다.) PCL python은 ubuntu 버전에 따라 설치 방법이 다릅니다.</p>
<ul>
<li>ubuntu ≤ 18.04</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo pip install cython
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo apt<span style="color:#f92672">-</span>get install pcl<span style="color:#f92672">-</span>tools
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo apt install python3<span style="color:#f92672">-</span>pcl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo add<span style="color:#f92672">-</span>apt<span style="color:#f92672">-</span>repository ppa:sweptlaser<span style="color:#f92672">/</span>python3<span style="color:#f92672">-</span>pcl
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo apt update
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo apt install python3<span style="color:#f92672">-</span>pcl
</span></span></code></pre></div><ul>
<li>ubuntu ≥ 20.04</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo apt install python3<span style="color:#f92672">-</span>pcl
</span></span></code></pre></div><ul>
<li>설치가 잘 되었는지 확인해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> python3
</span></span><span style="display:flex;"><span>Python <span style="color:#ae81ff">3.8.10</span>
</span></span><span style="display:flex;"><span>[GCC <span style="color:#ae81ff">9.4.0</span>] on linux
</span></span><span style="display:flex;"><span>Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> pcl
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span>
</span></span></code></pre></div><h3 id="pcl-python">PCL python</h3>
<blockquote>
<p>아래 표와 같이 pcl은 다양한 알고리즘을 API 형태로 제공하고 있습니다. 이들에 익숙해지기 위해 python pcl을 사용하여 실습을 해본 뒤, 실제 ROS 2 topic을 처리해보고, c++로도 사용해보겠습니다.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Fuction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>pcl_visualization</td>
<td>PointCloud 시각화 도구</td>
</tr>
<tr>
<td>pcl_surface</td>
<td>3차원 곡면 복원</td>
</tr>
<tr>
<td>pcl_segmentation</td>
<td>PointCloud의 Clustering과 Classification 기능</td>
</tr>
<tr>
<td>pcl_sample_consensus</td>
<td>선, 평면, 실린더 등 모델 추정을 위한 알고리즘</td>
</tr>
<tr>
<td>pcl_kdtree</td>
<td>빠른 처리, 탐색을 위한 자료 구조</td>
</tr>
<tr>
<td>pcl_features</td>
<td>PointCloud로부터 특징 추출을 위한 자료 구조와 방법들</td>
</tr>
<tr>
<td>pcl_registration</td>
<td>ICP와 같이 서로 다른 PointCloud를 Align하고 정합하기 위한 방법들</td>
</tr>
<tr>
<td>pcl_keypoints</td>
<td>Key point 검출 알고리즘 (BRISK, Harris Corner, NARF, SIFT, SUSAN 등)</td>
</tr>
<tr>
<td>pcl_io 3D</td>
<td>센서로부터 PointCloud 데이터를 직접 읽고 쓰기 위한 인터페이스</td>
</tr>
</tbody>
</table>
<h4 id="pcl-io">PCL IO</h4>
<ul>
<li>pcd 포멧의 point cloud 데이터를 읽고, 저장하고, 시각화하는 방법은 아래와 같습니다.</li>
</ul>
<pre tabindex="0"><code>cd py_pcl_tutorial/exercise
python3 example1_load_and_view.py
</code></pre><ul>
<li>example1_load_and_view.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pcl
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pcl.pcl_visualization
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load point cloud file</span>
</span></span><span style="display:flex;"><span>cloud <span style="color:#f92672">=</span> pcl<span style="color:#f92672">.</span>load_XYZRGB(<span style="color:#e6db74">&#39;./data/pcl_sub_node.pcd&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create pcl built-in viewer</span>
</span></span><span style="display:flex;"><span>visual <span style="color:#f92672">=</span> pcl<span style="color:#f92672">.</span>pcl_visualization<span style="color:#f92672">.</span>CloudViewing()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##### Visualize APIs #####</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;ShowColorACloud&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;ShowColorCloud&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;ShowGrayCloud&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;ShowMonochromeCloud&#39;,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#39;WasStopped&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;example_save.pcd&#39;</span>
</span></span><span style="display:flex;"><span>pcl<span style="color:#f92672">.</span>save(cloud, filename)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>visual<span style="color:#f92672">.</span>ShowColorCloud(cloud, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cloud&#39;</span>)
</span></span><span style="display:flex;"><span>v <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> v:
</span></span><span style="display:flex;"><span>    v <span style="color:#f92672">=</span> <span style="color:#f92672">not</span>(visual<span style="color:#f92672">.</span>WasStopped())
</span></span></code></pre></div>
<div class="notices note" ><p>pcl_sub_node.pcd는 lidar world에서 제가 미리 추출해 둔 pointcloud 입니다.</p>
</div>

<p><img src="/kr/ros2_foxy/images13/Untitled11.png?height=400px" alt="Untitled11.png"></p>
<table>
<thead>
<tr>
<th></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>pcl.load_XYZRGB(<!-- raw HTML omitted -->)</td>
<td>pcd data를 load합니다. 단, 저장된 유형에 따라 load_XYZ, load_XYZI 등 사용하는 함수가 다릅니다.</td>
</tr>
<tr>
<td>pcl.pcl_visualization.CloudViewing()</td>
<td>시각화를 위한 뷰어를 생성합니다.</td>
</tr>
<tr>
<td>pcl.save(<!-- raw HTML omitted -->, <!-- raw HTML omitted -->)</td>
<td>처리한 cloud를 저장합니다.</td>
</tr>
</tbody>
</table>
<h3 id="voxel-grid-sampling">Voxel Grid Sampling</h3>
<p>수많은 point cloud들을 모두 각각 처리하는 것은 매우 많은 연산을 요합니다. 따라서 보통 이를 3차원 격자의 Voxel 형태로 Sampling 합니다. Voxel이란, 마치 게임 그래픽처럼 해상도를 낮춘 큐브이며 Voxel 내 점 군 유/무에 따라 중심점을 샘플링합니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled12.png?height=200px" alt="Untitled12.png">
<img src="/kr/ros2_foxy/images13/Untitled13.png?height=200px" alt="Untitled13.png"></p>
<ul>
<li>example2_voxelgrid.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Voxel Grid filter</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create a VoxelGrid filter object for our input point cloud</span>
</span></span><span style="display:flex;"><span>vox <span style="color:#f92672">=</span> cloud<span style="color:#f92672">.</span>make_voxel_grid_filter()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Choose a voxel (also known as leaf) size</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Note: this (1) is a poor choice of leaf size</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Experiment and find the appropriate size!</span>
</span></span><span style="display:flex;"><span>LEAF_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set the voxel (or leaf) size</span>
</span></span><span style="display:flex;"><span>vox<span style="color:#f92672">.</span>set_leaf_size(LEAF_SIZE, LEAF_SIZE, LEAF_SIZE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Call the filter function to obtain the resultant downsampled point cloud</span>
</span></span><span style="display:flex;"><span>cloud_voxed <span style="color:#f92672">=</span> vox<span style="color:#f92672">.</span>filter()
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images13/Untitled14.png?height=400px" alt="Untitled14.png"></p>

<div class="notices note" ><p>LEAF_SIZE = 0.01</p>
</div>

<p><img src="/kr/ros2_foxy/images13/Untitled15.png?height=400px" alt="Untitled15.png"></p>

<div class="notices note" ><p>LEAF_SIZE = 0.1</p>
</div>

<h3 id="pass-through-filter">Pass Through Filter</h3>
<p>ROI(Region of Interest)를 설정하고 원하는 위치의 point cloud들만 추려내보겠습니다. 주로 바닥 지점이나, 테이블 위 물체에서 물체 부분만 추출하는 경우 사용됩니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled16.png?height=200px" alt="Untitled16.png"></p>
<ul>
<li>example3_roi_filter.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Pass Through filter</span>
</span></span><span style="display:flex;"><span>passthrough <span style="color:#f92672">=</span> cloud_voxed<span style="color:#f92672">.</span>make_passthrough_filter()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Assign axis and range to the passthrough filter object.</span>
</span></span><span style="display:flex;"><span>filter_axis <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;z&#39;</span>
</span></span><span style="display:flex;"><span>passthrough<span style="color:#f92672">.</span>set_filter_field_name(filter_axis)
</span></span><span style="display:flex;"><span>axis_min <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span>axis_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span>passthrough<span style="color:#f92672">.</span>set_filter_limits(axis_min, axis_max)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cloud_filtered <span style="color:#f92672">=</span> passthrough<span style="color:#f92672">.</span>filter()
</span></span></code></pre></div><p>⇒ 현재 z축을 기준으로 -1.1 ~ 1.1 영역을 필터링하였습니다. x y 축에 대해서도 동일 작업이 가능합니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled17.png?height=400px" alt="Untitled17.png"></p>
<h3 id="ransac-plane-fitting">RANSAC Plane Fitting</h3>
<p>직선은 2개의 매개변수로, 평면은 3개의 매개변수로 모델링할 수 있습니다. PCL에서는 이런 모델 기반 Consensus를 사용하는 가장 대표적인 예시인 RANSAC을 제공하고 있습니다.</p>
<p><img src="/kr/ros2_foxy/images13/Untitled18.png?height=200px" alt="Untitled18.png"></p>
<ul>
<li>Model Hypothesis를 통해 매개변수를 구했다면, 해당 모델에 포함되는 inlier와 outlier를 추출할 수 있게 됩니다. 이때 inlier의 임계값으로 허용하는 최대 거리가 max_distance입니다.</li>
<li>seg.segment()를 통해 도출한 inlier index 들로 기존 point cloud에서 inliner/outlier들을 추출할 수 있습니다.
negative=True ⇒ outlier extraction
negative=False ⇒ inlier extraction</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># RANSAC plane segmentation</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create the segmentation object</span>
</span></span><span style="display:flex;"><span>seg <span style="color:#f92672">=</span> cloud_filtered<span style="color:#f92672">.</span>make_segmenter()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set the model you wish to fit</span>
</span></span><span style="display:flex;"><span>seg<span style="color:#f92672">.</span>set_model_type(pcl<span style="color:#f92672">.</span>SACMODEL_PLANE)
</span></span><span style="display:flex;"><span>seg<span style="color:#f92672">.</span>set_method_type(pcl<span style="color:#f92672">.</span>SAC_RANSAC)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Max distance for a point to be considered fitting the model</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Experiment with different values for max_distance</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for segmenting the table</span>
</span></span><span style="display:flex;"><span>max_distance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>
</span></span><span style="display:flex;"><span>seg<span style="color:#f92672">.</span>set_distance_threshold(max_distance)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Call the segment function to obtain set of inlier indices and model coefficients</span>
</span></span><span style="display:flex;"><span>inliers, coefficients <span style="color:#f92672">=</span> seg<span style="color:#f92672">.</span>segment()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Extract inliers</span>
</span></span><span style="display:flex;"><span>extracted_inliers <span style="color:#f92672">=</span> cloud_filtered<span style="color:#f92672">.</span>extract(inliers, negative<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images13/Untitled19.png?height=400px" alt="Untitled19.png"></p>

<div class="notices note" ><p>목적 자체는 바닥을 제거한다는 점에서 Pass Through Filter와 동일하지만, 사용되는 알고리즘에서 차이를 갖습니다.</p>
</div>

<h3 id="statistical-outlier-removal-filter">Statistical Outlier Removal Filter</h3>
<blockquote>
<p>실제 센서를 사용하다보면 사진과 같이 노이즈도 심하고, 의도치 않는 비정상적인 이상치가 발생합니다. PCL에서는 일종의 평균 필터를 통해 이를 제거하는 함수를 갖고 있습니다.</p>
</blockquote>
<p><img src="/kr/ros2_foxy/images13/Untitled20.png?height=200px" alt="Untitled20.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Much like the previous filters, we start by creating a filter object:</span>
</span></span><span style="display:flex;"><span>outlier_filter <span style="color:#f92672">=</span> cloud_filtered<span style="color:#f92672">.</span>make_statistical_outlier_filter()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set the number of neighboring points to analyze for any given point</span>
</span></span><span style="display:flex;"><span>outlier_filter<span style="color:#f92672">.</span>set_mean_k(<span style="color:#ae81ff">50</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set threshold scale factor</span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Any point with a mean distance larger than global (mean distance+x*std_dev) will be considered outlier</span>
</span></span><span style="display:flex;"><span>outlier_filter<span style="color:#f92672">.</span>set_std_dev_mul_thresh(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Finally call the filter function for magic</span>
</span></span><span style="display:flex;"><span>cloud_filtered <span style="color:#f92672">=</span> outlier_filter<span style="color:#f92672">.</span>filter()
</span></span></code></pre></div><p>⇒ 현재 우리 예시는 Gazebo에서 추출한지라 이 필터의 영향이 거의 없습니다. 따라서 예제 코드는 생략하겠습니다.</p>
<h3 id="kd-tree-search">KD-Tree Search</h3>
<blockquote>
<p>KD-Tree는 Binary Tree를 응용한 K 차원의 자료 구조입니다. x,y,z 3차원에 대한 KD-Tree를 구축하고, 이 안에 모든 point들을 가지런히 추가해두면, 이후 거리 계산 등 연산 시 매우 빠른 탐색이 가능합니다.</p>
</blockquote>
<p><img src="/kr/ros2_foxy/images13/Untitled21.png?height=200px" alt="Untitled21.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># create kd tree for the search method of extraction</span>
</span></span><span style="display:flex;"><span>tree <span style="color:#f92672">=</span> extracted_inliers<span style="color:#f92672">.</span>make_kdtree()
</span></span></code></pre></div><p>⇒ XYZRGB 데이터는 make_kdtree_flann()이라는 함수를 사용합니다.</p>
<h3 id="euclidean-clustering-dbscan">Euclidean Clustering (DBSCAN)</h3>
<blockquote>
<p>Point Cloud들을 분류하여 군집화를 해야 물체 인식과 추정이 가능합니다. 군집과 알고리즘에는 여러 종류가 있지만 이번 실습에서는 밀집도를 기준으로 분류하는 Euclidean Clustering을 사용하겠습니다.</p>
</blockquote>

<div class="notices tip" ><p>이 방식은 클러스터 수를 지정하지 않아도 알아서 클러스터 수도 결정하고, 불특정한 형상의 클러스터도 분류할 수 있습니다. 뿐만 아니라 노이즈에도 강인한 알고리즘입니다.</p>
</div>

<p><img src="/kr/ros2_foxy/images13/Untitled22.png?height=200px" alt="Untitled22.png"></p>
<ul>
<li>example5_clustering.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Load point cloud file</span>
</span></span><span style="display:flex;"><span>cloud <span style="color:#f92672">=</span> pcl<span style="color:#f92672">.</span>load_XYZRGB(<span style="color:#e6db74">&#39;./data/pcl_sub_node.pcd&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># eliminate color from cloud for clustering</span>
</span></span><span style="display:flex;"><span>while_cloud <span style="color:#f92672">=</span> XYZRGB_to_XYZ(cloud)
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create a cluster extraction object</span>
</span></span><span style="display:flex;"><span>ec <span style="color:#f92672">=</span> extracted_inliers<span style="color:#f92672">.</span>make_EuclideanClusterExtraction()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set tolerances for distance threshold</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># as well as minimum and maximum cluster size (in points)</span>
</span></span><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_ClusterTolerance(<span style="color:#ae81ff">0.07</span>)
</span></span><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_MinClusterSize(<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_MaxClusterSize(<span style="color:#ae81ff">25000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Search the k-d tree for clusters</span>
</span></span><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_SearchMethod(tree)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Extract indices for each of the discovered clusters</span>
</span></span><span style="display:flex;"><span>cluster_indices <span style="color:#f92672">=</span> ec<span style="color:#f92672">.</span>Extract()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create Cluster-Mask Point Cloud to visualize each cluster separately</span>
</span></span><span style="display:flex;"><span>get_color_list<span style="color:#f92672">.</span>color_list <span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>cluster_color <span style="color:#f92672">=</span> get_color_list(len(cluster_indices))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Assign a color corresponding to each segmented object in scene</span>
</span></span><span style="display:flex;"><span>color_cluster_point_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> j, indices <span style="color:#f92672">in</span> enumerate(cluster_indices):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, indice <span style="color:#f92672">in</span> enumerate(indices):
</span></span><span style="display:flex;"><span>        color_cluster_point_list<span style="color:#f92672">.</span>append([extracted_inliers[indice][<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>                                        extracted_inliers[indice][<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>                                        extracted_inliers[indice][<span style="color:#ae81ff">2</span>],
</span></span><span style="display:flex;"><span>                                        rgb_to_float(cluster_color[j])])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Create new cloud containing all clusters, each with unique color</span>
</span></span><span style="display:flex;"><span>cluster_cloud <span style="color:#f92672">=</span> pcl<span style="color:#f92672">.</span>PointCloud_PointXYZRGB()
</span></span><span style="display:flex;"><span>cluster_cloud<span style="color:#f92672">.</span>from_list(color_cluster_point_list)
</span></span></code></pre></div><ul>
<li>이전 예시와 달리, clustering을 위해 필요없는 색상 데이터는 제거하였습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Load point cloud file</span>
</span></span><span style="display:flex;"><span>cloud <span style="color:#f92672">=</span> pcl<span style="color:#f92672">.</span>load_XYZRGB(<span style="color:#e6db74">&#39;./data/pcl_sub_node.pcd&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># eliminate color from cloud for clustering</span>
</span></span><span style="display:flex;"><span>while_cloud <span style="color:#f92672">=</span> XYZRGB_to_XYZ(cloud)
</span></span></code></pre></div><ul>
<li>make_EuclideanClusterExtraction()을 통해 filter를 구성하고 매개변수를 설정합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Create a cluster extraction object</span>
</span></span><span style="display:flex;"><span>ec <span style="color:#f92672">=</span> extracted_inliers<span style="color:#f92672">.</span>make_EuclideanClusterExtraction()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set tolerances for distance threshold</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># as well as minimum and maximum cluster size (in points)</span>
</span></span><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_ClusterTolerance(<span style="color:#ae81ff">0.07</span>)
</span></span><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_MinClusterSize(<span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_MaxClusterSize(<span style="color:#ae81ff">25000</span>)
</span></span></code></pre></div><table>
<thead>
<tr>
<th></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>set_ClusterTolerance</td>
<td>point clout 처리 시 cluster로 판단하는 기준 거리</td>
</tr>
<tr>
<td>set_MinClusterSize</td>
<td>cluster가 되기 위한 최소 point cloud 개수</td>
</tr>
<tr>
<td>set_MaxClusterSize</td>
<td>cluster가 되기 위한 최대 point cloud 개수</td>
</tr>
</tbody>
</table>
<ul>
<li>cluster를 판단하기 위해 거리계산이 필요하며, 이는 일전 생성한 KD tree를 사용합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ec<span style="color:#f92672">.</span>set_SearchMethod(tree)
</span></span></code></pre></div><ul>
<li>clustering의 결과는 point cloud set이 아니라 cluster와 이에 해당하는 point들의 index입니다. 따라서 extract 이후 별도의 후처리 과정이 필요합니다. 현재는 서로 다른 cluster 마다 색상을 부여하여 시각화하고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Extract indices for each of the discovered clusters</span>
</span></span><span style="display:flex;"><span>cluster_indices <span style="color:#f92672">=</span> ec<span style="color:#f92672">.</span>Extract()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create Cluster-Mask Point Cloud to visualize each cluster separately</span>
</span></span><span style="display:flex;"><span>get_color_list<span style="color:#f92672">.</span>color_list <span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span>cluster_color <span style="color:#f92672">=</span> get_color_list(len(cluster_indices))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Assign a color corresponding to each segmented object in scene</span>
</span></span><span style="display:flex;"><span>color_cluster_point_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> j, indices <span style="color:#f92672">in</span> enumerate(cluster_indices):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, indice <span style="color:#f92672">in</span> enumerate(indices):
</span></span><span style="display:flex;"><span>        color_cluster_point_list<span style="color:#f92672">.</span>append([extracted_inliers[indice][<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>                                        extracted_inliers[indice][<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>                                        extracted_inliers[indice][<span style="color:#ae81ff">2</span>],
</span></span><span style="display:flex;"><span>                                        rgb_to_float(cluster_color[j])])
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images13/Untitled23.png?height=400px" alt="Untitled23.png"></p>
<h2 id="pcl-python-ros-2-연동">PCL python ROS 2 연동</h2>
<blockquote>
<p>지금까지 배운 내용들을 총동원해서 PCL를 ROS 2와 연동해보겠습니다.</p>
</blockquote>
<ul>
<li>예시 실행</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terminal 1 - gazebo world launch</span>
</span></span><span style="display:flex;"><span>ros2 launch lidar_world lidar_world<span style="color:#f92672">.</span>launch<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Terminal 2 - python node run</span>
</span></span><span style="display:flex;"><span>ros2 run py_pcl_tutorial pcl_cluster_pub
</span></span><span style="display:flex;"><span>[INFO] [<span style="color:#ae81ff">1682602819.908146533</span>] [pcl_cluster_node]: PCL Cluster Node has been started
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images13/Untitled24.png?height=400px" alt="Untitled24.png"></p>

<div class="notices note" ><p>rviz2를 통해 /cluster topic을 subscribe 하면, 사진과 같이 물체별로 다른 색상이 적용된 새로운 pointcloud topic을 확인할 수 있습니다.</p>
</div>

<blockquote>
<p>코드를 분석하기 전, 전체 시스템을 요약해보았습니다.</p>
</blockquote>
<ol>
<li>ROS 2의 PointCloud2 msg를 PCL 타입으로 변환합니다.</li>
<li>PCL data와 일전 예시 코드를 통해 clustering을 구현합니다.</li>
<li>분리한 cluster들에 개별 색상을 부여하고, 다시 ROS 2 PointCloud2 타입으로 변환합니다.</li>
<li>topic publish!</li>
</ol>
<ul>
<li>ROS 2 ⇒ PCL / PCL ⇒ ROS 2 사이의 변환은 pcl_helper라는 별도 코드를 구현해 두었습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ros2_to_pcl</span>(ros_cloud):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Converts a ROS PointCloud2 message to a pcl PointXYZRGB
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ros_cloud (PointCloud2): ROS PointCloud2 message
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pcl.PointCloud_PointXYZRGB: PCL XYZRGB point cloud
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pcl_to_ros2</span>(pcl_array, now<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Converts a pcl PointXYZRGB to a ROS PointCloud2 message
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pcl_array (PointCloud_PointXYZRGB): A PCL XYZRGB point cloud
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            now (Time): A ROS 2 time object like self.get_clock().now()
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            PointCloud2: A ROS point cloud
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span></code></pre></div>
<div class="notices note" ><p>주의해야 할 점으로, PCL ⇒ ROS 2 변환 시에는 시간에 대한 데이터가 추가되니 Node 내부의 clock에서 now 객체를 전달해야 합니다.</p>
</div>

<ul>
<li>PCLClusterNode의 생성자에서 subscriber와 publisher를 하나씩 생성합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PCLClusterNode</span>(Node):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(<span style="color:#e6db74">&#39;pcl_cluster_node&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pc_subscription <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_subscription(
</span></span><span style="display:flex;"><span>            PointCloud2, <span style="color:#e6db74">&#39;pointcloud&#39;</span>,
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>pcl_callback, <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>cluster_publisher <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_publisher(
</span></span><span style="display:flex;"><span>            PointCloud2, <span style="color:#e6db74">&#39;cluster&#39;</span>, <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><ul>
<li>subscription callback에서 대부분의 로직이 구현되어 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">pcl_callback</span>(self, pcl_msg):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># TODO: Convert ROS msg to PCL data</span>
</span></span><span style="display:flex;"><span>        pcl_data <span style="color:#f92672">=</span> ros2_to_pcl(pcl_msg)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">#Create new cloud containing all clusters, each with unique color</span>
</span></span><span style="display:flex;"><span>        cluster_cloud <span style="color:#f92672">=</span> pcl<span style="color:#f92672">.</span>PointCloud_PointXYZRGB()
</span></span><span style="display:flex;"><span>        cluster_cloud<span style="color:#f92672">.</span>from_list(color_cluster_point_list)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span></code></pre></div><ul>
<li>callback의 마지막에 pcl_to_ros2를 통해 전체 cluster를 PointCloud2 타입으로 변환한 뒤 publish합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#75715e"># Convert PCL data to ROS 2 messages</span>
</span></span><span style="display:flex;"><span>    cluster_cloud_msg <span style="color:#f92672">=</span> pcl_to_ros2(cluster_cloud, now<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>get_clock()<span style="color:#f92672">.</span>now())
</span></span><span style="display:flex;"><span>    self<span style="color:#f92672">.</span>cluster_publisher<span style="color:#f92672">.</span>publish(cluster_cloud_msg)
</span></span></code></pre></div>

<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/kr/ros2_foxy/lecture12/" title="Lecture12. About Gazebo - 2"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/kr/ros2_foxy/lecture14/" title="Lecture14. Useful ROS 2 Examples (Control Part)" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1684950311"></script>
    <script src="/js/perfect-scrollbar.min.js?1684950311"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1684950311"></script>
    <script src="/js/jquery.sticky.js?1684950311"></script>
    <script src="/js/featherlight.min.js?1684950311"></script>
    <script src="/js/highlight.pack.js?1684950311"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1684950311"></script>
    <script src="/js/learn.js?1684950311"></script>
    <script src="/js/hugo-learn.js?1684950311"></script>
    
        
            <script src="https://unpkg.com/mermaid@8.8.0/dist/mermaid.min.js"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

