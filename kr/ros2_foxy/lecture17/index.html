<!DOCTYPE html>
<html lang="kr" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.104.1" />
    <meta name="description" content="COM2018 OOP Class Lecture Note">
<meta name="author" content="Soo Young Kim">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Lecture17. Real Hardware Examples - Documentation for Hugo Learn Theme</title>

    
    <link href="/css/nucleus.css?1685267036" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1685267036" rel="stylesheet">
    <link href="/css/hybrid.css?1685267036" rel="stylesheet">
    <link href="/css/featherlight.min.css?1685267036" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1685267036" rel="stylesheet">
    <link href="/css/auto-complete.css?1685267036" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1685267036" rel="stylesheet">
    <link href="/css/theme.css?1685267036" rel="stylesheet">
    <link href="/css/tabs.css?1685267036" rel="stylesheet">
    <link href="/css/hugo-theme.css?1685267036" rel="stylesheet">
    
    <link href="/css/theme-green.css?1685267036" rel="stylesheet">
    
    <link href="/css/foo.css?1685267036" rel="stylesheet"><link href="/css/bar.css?1685267036" rel="stylesheet">

    <script src="/js/jquery-3.3.1.min.js?1685267036"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/kr/ros2_foxy/lecture17/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <img width="1097" alt="image" src="https://user-images.githubusercontent.com/12381733/209764275-05dcbdbf-cef7-47ad-94a6-6d61febad01e.png">
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1685267036"></script>
<script type="text/javascript" src="/js/auto-complete.js?1685267036"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/kr";
    
</script>
<script type="text/javascript" src="/js/search.js?1685267036"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/kr'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/kr/ros_basic_noetic/" title="ROS Basics" class="dd-item
        
        
        
        ">
      <a href="/kr/ros_basic_noetic/">
          <b>ROS Noetic. </b>ROS Basics
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture1/" title="Lecture1 - Introduction to ROS" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture1/">
        Lecture1 - Introduction to ROS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture2/" title="Lecture2 - Dev Env Setup" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture2/">
        Lecture2 - Dev Env Setup
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture3/" title="Lecture3 - Core of ROS" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture3/">
        Lecture3 - Core of ROS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture4/" title="Lecture4 - ROS Launch, RViz" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture4/">
        Lecture4 - ROS Launch, RViz
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture5/" title="Lecture5 - First Programming, ROS Topic" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture5/">
        Lecture5 - First Programming, ROS Topic
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture6/" title="Lecture6 - ROS Service, Parameter" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture6/">
        Lecture6 - ROS Service, Parameter
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture7/" title="Lecture7 - Rqt Tools and rosbag, ROS Time" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture7/">
        Lecture7 - Rqt Tools and rosbag, ROS Time
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture8/" title="Lecture8 - Deal with Open Source Projects, Custom Interfaces" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture8/">
        Lecture8 - Deal with Open Source Projects, Custom Interfaces
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture9/" title="Lecture9 - ROS TF and Examples" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture9/">
        Lecture9 - ROS TF and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_basic_noetic/lecture10/" title="Lecture10 - TF2 Examples, Outro" class="dd-item ">
        <a href="/kr/ros_basic_noetic/lecture10/">
        Lecture10 - TF2 Examples, Outro
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/advanced_contents_ros1/" title="ROS" class="dd-item
        
        
        
        ">
      <a href="/kr/advanced_contents_ros1/">
          <b>Advanced Contents. </b>ROS
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros1/lecture1/" title="Lecture1 - ROSCPP" class="dd-item ">
        <a href="/kr/advanced_contents_ros1/lecture1/">
        Lecture1 - ROSCPP
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros1/lecture2/" title="Lecture2 - More About ROS System" class="dd-item ">
        <a href="/kr/advanced_contents_ros1/lecture2/">
        Lecture2 - More About ROS System
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros1/lecture3/" title="Lecture3 - SROS" class="dd-item ">
        <a href="/kr/advanced_contents_ros1/lecture3/">
        Lecture3 - SROS
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/ros2_basic_foxy/" title="ROS 2 Basics" class="dd-item
        
        
        
        ">
      <a href="/kr/ros2_basic_foxy/">
          <b>[Old]ROS 2 Foxy. </b>ROS 2 Basics
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture1/" title="Lecture1 - Introduction to ROS 2" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture1/">
        Lecture1 - Introduction to ROS 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture2/" title="Lecture2 - ROS 2 Node, Package" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture2/">
        Lecture2 - ROS 2 Node, Package
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture3/" title="Lecture3 - ROS 2 Node Programming, ROS 2 parameter" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture3/">
        Lecture3 - ROS 2 Node Programming, ROS 2 parameter
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture4/" title="Lecture4 - ROS 2 Node C&#43;&#43; Programming" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture4/">
        Lecture4 - ROS 2 Node C&#43;&#43; Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture5/" title="Lecture5 - ROS 2 Topic and Examples" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture5/">
        Lecture5 - ROS 2 Topic and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture6/" title="Lecture6 - ROS 2 Service and Examples" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture6/">
        Lecture6 - ROS 2 Service and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture7/" title="Lecture7 - Useful ROS 2 Example, Navigation2" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture7/">
        Lecture7 - Useful ROS 2 Example, Navigation2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture8/" title="Lecture8 - ROS 2 Action and Examples" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture8/">
        Lecture8 - ROS 2 Action and Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_basic_foxy/lecture9/" title="Lecture9 - C&#43;&#43; Programming Again, Outro" class="dd-item ">
        <a href="/kr/ros2_basic_foxy/lecture9/">
        Lecture9 - C&#43;&#43; Programming Again, Outro
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/ros2_foxy/" title="ROS 2 Basics" class="dd-item
        parent
        
        
        ">
      <a href="/kr/ros2_foxy/">
          <b>[New]ROS 2 Foxy. </b>ROS 2 Basics
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture1/" title="Lecture1. What is ROS?" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture1/">
        Lecture1. What is ROS?
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture2/" title="Lecture2. Dev Env Setup" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture2/">
        Lecture2. Dev Env Setup
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture3/" title="Lecture3. Core of ROS" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture3/">
        Lecture3. Core of ROS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture4/" title="Lecture4. ROS 2 Node and Parameter Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture4/">
        Lecture4. ROS 2 Node and Parameter Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture5/" title="Lecture5. ROS 2 Communication Mechanisms" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture5/">
        Lecture5. ROS 2 Communication Mechanisms
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture6/" title="Lecture6. ROS 2 Tools" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture6/">
        Lecture6. ROS 2 Tools
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture7/" title="Lecture7. ROS 2 Topic and Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture7/">
        Lecture7. ROS 2 Topic and Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture8/" title="Lecture8. ROS 2 Service and Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture8/">
        Lecture8. ROS 2 Service and Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture9/" title="Lecture9. ROS 2 Action Programming" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture9/">
        Lecture9. ROS 2 Action Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture10/" title="Lecture10. TF and ROS 2" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture10/">
        Lecture10. TF and ROS 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture11/" title="Lecture11. About Gazebo - 1" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture11/">
        Lecture11. About Gazebo - 1
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture12/" title="Lecture12. About Gazebo - 2" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture12/">
        Lecture12. About Gazebo - 2
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture13/" title="Lecture13. Useful ROS 2 Examples (Sensor Part)" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture13/">
        Lecture13. Useful ROS 2 Examples (Sensor Part)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture14/" title="Lecture14. Useful ROS 2 Examples (Control Part)" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture14/">
        Lecture14. Useful ROS 2 Examples (Control Part)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture15/" title="Lecture15. Advanced ROS 2, Package Management" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture15/">
        Lecture15. Advanced ROS 2, Package Management
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture16/" title="Lecture16. Useful ROS 2 Examples (Misc)" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture16/">
        Lecture16. Useful ROS 2 Examples (Misc)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture17/" title="Lecture17. Real Hardware Examples" class="dd-item active">
        <a href="/kr/ros2_foxy/lecture17/">
        Lecture17. Real Hardware Examples
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture18/" title="Lecture18. Point Cloud Deep Learning Example (PointNet)" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture18/">
        Lecture18. Point Cloud Deep Learning Example (PointNet)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture19/" title="Lecture19. Orbbec ROS 2 Package - Final" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture19/">
        Lecture19. Orbbec ROS 2 Package - Final
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros2_foxy/lecture20/" title="Lecture20. NVIDIA Jetson Platform" class="dd-item ">
        <a href="/kr/ros2_foxy/lecture20/">
        Lecture20. NVIDIA Jetson Platform
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/advanced_contents_ros2/" title="ROS 2" class="dd-item
        
        
        
        ">
      <a href="/kr/advanced_contents_ros2/">
          <b>Advanced Contents. </b>ROS 2
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros2/lecture1/" title="Lecture1 - About DDS" class="dd-item ">
        <a href="/kr/advanced_contents_ros2/lecture1/">
        Lecture1 - About DDS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros2/lecture2/" title="Lecture11 - About DDS (2)" class="dd-item ">
        <a href="/kr/advanced_contents_ros2/lecture2/">
        Lecture11 - About DDS (2)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/advanced_contents_ros2/lecture3/" title="Lecture12 - SROS2" class="dd-item ">
        <a href="/kr/advanced_contents_ros2/lecture3/">
        Lecture12 - SROS2
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/kr/ros_and_gazebo/" title="Gazebo and ROS" class="dd-item
        
        
        
        ">
      <a href="/kr/ros_and_gazebo/">
          <b>Gazebo. </b>Gazebo and ROS
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_and_gazebo/lecture1/" title="Lecture1 - Gazebo and Robot" class="dd-item ">
        <a href="/kr/ros_and_gazebo/lecture1/">
        Lecture1 - Gazebo and Robot
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/kr/ros_and_gazebo/lecture2/" title="Lecture2 - Gazebo and Robot(2)" class="dd-item ">
        <a href="/kr/ros_and_gazebo/lecture2/">
        Lecture2 - Gazebo and Robot(2)
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://github.com/RB2023ROS/du2023-ros1"><i class='fab fa-fw fa-github'></i> GitHub repo - ROS 1</a>
              </li>
          
              <li>
                  <a class="padding" href="https://github.com/RB2023ROS/du2023-ros2"><i class='fab fa-fw fa-github'></i> GitHub repo - ROS 2</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="kr" value="/kr/ros2_foxy/lecture17/" selected>Korean</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      

      
      </ul>
    </section>
    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='' href="https://github.com/com2018-fa22/hugo-blog/tree/main/content/ros2_foxy/lecture17.kr.md" target="blank">
                      <i class="fas fa-code-branch"></i>
                      <span id="top-github-link-text"></span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   Lecture17. Real Hardware Examples
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#intel-realsense2-camera-ros-2">Intel realsense2 camera ROS 2</a>
      <ul>
        <li><a href="#composition-launch">Composition launch</a></li>
        <li><a href="#realsense2-launch-file-분석">realsense2 Launch file 분석</a></li>
        <li><a href="#코드-분석">코드 분석</a></li>
        <li><a href="#publish-분석">Publish 분석</a></li>
        <li><a href="#rs_intra_process_demo_launchpy">rs_intra_process_demo_launch.py</a></li>
        <li><a href="#rs_multi_camera_launchpy">rs_multi_camera_launch.py</a></li>
      </ul>
    </li>
    <li><a href="#realsense2-description">realsense2 Description</a>
      <ul>
        <li><a href="#description-launch-file-분석">Description Launch file 분석</a></li>
        <li><a href="#custom-message">Custom Message</a></li>
      </ul>
    </li>
    <li><a href="#velodyne-lidar-ros-2-실행">velodyne Lidar ROS 2 실행</a>
      <ul>
        <li><a href="#launch-file-분석">Launch file 분석</a></li>
        <li><a href="#velodyne_driver_node">velodyne_driver_node</a></li>
        <li><a href="#velodyne_convert_node">velodyne_convert_node</a></li>
        <li><a href="#velodyne_laserscan_node">velodyne_laserscan_node</a></li>
        <li><a href="#velodyne_msgs">velodyne_msgs</a></li>
      </ul>
    </li>
    <li><a href="#orbbec-astra-camera-ros-2-패키지-분석">orbbec astra camera ROS 2 패키지 분석</a>
      <ul>
        <li><a href="#개발환경-설정">개발환경 설정</a></li>
        <li><a href="#getting-started">Getting started</a></li>
        <li><a href="#코드-분석-1">코드 분석</a></li>
      </ul>
    </li>
    <li><a href="#orbbec-gemini-2-ros-2-패키지-분석">orbbec gemini 2 ROS 2 패키지 분석</a>
      <ul>
        <li><a href="#코드-분석-2">코드 분석</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Lecture17. Real Hardware Examples
            </h1>
          

        


<blockquote>
<p>이번 시간에는 실제 센서 하드웨어를 실행하는 ROS 2 package들을 실행해보고, 코드 분석을 진행해보려합니다. 준비된 예시들은 다음과 같습니다.</p>
</blockquote>
<ul>
<li>Intel Realsense2 D455 Camera</li>
<li>Velodyne VLP16 3D lidar</li>
<li>Orbbec Astra+ Camera</li>
</ul>
<h2 id="intel-realsense2-camera-ros-2">Intel realsense2 camera ROS 2</h2>
<p>real hardware 강의의 두번째 시간으로 Intel의 realsense2 카메라 패키지를 실행하고, 분석해 보겠습니다.</p>
<p><img src="/kr/ros2_foxy/images17/Untitled.png?height=300px" alt="Untitled.png"></p>
<ul>
<li>예제 실행을 위해 필요한 종속성들을 설치하고 realsense sdk인 librealsense를 설치합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get update <span style="color:#f92672">&amp;&amp;</span> sudo apt-get upgrade
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Register the server&#39;s public key</span>
</span></span><span style="display:flex;"><span>sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE <span style="color:#f92672">||</span> sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE
</span></span><span style="display:flex;"><span>&gt; gpg: Total number processed: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add the server to the list of repositories</span>
</span></span><span style="display:flex;"><span>sudo add-apt-repository <span style="color:#e6db74">&#34;deb https://librealsense.intel.com/Debian/apt-repo </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> main&#34;</span> -u
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install the libraries (see section below if upgrading packages)</span>
</span></span><span style="display:flex;"><span>sudo apt-get install librealsense2-dkms -y
</span></span><span style="display:flex;"><span>sudo apt-get install librealsense2-utils -y
</span></span></code></pre></div><ul>
<li>실제 카메라 연결을 통해 realsense2 패키지 설치를 검증해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Reconnect the Intel RealSense depth camera and run</span>
</span></span><span style="display:flex;"><span>realsense-viewer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>modinfo uvcvideo | grep <span style="color:#e6db74">&#34;version:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># should include realsense string</span>
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images17/Untitled1.png?height=350px" alt="Untitled1.png"></p>
<p>⇒ 위와 같은 이미지 출력을 얻었다면 성공입니다.</p>
<ul>
<li>사실, realsense camera는 intel이 개발한 만큼 ubuntu 배포판 패키지로 ros2를 지원하고 있습니다. 사용만 하고 싶다면 아래와 같이 손쉽게 설치가 가능합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Install Dependencies</span>
</span></span><span style="display:flex;"><span>sudo apt-get install ros-foxy-cv-bridge ros-foxy-librealsense2 ros-foxy-message-filters ros-foxy-image-transport -y
</span></span><span style="display:flex;"><span>sudo apt install ros-foxy-diagnostic-updater -y
</span></span><span style="display:flex;"><span>sudo apt-get install -y libssl-dev libusb-1.0-0-dev pkg-config libgtk-3-dev
</span></span><span style="display:flex;"><span>sudo apt-get install -y libglfw3-dev libgl1-mesa-dev libglu1-mesa-dev
</span></span></code></pre></div><p>⇒ 하지만 우리는 패키지 분석이 목적이므로 직접 소스코드 빌드와 분석을 해보겠습니다. 아래 링크를 통해 release version을 다운받고 ros2 workspace에 압축을 해제합니다.</p>
<p><a href="https://github.com/IntelRealSense/realsense-ros/releases">https://github.com/IntelRealSense/realsense-ros/releases</a></p>
<p><img src="/kr/ros2_foxy/images17/Untitled2.png?height=200px" alt="Untitled2.png"></p>
<ul>
<li>폴더 이동 후 빌드는 아래 순서대로 해주세요!</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cbp realsense2_camera_msgs <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span><span style="display:flex;"><span>cbp realsense2_description <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span><span style="display:flex;"><span>cbp realsense2_camera <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span></code></pre></div><ul>
<li>우선 빌드가 잘 되었는지 예시부터 실행해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ros2 launch realsense2_camera rs_launch.py
</span></span></code></pre></div><ul>
<li>topic list, rviz2를 통해 정상 동작을 확인합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ros2 topic list
</span></span><span style="display:flex;"><span>/camera/color/camera_info
</span></span><span style="display:flex;"><span>/camera/color/image_raw
</span></span><span style="display:flex;"><span>/camera/color/metadata
</span></span><span style="display:flex;"><span>/camera/depth/camera_info
</span></span><span style="display:flex;"><span>/camera/depth/image_rect_raw
</span></span><span style="display:flex;"><span>/camera/depth/metadata
</span></span><span style="display:flex;"><span>/camera/extrinsics/depth_to_color
</span></span><span style="display:flex;"><span>/camera/extrinsics/depth_to_depth
</span></span><span style="display:flex;"><span>/camera/imu
</span></span><span style="display:flex;"><span>/parameter_events
</span></span><span style="display:flex;"><span>/rosout
</span></span><span style="display:flex;"><span>/tf_static
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images17/Untitled3.png?height=300px" alt="Untitled3.png"></p>
<ul>
<li>point cloud topic을 활성화하기 위해선 아래와 같은 launch가 필요합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ros2 launch realsense2_camera rs_launch.py pointcloud.enable:<span style="color:#f92672">=</span>true
</span></span></code></pre></div><ul>
<li>rviz2를 통해 pointcloud를 시각화해봅시다. (메가커피에서 강의를 제작해서 손흥민 선수 얼굴이 보이네요 ㅎㅎ)</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled4.png?height=350px" alt="Untitled4.png"></p>
<ul>
<li>rviz2에서 tf2 data도 확인할 수 있습니다. fixed frame은 camera_link로 두시면 됩니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled5.png?height=300px" alt="Untitled5.png"></p>
<ul>
<li>tf2 tree도 확인해봅시다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled6.png?height=300px" alt="Untitled6.png"></p>
<h3 id="composition-launch">Composition launch</h3>
<blockquote>
<p>realsense ros2 package는 Intra-communication을 사용하여 메모리 최적화를 적용한 composition launch도 지원하고 있습니다. 이를 사용하기 위해서는 패키지 빌드를 다시 해야 하며, 이러한 이유로 저는 realsense_ws라는 별도의 workspace를 만들었습니다.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ~/
</span></span><span style="display:flex;"><span>mkdir -p realsense_ws/src
</span></span><span style="display:flex;"><span>cd realsense_ws
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># locate packages &amp; build again</span>
</span></span><span style="display:flex;"><span>colcon build --cmake-args <span style="color:#e6db74">&#39;-DBUILD_TOOLS=ON&#39;</span>
</span></span></code></pre></div><ul>
<li>Composition 예시를 실행해봅시다!</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ros2 launch realsense2_camera rs_intra_process_demo_launch.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508794.621382739<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0597926 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508794.689360200<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0610729 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508794.755558725<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0605604 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508794.822757399<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0610629 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508794.889473916<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0610784 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508794.955772739<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0606767 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508795.022029595<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0602304 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508795.088818104<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0603308 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508795.156870084<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>: Got msg with address 0x7fe51c6cb570 with latency of 0.0616579 <span style="color:#f92672">[</span>sec<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682508795.223072425<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>frame_latency<span style="color:#f92672">]</span>:
</span></span></code></pre></div><ul>
<li>rqt_image_view를 통해 이미지도 확인해 보겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ros2 run rqt_image_view rqt_image_view
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images17/Untitled7.png?height=300px" alt="Untitled7.png"></p>
<ul>
<li>실제 일반 node 실행과 composition 사용 시 점유하는 메모리를 비교해 보았습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PID   USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2530</span> kimsooy+  <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">897252</span>  <span style="color:#ae81ff">82312</span>  <span style="color:#ae81ff">50300</span> R  12.3   0.5   1:09.80 x-terminal-emul
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1247</span> kimsooy+  <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">6284836</span> <span style="color:#ae81ff">344712</span> <span style="color:#ae81ff">109988</span> S  11.3   2.1   7:17.14 gnome-shell
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">41892</span> kimsooy+  <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1183960</span>  <span style="color:#ae81ff">85788</span>  <span style="color:#ae81ff">57140</span> S   5.3   0.5   0:03.28 component_conta
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PID   USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">1247</span> kimsooy+  <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">6333092</span> <span style="color:#ae81ff">344816</span> <span style="color:#ae81ff">109988</span> S  11.6   2.1   8:00.07 gnome-shell
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">2530</span> kimsooy+  <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">897252</span>  <span style="color:#ae81ff">82664</span>  <span style="color:#ae81ff">50300</span> S  10.9   0.5   1:33.14 x-terminal-emul
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">42240</span> kimsooy+  <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1457552</span>  <span style="color:#ae81ff">92104</span>  <span style="color:#ae81ff">57096</span> S   8.9   0.6   0:03.88 realsense2_came
</span></span></code></pre></div>
<div class="notices note" ><p>노트북 환경이어 겉보기에 큰 차이는 없지만, 실제 edge device에서 실행 + 다중 Node들이 결합되는 경우 Composition 사용 여부가 큰 차이를 가질 것입니다.</p>
</div>

<h3 id="realsense2-launch-file-분석">realsense2 Launch file 분석</h3>
<blockquote>
<p>launch file과 소스코드 일부 분석을 통해 센서 패키지 개발의 흐름을 이해해봅시다.</p>
</blockquote>
<ul>
<li>rs_launch.py의 시작은 수많은 launch configuration들로 시작됩니다. (<code>DeclareLaunchArgument</code>, <code>LaunchConfiguration을</code> 별도의 함수로 구현해 두고 재사용하고 있습니다.)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>configurable_parameters <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;camera_name&#39;</span>,                  <span style="color:#e6db74">&#39;default&#39;</span>: <span style="color:#e6db74">&#39;camera&#39;</span>, <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;camera unique name&#39;</span>},
</span></span><span style="display:flex;"><span>                           {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;serial_no&#39;</span>,                    <span style="color:#e6db74">&#39;default&#39;</span>: <span style="color:#e6db74">&#34;&#39;&#39;&#34;</span>, <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;choose device by serial number&#39;</span>},
</span></span><span style="display:flex;"><span>                           {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;usb_port_id&#39;</span>,                  <span style="color:#e6db74">&#39;default&#39;</span>: <span style="color:#e6db74">&#34;&#39;&#39;&#34;</span>, <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;choose device by usb port id&#39;</span>},
</span></span><span style="display:flex;"><span>                           {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;device_type&#39;</span>,                  <span style="color:#e6db74">&#39;default&#39;</span>: <span style="color:#e6db74">&#34;&#39;&#39;&#34;</span>, <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;choose device by type&#39;</span>},
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">declare_configurable_parameters</span>(parameters):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [DeclareLaunchArgument(param[<span style="color:#e6db74">&#39;name&#39;</span>], default_value<span style="color:#f92672">=</span>param[<span style="color:#e6db74">&#39;default&#39;</span>], description<span style="color:#f92672">=</span>param[<span style="color:#e6db74">&#39;description&#39;</span>]) <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> parameters]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_configurable_parameters</span>(parameters):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> dict([(param[<span style="color:#e6db74">&#39;name&#39;</span>], LaunchConfiguration(param[<span style="color:#e6db74">&#39;name&#39;</span>])) <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> parameters])
</span></span></code></pre></div><ul>
<li>ROS 2 dashing, eloquent, foxy / 별도 user config file이 있는지 등 각종 조건에 따른 조건 분리도 설정해 두었습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_launch_description</span>():
</span></span><span style="display:flex;"><span>    log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;info&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;ROS_DISTRO&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;dashing&#34;</span>) <span style="color:#f92672">or</span> (os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;ROS_DISTRO&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;eloquent&#34;</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> LaunchDescription(declare_configurable_parameters(configurable_parameters) <span style="color:#f92672">+</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Realsense</span>
</span></span><span style="display:flex;"><span>        launch_ros<span style="color:#f92672">.</span>actions<span style="color:#f92672">.</span>Node(
</span></span><span style="display:flex;"><span>            condition<span style="color:#f92672">=</span>IfCondition(PythonExpression([LaunchConfiguration(<span style="color:#e6db74">&#39;config_file&#39;</span>), <span style="color:#e6db74">&#34; == &#39;&#39;&#34;</span>])),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        launch_ros<span style="color:#f92672">.</span>actions<span style="color:#f92672">.</span>Node(
</span></span><span style="display:flex;"><span>            condition<span style="color:#f92672">=</span>IfCondition(PythonExpression([LaunchConfiguration(<span style="color:#e6db74">&#39;config_file&#39;</span>), <span style="color:#e6db74">&#34; != &#39;&#39;&#34;</span>])),
</span></span></code></pre></div><ul>
<li>실제 실행되는 것은 realsense2_camera_node이며, 다음으로 이 node에 대해서 파헤쳐보겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>launch_ros<span style="color:#f92672">.</span>actions<span style="color:#f92672">.</span>Node(
</span></span><span style="display:flex;"><span>	package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;realsense2_camera&#39;</span>,
</span></span><span style="display:flex;"><span>	namespace<span style="color:#f92672">=</span>LaunchConfiguration(<span style="color:#e6db74">&#34;camera_name&#34;</span>),
</span></span><span style="display:flex;"><span>	name<span style="color:#f92672">=</span>LaunchConfiguration(<span style="color:#e6db74">&#34;camera_name&#34;</span>),
</span></span><span style="display:flex;"><span>	executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;realsense2_camera_node&#39;</span>,
</span></span><span style="display:flex;"><span>	parameters<span style="color:#f92672">=</span>[set_configurable_parameters(configurable_parameters)
</span></span><span style="display:flex;"><span>	            , PythonExpression([LaunchConfiguration(<span style="color:#e6db74">&#34;config_file&#34;</span>)])
</span></span><span style="display:flex;"><span>	            ],
</span></span><span style="display:flex;"><span>	output<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;screen&#39;</span>,
</span></span><span style="display:flex;"><span>	arguments<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;--ros-args&#39;</span>, <span style="color:#e6db74">&#39;--log-level&#39;</span>, LaunchConfiguration(<span style="color:#e6db74">&#39;log_level&#39;</span>)],
</span></span><span style="display:flex;"><span>	emulate_tty<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h3 id="코드-분석">코드 분석</h3>
<ul>
<li><code>CMakeLists.txt</code>를 살펴보면 realsense2_camera_node이 어떻게 빌드된 결과물인지 확인할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>rclcpp_components_register_node(<span style="color:#960050;background-color:#1e0010">$</span>{PROJECT_NAME}
</span></span><span style="display:flex;"><span>  PLUGIN <span style="color:#e6db74">&#34;realsense2_camera::RealSenseNodeFactory&#34;</span>
</span></span><span style="display:flex;"><span>  EXECUTABLE realsense2_camera_node
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div>
<div class="notices tip" ><p>그런데, 일반적으로 executable을 빌드하는 방식이 아닌 rclcpp_components_register_node라는 옵션을 사용하고 있습니다. rclcpp_components_register_node은 라이브러리, 실행 파일을 모두 생성할 수 있는 rclcpp의 CMake tools입니다.
<a href="https://docs.ros2.org/latest/api/rclcpp_components/">https://docs.ros2.org/latest/api/rclcpp_components/</a></p>
</div>


<div class="notices note" ><p>realsense2 ROS 2 package는 ROS 1 때부터의 레거시가 잔존하고 구조상으로 깔끔하다고 말하기는 어려운 코드입니다. 분석은 하겠지만 이러한 형태가 일반적이라고 할 수 없음을 인지하시기 바랍니다! (저라면 싹다 처음부터 짤 것 같습니다.)</p>
</div>

<ul>
<li>realsense2_camera_node를 구성하는 composition인 RealSenseNodeFactory는 realsense_node_factory.h에 구현되어 있습니다. 디자인 패턴을 따랐다고 말할 수는 없지만, 일종의 팩토리이며 _realSenseNode가 Node에 해당합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> realsense2_camera
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RealSenseNodeFactory</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> rclcpp<span style="color:#f92672">::</span>Node
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">explicit</span> RealSenseNodeFactory(<span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>NodeOptions <span style="color:#f92672">&amp;</span> node_options <span style="color:#f92672">=</span> rclcpp<span style="color:#f92672">::</span>NodeOptions());
</span></span><span style="display:flex;"><span>        RealSenseNodeFactory(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string <span style="color:#f92672">&amp;</span> node_name, <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string <span style="color:#f92672">&amp;</span> ns,
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>NodeOptions <span style="color:#f92672">&amp;</span> node_options <span style="color:#f92672">=</span> rclcpp<span style="color:#f92672">::</span>NodeOptions());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>RealSenseNodeFactory();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> init();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">closeDevice</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDevice</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">changeDeviceCallback</span>(rs2<span style="color:#f92672">::</span>event_information<span style="color:#f92672">&amp;</span> info);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getDevice</span>(rs2<span style="color:#f92672">::</span>device_list list);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tryGetLogSeverity</span>(rs2_log_severity<span style="color:#f92672">&amp;</span> severity) <span style="color:#66d9ef">const</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> std<span style="color:#f92672">::</span>string parseUsbPort(std<span style="color:#f92672">::</span>string line);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        rclcpp<span style="color:#f92672">::</span>Node<span style="color:#f92672">::</span>SharedPtr _node;
</span></span><span style="display:flex;"><span>        rs2<span style="color:#f92672">::</span>device _device;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BaseRealSenseNode<span style="color:#f92672">&gt;</span> _realSenseNode;
</span></span><span style="display:flex;"><span>        rs2<span style="color:#f92672">::</span>context _ctx;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>string _serial_no;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>string _usb_port_id;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>string _device_type;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">double</span> _wait_for_device_timeout;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">double</span> _reconnect_timeout;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bool</span> _initial_reset;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> _query_thread;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">bool</span> _is_alive;
</span></span><span style="display:flex;"><span>        rclcpp<span style="color:#f92672">::</span>Logger _logger;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>Parameters<span style="color:#f92672">&gt;</span> _parameters;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}<span style="color:#75715e">//end namespace
</span></span></span></code></pre></div><blockquote>
<p>우선 여기서 몇가지 주요 함수들을 분석하고 더 깊이 들어가보겠습니다.</p>
</blockquote>
<ul>
<li>realsense_node_factory.cpp - startDevice()</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> RealSenseNodeFactory<span style="color:#f92672">::</span>startDevice()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_realSenseNode) _realSenseNode.reset();
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string pid_str(_device.get_info(RS2_CAMERA_INFO_PRODUCT_ID));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> pid <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>stoi(pid_str, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span>(pid)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> SR300_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> SR300v2_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS400_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS405_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS410_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS460_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS415_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS420_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS420_MM_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS430_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS430_MM_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS430_MM_RGB_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS435_RGB_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS435i_RGB_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS455_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS465_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS_USB2_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS_L515_PID_PRE_PRQ:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS_L515_PID:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS_L535_PID:
</span></span><span style="display:flex;"><span>            _realSenseNode <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BaseRealSenseNode<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">new</span> BaseRealSenseNode(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>, _device, _parameters, <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>get_node_options().use_intra_process_comms()));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> RS_T265_PID:
</span></span><span style="display:flex;"><span>            _realSenseNode <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>T265RealsenseNode<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">new</span> T265RealsenseNode(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>, _device, _parameters, <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>get_node_options().use_intra_process_comms()));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            ROS_FATAL_STREAM(<span style="color:#e6db74">&#34;Unsupported device!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; Product ID: 0x&#34;</span> <span style="color:#f92672">&lt;&lt;</span> pid_str);
</span></span><span style="display:flex;"><span>            rclcpp<span style="color:#f92672">::</span>shutdown();
</span></span><span style="display:flex;"><span>            exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _realSenseNode<span style="color:#f92672">-&gt;</span>publishTopics();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span>(<span style="color:#66d9ef">const</span> rs2<span style="color:#f92672">::</span>backend_error<span style="color:#f92672">&amp;</span> e)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Failed to start device: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> e.what() <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
</span></span><span style="display:flex;"><span>        _device.hardware_reset();
</span></span><span style="display:flex;"><span>        _device <span style="color:#f92672">=</span> rs2<span style="color:#f92672">::</span>device();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>main Node인 _realSenseNode를 정의하고 있으며, 이는 사용하는 카메라 모델에 따라 차이를 갖습니다.</p>
</blockquote>
<ul>
<li>_realSenseNode를 생성한 이후, publishTopics 메소드가 호출됩니다. <code>base_realsense_node.cpp - publishTopics()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BaseRealSenseNode<span style="color:#f92672">::</span>publishTopics()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    getParameters();
</span></span><span style="display:flex;"><span>    setup();
</span></span><span style="display:flex;"><span>    ROS_INFO_STREAM(<span style="color:#e6db74">&#34;RealSense Node Is Up!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>⇒ getParameters()에서는 말 그대로 각종 ROS 2 매개변수들의 파싱이 이루어집니다.</p>
<ul>
<li>setup() 메소드에서 주요 기능들이 실행되며 여기로 한단계 더 진입해보겠습니다. <code>BaseRealSenseNode::setup()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BaseRealSenseNode<span style="color:#f92672">::</span>setup()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    setDynamicParams();
</span></span><span style="display:flex;"><span>    startDiagnosticsUpdater();
</span></span><span style="display:flex;"><span>    setAvailableSensors();
</span></span><span style="display:flex;"><span>    SetBaseStream();
</span></span><span style="display:flex;"><span>    setupFilters();
</span></span><span style="display:flex;"><span>    setupFiltersPublishers();
</span></span><span style="display:flex;"><span>    setCallbackFunctions();
</span></span><span style="display:flex;"><span>    monitoringProfileChanges();
</span></span><span style="display:flex;"><span>    updateSensors();
</span></span><span style="display:flex;"><span>    publishServices();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
<div class="notices note" ><p>이렇게 복잡한 구조를 갖게 된 까닭은 유추하건데 ROS 1의 레거시에서 시작했기 때문일겁니다. ⇒ ROS 1 코드에서 주요 기능들을 모두 모듈화하고 ROS 2에서는 setup()이라는 이름으로 모조리 때려넣은 것이지요. 다시 말하지만, 구조적으로 잘 구현된 코드는 아닙니다.</p>
</div>

<blockquote>
<p>위 함수들 대부분은 이름을 통해 기능을 유추할 수 있으며 중요한 함수들만 몇가지 파헤쳐보겠습니다.</p>
</blockquote>
<ul>
<li>setAvailableSensors</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>(rs2<span style="color:#f92672">::</span>frame)<span style="color:#f92672">&gt;</span> frame_callback_function <span style="color:#f92672">=</span> [<span style="color:#66d9ef">this</span>](rs2<span style="color:#f92672">::</span>frame frame){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">is_filter</span>(_filters.end() <span style="color:#f92672">!=</span> find_if(_filters.begin(), _filters.end(), [](std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>NamedFilter<span style="color:#f92672">&gt;</span> f){<span style="color:#66d9ef">return</span> (f<span style="color:#f92672">-&gt;</span>is_enabled()); }));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_sync_frames <span style="color:#f92672">||</span> is_filter)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>_asyncer.invoke(frame);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">frame_callback</span>(frame);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>(rs2<span style="color:#f92672">::</span>frame)<span style="color:#f92672">&gt;</span> imu_callback_function <span style="color:#f92672">=</span> [<span style="color:#66d9ef">this</span>](rs2<span style="color:#f92672">::</span>frame frame){
</span></span><span style="display:flex;"><span>    imu_callback(frame);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_imu_sync_method <span style="color:#f92672">!=</span> imu_sync_method<span style="color:#f92672">::</span>NONE)
</span></span><span style="display:flex;"><span>        imu_callback_sync(frame);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>(rs2<span style="color:#f92672">::</span>frame)<span style="color:#f92672">&gt;</span> multiple_message_callback_function <span style="color:#f92672">=</span> [<span style="color:#66d9ef">this</span>](rs2<span style="color:#f92672">::</span>frame frame){multiple_message_callback(frame, _imu_sync_method);};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span>()<span style="color:#f92672">&gt;</span> update_sensor_func <span style="color:#f92672">=</span> [<span style="color:#66d9ef">this</span>](){
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>lock_guard<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock_guard(_profile_changes_mutex);
</span></span><span style="display:flex;"><span>        _is_profile_changed <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    _cv_mpc.notify_one();
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><blockquote>
<p>각종 callback들이 구현됩니다. 현재 callback안에서 다시 callback이 실행되기도 하고, lock guard가 호출되고도 있지만, 결국 해당 callback들이 subscriber, service server의 callback으로 사용됩니다.</p>
</blockquote>
<ul>
<li>더불어, setAvailableSensors에서 librealsense와, ROS 2의 연동이 동작합니다. 이를 RosSensor라는 패턴으로 구현하여 앞서 구현한 callback들과 binding합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;&amp;</span> sensor : _dev_sensors)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string module_name(sensor.get_info(RS2_CAMERA_INFO_NAME));
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>RosSensor<span style="color:#f92672">&gt;</span> rosSensor;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sensor.is<span style="color:#f92672">&lt;</span>rs2<span style="color:#f92672">::</span>depth_sensor<span style="color:#f92672">&gt;</span>() <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        sensor.is<span style="color:#f92672">&lt;</span>rs2<span style="color:#f92672">::</span>color_sensor<span style="color:#f92672">&gt;</span>() <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        sensor.is<span style="color:#f92672">&lt;</span>rs2<span style="color:#f92672">::</span>fisheye_sensor<span style="color:#f92672">&gt;</span>())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ROS_DEBUG_STREAM(<span style="color:#e6db74">&#34;Set &#34;</span> <span style="color:#f92672">&lt;&lt;</span> module_name <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; as VideoSensor.&#34;</span>);
</span></span><span style="display:flex;"><span>        rosSensor <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>RosSensor<span style="color:#f92672">&gt;</span>(sensor, _parameters, frame_callback_function, update_sensor_func, hardware_reset_func, _diagnostics_updater, _logger, _use_intra_process, _dev.is<span style="color:#f92672">&lt;</span>playback<span style="color:#f92672">&gt;</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (sensor.is<span style="color:#f92672">&lt;</span>rs2<span style="color:#f92672">::</span>motion_sensor<span style="color:#f92672">&gt;</span>())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ROS_DEBUG_STREAM(<span style="color:#e6db74">&#34;Set &#34;</span> <span style="color:#f92672">&lt;&lt;</span> module_name <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; as ImuSensor.&#34;</span>);
</span></span><span style="display:flex;"><span>        rosSensor <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>RosSensor<span style="color:#f92672">&gt;</span>(sensor, _parameters, imu_callback_function, update_sensor_func, hardware_reset_func, _diagnostics_updater, _logger, false, _dev.is<span style="color:#f92672">&lt;</span>playback<span style="color:#f92672">&gt;</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (sensor.is<span style="color:#f92672">&lt;</span>rs2<span style="color:#f92672">::</span>pose_sensor<span style="color:#f92672">&gt;</span>())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ROS_DEBUG_STREAM(<span style="color:#e6db74">&#34;Set &#34;</span> <span style="color:#f92672">&lt;&lt;</span> module_name <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; as PoseSensor.&#34;</span>);
</span></span><span style="display:flex;"><span>        rosSensor <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>RosSensor<span style="color:#f92672">&gt;</span>(sensor, _parameters, multiple_message_callback_function, update_sensor_func, hardware_reset_func, _diagnostics_updater, _logger, false, _dev.is<span style="color:#f92672">&lt;</span>playback<span style="color:#f92672">&gt;</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ROS_ERROR_STREAM(<span style="color:#e6db74">&#34;Module Name </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&lt;&lt;</span> module_name <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> does not define a callback.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span>(<span style="color:#e6db74">&#34;Error: Module not supported&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    _available_ros_sensors.push_back(std<span style="color:#f92672">::</span>move(rosSensor));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>생성된 rosSensor들은 _available_ros_sensors에 push_back된 후, updateSensors에서 소비됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BaseRealSenseNode<span style="color:#f92672">::</span>updateSensors()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>lock_guard<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock_guard(_update_sensor_mutex);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;&amp;</span> sensor : _available_ros_sensors)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(is_profile_changed)
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Start/stop sensors only if profile was changed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// No need to start/stop sensors if align_depth was changed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ROS_INFO_STREAM(<span style="color:#e6db74">&#34;Stopping Sensor: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> module_name);
</span></span><span style="display:flex;"><span>        sensor<span style="color:#f92672">-&gt;</span>stop();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      stopPublishers(active_profiles);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>wanted_profiles.empty())
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span>(is_profile_changed)
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>              ROS_INFO_STREAM(<span style="color:#e6db74">&#34;Starting Sensor: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> module_name);
</span></span><span style="display:flex;"><span>              sensor<span style="color:#f92672">-&gt;</span>start(wanted_profiles);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>       ...
</span></span></code></pre></div><ul>
<li>RosSensor의 start 메소드에서 드디어 realsense sdk와의 연동이 동작하며, <code>\_frame_callback</code>이라는 메모리 전달이 구현되어 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// base_realsense_node.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>RosSensor<span style="color:#f92672">&gt;&gt;</span> _available_ros_sensors;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> RosSensor<span style="color:#f92672">::</span>start(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>stream_profile<span style="color:#f92672">&gt;&amp;</span> profiles)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (get_active_streams().size() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>    setupErrorCallback();
</span></span><span style="display:flex;"><span>    rs2<span style="color:#f92672">::</span>sensor<span style="color:#f92672">::</span>open(profiles);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> profile : profiles)
</span></span><span style="display:flex;"><span>    ROS_INFO_STREAM(<span style="color:#e6db74">&#34;Open profile: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> ProfilesManager<span style="color:#f92672">::</span>profile_string(profile));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rs2<span style="color:#f92672">::</span>sensor<span style="color:#f92672">::</span>start(_frame_callback);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_frame_callback <span style="color:#f92672">=</span> [<span style="color:#66d9ef">this</span>](rs2<span style="color:#f92672">::</span>frame frame)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  runFirstFrameInitialization();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> stream_type <span style="color:#f92672">=</span> frame.get_profile().stream_type();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> stream_index <span style="color:#f92672">=</span> frame.get_profile().stream_index();
</span></span><span style="display:flex;"><span>  stream_index_pair sip{stream_type, stream_index};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      _origin_frame_callback(frame);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (_frequency_diagnostics.find(sip) <span style="color:#f92672">!=</span> _frequency_diagnostics.end())
</span></span><span style="display:flex;"><span>          _frequency_diagnostics.at(sip).Tick();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">catch</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>exception<span style="color:#f92672">&amp;</span> ex)
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="publish-분석">Publish 분석</h3>
<blockquote>
<p>실제 image topic이 publish 되는 부분을 추가로 분석해 보겠습니다.</p>
</blockquote>
<ul>
<li>startPublishers 내부에서 <code>image_rcl_publisher</code> 타입의 클래스 포인터가 할당됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BaseRealSenseNode<span style="color:#f92672">::</span>startPublishers(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>stream_profile<span style="color:#f92672">&gt;&amp;</span> profiles, <span style="color:#66d9ef">const</span> RosSensor<span style="color:#f92672">&amp;</span> sensor)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string module_name(create_graph_resource_name(rs2_to_ros(sensor.get_info(RS2_CAMERA_INFO_NAME))));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> profile : profiles)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>       ...
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We can use 2 types of publishers:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// Native RCL publisher that support intra-process zero-copy comunication
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// image-transport package publisher that adds a commpressed image topic if package is found installed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (_use_intra_process)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _image_publishers[sip] <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>image_rcl_publisher<span style="color:#f92672">&gt;</span>(_node, image_raw.str(), qos);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _image_publishers[sip] <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>image_transport_publisher<span style="color:#f92672">&gt;</span>(_node, image_raw.str(), qos);
</span></span><span style="display:flex;"><span>            ROS_DEBUG_STREAM(<span style="color:#e6db74">&#34;image transport publisher was created for topic&#34;</span> <span style="color:#f92672">&lt;&lt;</span> image_raw.str());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_use_intra_process)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _depth_aligned_image_publishers[sip] <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>image_rcl_publisher<span style="color:#f92672">&gt;</span>(_node, aligned_image_raw.str(), qos);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _depth_aligned_image_publishers[sip] <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>image_transport_publisher<span style="color:#f92672">&gt;</span>(_node, aligned_image_raw.str(), qos);
</span></span><span style="display:flex;"><span>            ROS_DEBUG_STREAM(<span style="color:#e6db74">&#34;image transport publisher was created for topic&#34;</span> <span style="color:#f92672">&lt;&lt;</span> image_raw.str());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _depth_aligned_info_publisher[sip] <span style="color:#f92672">=</span> _node.create_publisher<span style="color:#f92672">&lt;</span>sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>CameraInfo<span style="color:#f92672">&gt;</span>(aligned_camera_info.str(),
</span></span><span style="display:flex;"><span>                                              rclcpp<span style="color:#f92672">::</span>QoS(rclcpp<span style="color:#f92672">::</span>QoSInitialization<span style="color:#f92672">::</span>from_rmw(info_qos), info_qos));
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><ul>
<li>참고로, _image_publishers는 아래와 같이 <code>std::map</code> 타입의 클래스 변수이며 index_pair와 image_publisher 포인터를 담고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>map<span style="color:#f92672">&lt;</span>stream_index_pair, std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>image_publisher<span style="color:#f92672">&gt;&gt;</span> _image_publishers;
</span></span></code></pre></div><ul>
<li><code>image_publisher.cpp - image_rcl_publisher</code>
image_rcl_publisher의 publish 메소드에서 드디어 실질적인 publish가 이루어집니다. 더불어 <code>std::move</code>를 통해 소유권을 이전하고 있습니다. (intra-processing에 대비한 것으로 보입니다.)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>image_rcl_publisher<span style="color:#f92672">::</span>image_rcl_publisher( rclcpp<span style="color:#f92672">::</span>Node <span style="color:#f92672">&amp;</span> node,
</span></span><span style="display:flex;"><span>                                          <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string <span style="color:#f92672">&amp;</span> topic_name,
</span></span><span style="display:flex;"><span>                                          <span style="color:#66d9ef">const</span> rmw_qos_profile_t <span style="color:#f92672">&amp;</span> qos )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    image_publisher_impl <span style="color:#f92672">=</span> node.create_publisher<span style="color:#f92672">&lt;</span> sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Image <span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>        topic_name,
</span></span><span style="display:flex;"><span>        rclcpp<span style="color:#f92672">::</span>QoS( rclcpp<span style="color:#f92672">::</span>QoSInitialization<span style="color:#f92672">::</span>from_rmw( qos ), qos ) );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> image_rcl_publisher<span style="color:#f92672">::</span>publish( sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Image<span style="color:#f92672">::</span>UniquePtr image_ptr )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    image_publisher_impl<span style="color:#f92672">-&gt;</span>publish( std<span style="color:#f92672">::</span>move( image_ptr ) );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>image_transport_publisher<span style="color:#f92672">::</span>image_transport_publisher( rclcpp<span style="color:#f92672">::</span>Node <span style="color:#f92672">&amp;</span> node,
</span></span><span style="display:flex;"><span>                                                      <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string <span style="color:#f92672">&amp;</span> topic_name,
</span></span><span style="display:flex;"><span>                                                      <span style="color:#66d9ef">const</span> rmw_qos_profile_t <span style="color:#f92672">&amp;</span> qos )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    image_publisher_impl <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span> image_transport<span style="color:#f92672">::</span>Publisher <span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>        image_transport<span style="color:#f92672">::</span>create_publisher( <span style="color:#f92672">&amp;</span>node, topic_name, qos ) );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> image_transport_publisher<span style="color:#f92672">::</span>publish( sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Image<span style="color:#f92672">::</span>UniquePtr image_ptr )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    image_publisher_impl<span style="color:#f92672">-&gt;</span>publish( <span style="color:#f92672">*</span>image_ptr );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>image_rcl_publisher</code>가 사용되는 부분을 추적해 보겠습니다. BaseRealSenseNode의 frame_callback에서 다시 publishFrame callback을 호출하여 _image_publishers를 전달하고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BaseRealSenseNode<span style="color:#f92672">::</span>frame_callback(rs2<span style="color:#f92672">::</span>frame frame)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	publishFrame(f, t, sip,
</span></span><span style="display:flex;"><span>	                _image,
</span></span><span style="display:flex;"><span>	                _info_publisher,
</span></span><span style="display:flex;"><span>	                _image_publishers);
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>  publishFrame(frame_to_send, t,
</span></span><span style="display:flex;"><span>              DEPTH,
</span></span><span style="display:flex;"><span>              _image,
</span></span><span style="display:flex;"><span>              _info_publisher,
</span></span><span style="display:flex;"><span>              _image_publishers);
</span></span></code></pre></div><ul>
<li>전달된 _image_publishers는 std::map type이기 때문에 rgb, depth, infra camera 중에서 indexing하여 최종 publish가 진행됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BaseRealSenseNode<span style="color:#f92672">::</span>publishFrame(rs2<span style="color:#f92672">::</span>frame f, <span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>Time<span style="color:#f92672">&amp;</span> t,
</span></span><span style="display:flex;"><span>                                     <span style="color:#66d9ef">const</span> stream_index_pair<span style="color:#f92672">&amp;</span> stream,
</span></span><span style="display:flex;"><span>                                     std<span style="color:#f92672">::</span>map<span style="color:#f92672">&lt;</span>stream_index_pair, cv<span style="color:#f92672">::</span>Mat<span style="color:#f92672">&gt;&amp;</span> images,
</span></span><span style="display:flex;"><span>                                     <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>map<span style="color:#f92672">&lt;</span>stream_index_pair, rclcpp<span style="color:#f92672">::</span>Publisher<span style="color:#f92672">&lt;</span>sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>CameraInfo<span style="color:#f92672">&gt;::</span>SharedPtr<span style="color:#f92672">&gt;&amp;</span> info_publishers,
</span></span><span style="display:flex;"><span>                                     <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>map<span style="color:#f92672">&lt;</span>stream_index_pair, std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>image_publisher<span style="color:#f92672">&gt;&gt;&amp;</span> image_publishers,
</span></span><span style="display:flex;"><span>                                     <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">bool</span> is_publishMetadata){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> image_publisher <span style="color:#f92672">=</span> image_publishers.at(stream);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>image_publisher<span style="color:#f92672">-&gt;</span>publish(std<span style="color:#f92672">::</span>move(img));
</span></span></code></pre></div>
<div class="notices note" ><p>다시 말하지만, realsense2 ros2 코드가 완성도가 높은 것은 아닙니다. 하지만, 적어도 ROS 2시스템 차원에서 코드를 분석할 수 있는 예시가 되기에 같이 파헤쳐 보았습니다.</p>
</div>

<h3 id="rs_intra_process_demo_launchpy">rs_intra_process_demo_launch.py</h3>
<ul>
<li>Composition 예시에서 살펴본 바와 같이 launch file에서 <code>ComposableNodeContainer</code>를 통해 composition container를 실행하고, RealSenseNodeFactory/FrameLatencyNode composition을 load하고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>rs_node_class<span style="color:#f92672">=</span>  <span style="color:#e6db74">&#39;RealSenseNodeFactory&#39;</span>
</span></span><span style="display:flex;"><span>rs_latency_tool_class <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;FrameLatencyNode&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_launch_description</span>():
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> LaunchDescription(declare_configurable_parameters(configurable_parameters) <span style="color:#f92672">+</span> [
</span></span><span style="display:flex;"><span>    ComposableNodeContainer(
</span></span><span style="display:flex;"><span>      name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;my_container&#39;</span>,
</span></span><span style="display:flex;"><span>      namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>      package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rclcpp_components&#39;</span>,
</span></span><span style="display:flex;"><span>      executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;component_container&#39;</span>,
</span></span><span style="display:flex;"><span>      composable_node_descriptions<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        ComposableNode(
</span></span><span style="display:flex;"><span>          package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;realsense2_camera&#39;</span>,
</span></span><span style="display:flex;"><span>          namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>          plugin<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;realsense2_camera::&#39;</span> <span style="color:#f92672">+</span> rs_node_class,
</span></span><span style="display:flex;"><span>          name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;camera&#34;</span>,
</span></span><span style="display:flex;"><span>          parameters<span style="color:#f92672">=</span>[set_configurable_parameters(configurable_parameters)],
</span></span><span style="display:flex;"><span>          extra_arguments<span style="color:#f92672">=</span>[{<span style="color:#e6db74">&#39;use_intra_process_comms&#39;</span>: LaunchConfiguration(<span style="color:#e6db74">&#34;intra_process_comms&#34;</span>)}]) ,
</span></span><span style="display:flex;"><span>        ComposableNode(
</span></span><span style="display:flex;"><span>          package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;realsense2_camera&#39;</span>,
</span></span><span style="display:flex;"><span>          namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>          plugin<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rs2_ros::tools::frame_latency::&#39;</span> <span style="color:#f92672">+</span> rs_latency_tool_class,
</span></span><span style="display:flex;"><span>          name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;frame_latency&#39;</span>,
</span></span><span style="display:flex;"><span>          parameters<span style="color:#f92672">=</span>[set_configurable_parameters(configurable_parameters)],
</span></span><span style="display:flex;"><span>          extra_arguments<span style="color:#f92672">=</span>[{<span style="color:#e6db74">&#39;use_intra_process_comms&#39;</span>: LaunchConfiguration(<span style="color:#e6db74">&#34;intra_process_comms&#34;</span>)}]) ,
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>      output<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;screen&#39;</span>,
</span></span><span style="display:flex;"><span>      emulate_tty<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, <span style="color:#75715e"># needed for display of logs</span>
</span></span><span style="display:flex;"><span>      arguments<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;--ros-args&#39;</span>, <span style="color:#e6db74">&#39;--log-level&#39;</span>, LaunchConfiguration(<span style="color:#e6db74">&#39;log_level&#39;</span>)],
</span></span><span style="display:flex;"><span>  )])
</span></span></code></pre></div><ul>
<li><code>RealSenseNodeFactory</code>는 애초에 composition 형태로 개발되었으므로 실제 코드를 살펴보아도 로그를 남기는 것외에 추가 작업은 없습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>BaseRealSenseNode<span style="color:#f92672">::</span>BaseRealSenseNode(rclcpp<span style="color:#f92672">::</span>Node<span style="color:#f92672">&amp;</span> node,
</span></span><span style="display:flex;"><span>                                     rs2<span style="color:#f92672">::</span>device dev,
</span></span><span style="display:flex;"><span>                                     std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>Parameters<span style="color:#f92672">&gt;</span> parameters,
</span></span><span style="display:flex;"><span>                                     <span style="color:#66d9ef">bool</span> use_intra_process) <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    _use_intra_process(use_intra_process),
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( use_intra_process )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ROS_INFO(<span style="color:#e6db74">&#34;Intra-Process communication enabled&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><ul>
<li>FrameLatencyNode는 tools ⇒ frame_latency에 구현되어 있으며, 단순히 topic publish의 지연 시간을 계산하여 콘솔 출력합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>FrameLatencyNode<span style="color:#f92672">::</span>FrameLatencyNode( <span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>NodeOptions <span style="color:#f92672">&amp;</span> node_options )
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> Node( <span style="color:#e6db74">&#34;frame_latency&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>, node_options )
</span></span><span style="display:flex;"><span>    , _logger( <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>get_logger() )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ROS_INFO_STREAM( <span style="color:#e6db74">&#34;frame_latency node is UP!&#34;</span> );
</span></span><span style="display:flex;"><span>    ROS_INFO_STREAM( <span style="color:#e6db74">&#34;Intra-Process is &#34;</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">&lt;&lt;</span> ( <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>get_node_options().use_intra_process_comms() <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;ON&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OFF&#34;</span> ) );
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a subscription on the input topic.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _sub <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>create_subscription<span style="color:#f92672">&lt;</span> sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Image <span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;/color/image_raw&#34;</span>,  <span style="color:#75715e">// TODO Currently color only, we can declare and accept the required
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                             <span style="color:#75715e">// streams as ros parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        rclcpp<span style="color:#f92672">::</span>QoS( rclcpp<span style="color:#f92672">::</span>QoSInitialization<span style="color:#f92672">::</span>from_rmw( rmw_qos_profile_default ),
</span></span><span style="display:flex;"><span>                     rmw_qos_profile_default ),
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">&amp;</span>, <span style="color:#66d9ef">this</span>]( <span style="color:#66d9ef">const</span> sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Image<span style="color:#f92672">::</span>SharedPtr msg ) {
</span></span><span style="display:flex;"><span>            rclcpp<span style="color:#f92672">::</span>Time curr_time <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>get_clock()<span style="color:#f92672">-&gt;</span>now();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">auto</span> latency <span style="color:#f92672">=</span> ( curr_time <span style="color:#f92672">-</span> msg<span style="color:#f92672">-&gt;</span>header.stamp ).seconds();
</span></span><span style="display:flex;"><span>            ROS_INFO_STREAM( <span style="color:#e6db74">&#34;Got msg with address 0x&#34;</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>hex <span style="color:#f92672">&lt;&lt;</span> <span style="color:#66d9ef">reinterpret_cast</span><span style="color:#f92672">&lt;</span> std<span style="color:#f92672">::</span>uintptr_t <span style="color:#f92672">&gt;</span>( msg.get() )
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>dec <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; with latency of &#34;</span> <span style="color:#f92672">&lt;&lt;</span> latency <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; [sec]&#34;</span> );
</span></span><span style="display:flex;"><span>        } );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="rs_multi_camera_launchpy">rs_multi_camera_launch.py</h3>
<ul>
<li>rs_multi_camera_launch에서는 namespace가 지정된 rs_launch.py 2개가 실행되며, rviz2 시각화를 위해 별도로 static_transform_publisher가 실행됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>local_parameters <span style="color:#f92672">=</span> [{<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;camera_name1&#39;</span>, <span style="color:#e6db74">&#39;default&#39;</span>: <span style="color:#e6db74">&#39;camera1&#39;</span>, <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;camera unique name&#39;</span>},
</span></span><span style="display:flex;"><span>                    {<span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;camera_name2&#39;</span>, <span style="color:#e6db74">&#39;default&#39;</span>: <span style="color:#e6db74">&#39;camera2&#39;</span>, <span style="color:#e6db74">&#39;description&#39;</span>: <span style="color:#e6db74">&#39;camera unique name&#39;</span>},
</span></span><span style="display:flex;"><span>                   ]
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_launch_description</span>():
</span></span><span style="display:flex;"><span>  params1 <span style="color:#f92672">=</span> duplicate_params(rs_launch<span style="color:#f92672">.</span>configurable_parameters, <span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>  params2 <span style="color:#f92672">=</span> duplicate_params(rs_launch<span style="color:#f92672">.</span>configurable_parameters, <span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> LaunchDescription(
</span></span><span style="display:flex;"><span>    rs_launch<span style="color:#f92672">.</span>declare_configurable_parameters(local_parameters) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    rs_launch<span style="color:#f92672">.</span>declare_configurable_parameters(params1) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    rs_launch<span style="color:#f92672">.</span>declare_configurable_parameters(params2) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    [
</span></span><span style="display:flex;"><span>    IncludeLaunchDescription(
</span></span><span style="display:flex;"><span>      PythonLaunchDescriptionSource([ThisLaunchFileDir(), <span style="color:#e6db74">&#39;/rs_launch.py&#39;</span>]),
</span></span><span style="display:flex;"><span>      launch_arguments<span style="color:#f92672">=</span>set_configurable_parameters(params1)<span style="color:#f92672">.</span>items(),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    IncludeLaunchDescription(
</span></span><span style="display:flex;"><span>      PythonLaunchDescriptionSource([ThisLaunchFileDir(), <span style="color:#e6db74">&#39;/rs_launch.py&#39;</span>]),
</span></span><span style="display:flex;"><span>      launch_arguments<span style="color:#f92672">=</span>set_configurable_parameters(params2)<span style="color:#f92672">.</span>items(),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># dummy static transformation from camera1 to camera2</span>
</span></span><span style="display:flex;"><span>    launch_ros<span style="color:#f92672">.</span>actions<span style="color:#f92672">.</span>Node(
</span></span><span style="display:flex;"><span>      package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tf2_ros&#34;</span>,
</span></span><span style="display:flex;"><span>      executable <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;static_transform_publisher&#34;</span>,
</span></span><span style="display:flex;"><span>      arguments <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#e6db74">&#34;camera1_link&#34;</span>, <span style="color:#e6db74">&#34;camera2_link&#34;</span>]
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  ])
</span></span></code></pre></div><ul>
<li>rs_multi_camera_launch.py에서 선언된 camera_name launch argument는 rs_launch.py로 전달되어 namespace 옵션에 추가됨과 더불어 Composotion에게 전달됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> LaunchDescription(declare_configurable_parameters(configurable_parameters) <span style="color:#f92672">+</span> [
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Realsense</span>
</span></span><span style="display:flex;"><span>  launch_ros<span style="color:#f92672">.</span>actions<span style="color:#f92672">.</span>Node(
</span></span><span style="display:flex;"><span>    condition<span style="color:#f92672">=</span>IfCondition(PythonExpression([LaunchConfiguration(<span style="color:#e6db74">&#39;config_file&#39;</span>), <span style="color:#e6db74">&#34; == &#39;&#39;&#34;</span>])),
</span></span><span style="display:flex;"><span>    package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;realsense2_camera&#39;</span>,
</span></span><span style="display:flex;"><span>    namespace<span style="color:#f92672">=</span>LaunchConfiguration(<span style="color:#e6db74">&#34;camera_name&#34;</span>),
</span></span><span style="display:flex;"><span>    name<span style="color:#f92672">=</span>LaunchConfiguration(<span style="color:#e6db74">&#34;camera_name&#34;</span>),
</span></span><span style="display:flex;"><span>    executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;realsense2_camera_node&#39;</span>,
</span></span><span style="display:flex;"><span>    parameters<span style="color:#f92672">=</span>[set_configurable_parameters(configurable_parameters)],
</span></span><span style="display:flex;"><span>    output<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;screen&#39;</span>,
</span></span><span style="display:flex;"><span>    arguments<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;--ros-args&#39;</span>, <span style="color:#e6db74">&#39;--log-level&#39;</span>, LaunchConfiguration(<span style="color:#e6db74">&#39;log_level&#39;</span>)],
</span></span><span style="display:flex;"><span>    emulate_tty<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>  ),
</span></span></code></pre></div><ul>
<li>parameter를 모두 관리하는 parameters.cpp에서 camera_name의 파싱을 확인할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> BaseRealSenseNode<span style="color:#f92672">::</span>getParameters()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ROS_INFO(<span style="color:#e6db74">&#34;getParameters...&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string param_name;
</span></span><span style="display:flex;"><span>    param_name <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>string(<span style="color:#e6db74">&#34;camera_name&#34;</span>);
</span></span><span style="display:flex;"><span>    _camera_name <span style="color:#f92672">=</span> _parameters<span style="color:#f92672">-&gt;</span>setParam<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(param_name, <span style="color:#e6db74">&#34;camera&#34;</span>);
</span></span><span style="display:flex;"><span>    _parameters_names.push_back(param_name);
</span></span></code></pre></div><h2 id="realsense2-description">realsense2 Description</h2>
<blockquote>
<p>description이라는 이름을 가진 패키지는 CAD, URDF 파일과 같은 물성치, 외관에 대한 데이터를 담고 있습니다. realsense의 description package를 분석해봅시다.</p>
</blockquote>
<ul>
<li>기본 launch file을 실행해 보겠으며, d455 옵션으로 실행해보겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>ros2 launch realsense2_description view_model.launch.py model:<span style="color:#f92672">=&lt;</span>sth<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>ros2 launch realsense2_description view_model.launch.py model:<span style="color:#f92672">=</span>test_d455_camera.urdf.xacro
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images17/Untitled8.png?height=300px" alt="Untitled8.png"></p>
<p>⇒ 센서 외관을 비롯하여 다양한 내장 센서들에 대한 tf2도 확인할 수 있습니다.</p>
<ul>
<li>tf2 tree를 통해 이에 대한 자세한 구조를 파악할 수 있으며, d455는 카메라 뿐만 아니라 가속도 센서, 자이로 센서를 포함하고 있어 아래와 같이 복잡한 구조를 갖게 됩니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled9.png?height=400px" alt="Untitled9.png"></p>
<blockquote>
<p>지금 tf2 tree에서는 base_link가 최상위 Node인데요. 실제 로봇 시스템에 장착 시 로봇의 base_link가 이미 존재한다면 의도치 않은 tf2 error가 발생할 수 있습니다.</p>
</blockquote>
<ul>
<li>실제 test_d455_camera.urdf.xacro 파일에서도 이를 손쉽게 제거할 수 있도록 아래와 같이 base_link를 별도 분리해둔 모습을 볼 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;robot</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;realsense2_camera&#34;</span> <span style="color:#a6e22e">xmlns:xacro=</span><span style="color:#e6db74">&#34;http://ros.org/wiki/xacro&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;xacro:arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;use_nominal_extrinsics&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;xacro:include</span> <span style="color:#a6e22e">filename=</span><span style="color:#e6db74">&#34;$(find realsense2_description)/urdf/_d455.urdf.xacro&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;link</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;base_link&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;xacro:sensor_d455</span> <span style="color:#a6e22e">parent=</span><span style="color:#e6db74">&#34;base_link&#34;</span> <span style="color:#a6e22e">use_nominal_extrinsics=</span><span style="color:#e6db74">&#34;$(arg use_nominal_extrinsics)&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;origin</span> <span style="color:#a6e22e">xyz=</span><span style="color:#e6db74">&#34;0 0 0&#34;</span> <span style="color:#a6e22e">rpy=</span><span style="color:#e6db74">&#34;0 0 0&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/xacro:sensor_d455&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/robot&gt;</span>
</span></span></code></pre></div><h3 id="description-launch-file-분석">Description Launch file 분석</h3>
<ul>
<li>view_model.launch.py - 실제 실행되는 Node는 robot_state_publisher와 rviz2 입니다. (센서는 움직이는 파츠가 없으니 joint_state_publisher는 굳이 필요 없겠지요?)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>rviz_node <span style="color:#f92672">=</span> Node(
</span></span><span style="display:flex;"><span>    package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rviz2&#39;</span>,
</span></span><span style="display:flex;"><span>    executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rviz2&#39;</span>,
</span></span><span style="display:flex;"><span>    node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rviz2&#39;</span>,
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;screen&#39;</span>,
</span></span><span style="display:flex;"><span>    arguments<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;-d&#39;</span>, rviz_config_dir],
</span></span><span style="display:flex;"><span>    parameters<span style="color:#f92672">=</span>[{<span style="color:#e6db74">&#39;use_sim_time&#39;</span>: <span style="color:#66d9ef">False</span>}]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>model_node <span style="color:#f92672">=</span> Node(
</span></span><span style="display:flex;"><span>    node_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;model_node&#39;</span>,
</span></span><span style="display:flex;"><span>    package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;robot_state_publisher&#39;</span>,
</span></span><span style="display:flex;"><span>    executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;robot_state_publisher&#39;</span>,
</span></span><span style="display:flex;"><span>    namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>    output<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;screen&#39;</span>,
</span></span><span style="display:flex;"><span>    arguments <span style="color:#f92672">=</span> [urdf]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> launch<span style="color:#f92672">.</span>LaunchDescription([rviz_node, model_node])
</span></span></code></pre></div>
<div class="notices note" ><p>robot_state_publisher의 argument로 urdf 파일들이 전달되며, 사용자로부터 mode:= 값을 받아 해당 urdf file이 실행되는 형식입니다. (저라면 Launch Argument를 사용했을 것 같습니다.)</p>
</div>

<ul>
<li>urdf 폴더를 살펴보면, 모든 모델에 대한 기본 urdf file과, description launch를 위해 base_link가 결합된 test urdf들이 자동생성되어있는 모습을 확인할 수 있습니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled10.png?height=300px" alt="Untitled10.png"></p>
<ul>
<li>마지막으로 카메라 센서의 tf2 사용 시 주의할 점이 있는데요. 일반적으로 컴퓨터 비전 도메인에서 사용하는 좌표계와, ROS 2에서 사용하는 좌표계는 아래와 같이 차이를 갖습니다. gazebo plugin 시간에 살펴보았던 것처럼 rviz2를 통해 검증을 한 뒤 사용하기를 추천드립니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled11.png?height=300px" alt="Untitled11.png"></p>
<h3 id="custom-message">Custom Message</h3>
<ul>
<li>대부분 센서 패키지들은 sdk에서 정의된 자료구조와 ROS 2의 연동을 위해 custom interface를 구현합니다. realsense2에서도 IMUInfo를 비롯한 Custom Interface들을 제공하고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> ros2 interface show realsense2_camera_msgs<span style="color:#f92672">/</span>msg<span style="color:#f92672">/</span>IMUInfo
</span></span><span style="display:flex;"><span><span style="color:#75715e"># header.frame_id is either set to &#34;imu_accel&#34; or &#34;imu_gyro&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to distinguish between &#34;accel&#34; and &#34;gyro&#34; info.</span>
</span></span><span style="display:flex;"><span>std_msgs<span style="color:#f92672">/</span>Header header
</span></span><span style="display:flex;"><span>float64[<span style="color:#ae81ff">12</span>] data
</span></span><span style="display:flex;"><span>float64[<span style="color:#ae81ff">3</span>] noise_variances
</span></span><span style="display:flex;"><span>float64[<span style="color:#ae81ff">3</span>] bias_variances
</span></span></code></pre></div>
<div class="notices note" ><p>⇒ 이렇게 custom interface가 있다면, 다른 패키지의 종속성이 될 확률이 높이 때문에 먼저 빌드해줘야 합니다.</p>
</div>


<div class="notices note" ><p>⇒ 더불어 custom interface는 해당 workspace에만 적용되기 때문에 workspace가 바뀌면 적용되지 않습니다.</p>
</div>

<ul>
<li>CMakeLists.txt를 통해 빌드되는 모든 IDL들을 확인할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>set(msg_files
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;msg/IMUInfo.msg&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;msg/Extrinsics.msg&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;msg/Metadata.msg&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>rosidl_generate_interfaces(<span style="color:#960050;background-color:#1e0010">$</span>{PROJECT_NAME}
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">$</span>{msg_files}
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;srv/DeviceInfo.srv&#34;</span>
</span></span><span style="display:flex;"><span>  DEPENDENCIES builtin_interfaces std_msgs
</span></span><span style="display:flex;"><span>  ADD_LINTER_TESTS
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><ul>
<li>일전 이야기한 것과 같이 다른 소스코드에서 custom interface를 사용하고 있어 선행 빌드 후 소싱이 꼭 필요합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;librealsense2/rs.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;librealsense2/rsutil.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;constants.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cv_bridge/cv_bridge.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;diagnostic_updater/diagnostic_updater.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;diagnostic_updater/publisher.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;realsense2_camera_msgs/msg/imu_info.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;realsense2_camera_msgs/msg/extrinsics.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;realsense2_camera_msgs/msg/metadata.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;realsense2_camera_msgs/srv/device_info.hpp&#34;</span><span style="color:#75715e">
</span></span></span></code></pre></div><h2 id="velodyne-lidar-ros-2-실행">velodyne Lidar ROS 2 실행</h2>
<p>이번에는 point cloud 데이터를 센싱할 수 있는 3D Lidar 중 가장 보편적으로 사용되는 VLP-16의 ROS 2 패키지를 분석해보겠습니다.</p>
<p><img src="/kr/ros2_foxy/images17/Untitled12.png?height=300px" alt="Untitled12.png"></p>
<ul>
<li>velodyne lidar 또한 ubuntu package를 제공하고 있으며 자체적인 Gazebo package와 driver 패키지를 모두 제공합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> sudo apt install ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>description            ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>laserscan<span style="color:#f92672">-</span>dbgsym
</span></span><span style="display:flex;"><span>ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>driver                 ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>msgs
</span></span><span style="display:flex;"><span>ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>driver<span style="color:#f92672">-</span>dbgsym          ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>msgs<span style="color:#f92672">-</span>dbgsym
</span></span><span style="display:flex;"><span>ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>gazebo<span style="color:#f92672">-</span>plugins         ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>pointcloud
</span></span><span style="display:flex;"><span>ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>gazebo<span style="color:#f92672">-</span>plugins<span style="color:#f92672">-</span>dbgsym  ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>pointcloud<span style="color:#f92672">-</span>dbgsym
</span></span><span style="display:flex;"><span>ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>laserscan              ros<span style="color:#f92672">-</span>foxy<span style="color:#f92672">-</span>velodyne<span style="color:#f92672">-</span>simulator
</span></span></code></pre></div><ul>
<li>이번에도 우리는 학습을 위해 소스코드 빌드를 진행하겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ~/ros2_ws/src
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># package clone</span>
</span></span><span style="display:flex;"><span>git clone -b foxy-devel https://github.com/ros-drivers/velodyne.git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dependencies install</span>
</span></span><span style="display:flex;"><span>sudo apt-get update <span style="color:#f92672">&amp;&amp;</span> sudo apt-get install libpcap-dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># source code build</span>
</span></span><span style="display:flex;"><span>cbp velodyne_msgs <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span><span style="display:flex;"><span>cbp velodyne_laserscan <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span><span style="display:flex;"><span>cbp velodyne_pointcloud <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span><span style="display:flex;"><span>cbp velodyne_driver <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span><span style="display:flex;"><span>cbp velodyne <span style="color:#f92672">&amp;&amp;</span> source install/local_setup.bash
</span></span></code></pre></div><ul>
<li>velodyne lidar는 Ethernet 인터페이스를 제공합니다. 따라서 Ubuntu의 네트워크 설정에서 고정 IP 설정을 해주며, VLP-16의 기본 IP는 <strong>192.168.1.100</strong>입니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled13.png?height=300px" alt="Untitled13.png"></p>
<ul>
<li>설정 이후 launch는 다음과 같습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>ros2 launch velodyne velodyne<span style="color:#f92672">-</span>all<span style="color:#f92672">-</span>nodes<span style="color:#f92672">-</span>VLP16<span style="color:#f92672">-</span>launch.py
</span></span></code></pre></div><ul>
<li>launch rviz2를 통한 시각화를 해봅시다. fixed frame을 velodyne으로 설정해야 합니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/velo1.png?height=300px" alt="velo1.png"></p>
<ul>
<li>tf2 tree를 살펴보면 아무것도 조회되지 않습니다. velodyne tf2만 broadcast되고 있기 때문에 확인할 수 없는 것입니다.</li>
</ul>

<div class="notices tip" ><p>저였다면 stasic transform broadcaster를 통해 world &gt; velodyne tf2를 하나 생성했을 것 같습니다.</p>
</div>

<p><img src="/kr/ros2_foxy/images17/Untitled14.png?height=300px" alt="Untitled14.png"></p>
<ul>
<li>velodyne lidar 또한 composed-launch라는 comspoition 기반 실행을 지원합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ros2 launch velodyne velodyne-all-nodes-VLP16-composed-launch.py
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>launch_ros.actions.load_composable_nodes<span style="color:#f92672">]</span>: Loaded node <span style="color:#e6db74">&#39;/velodyne_driver_node&#39;</span> in container <span style="color:#e6db74">&#39;/velodyne_container&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.537928654<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_container<span style="color:#f92672">]</span>: Load Library: /home/kimsooyoung/ros2_ws/install/velodyne_pointcloud/lib/libconvert.so
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.540579179<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_container<span style="color:#f92672">]</span>: Found class: rclcpp_components::NodeFactoryTemplate&lt;velodyne_pointcloud::Convert&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.540601962<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_container<span style="color:#f92672">]</span>: Instantiate class: rclcpp_components::NodeFactoryTemplate&lt;velodyne_pointcloud::Convert&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.542606795<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_convert_node<span style="color:#f92672">]</span>: correction angles: /home/kimsooyoung/ros2_ws/install/velodyne_pointcloud/share/velodyne_pointcloud/params/VLP16db.yaml
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>launch_ros.actions.load_composable_nodes<span style="color:#f92672">]</span>: Loaded node <span style="color:#e6db74">&#39;/velodyne_convert_node&#39;</span> in container <span style="color:#e6db74">&#39;/velodyne_container&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.548422161<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_container<span style="color:#f92672">]</span>: Load Library: /home/kimsooyoung/ros2_ws/install/velodyne_laserscan/lib/libvelodyne_laserscan.so
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.549147973<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_container<span style="color:#f92672">]</span>: Found class: rclcpp_components::NodeFactoryTemplate&lt;velodyne_laserscan::VelodyneLaserScan&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.549171818<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_container<span style="color:#f92672">]</span>: Instantiate class: rclcpp_components::NodeFactoryTemplate&lt;velodyne_laserscan::VelodyneLaserScan&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>launch_ros.actions.load_composable_nodes<span style="color:#f92672">]</span>: Loaded node <span style="color:#e6db74">&#39;/velodyne_laserscan_node&#39;</span> in container <span style="color:#e6db74">&#39;/velodyne_container&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>INFO<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.597621115<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_laserscan_node<span style="color:#f92672">]</span>: Latched ring count of <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>component_container-1<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>WARN<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>1682566114.597755427<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>velodyne_laserscan_node<span style="color:#f92672">]</span>: PointCloud2 fields in unexpected order. Using slower generic method.
</span></span></code></pre></div><ul>
<li>composed-launch와 일반 launch 시 차이점을 rqt_graph로 확인해봅시다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/velo_rqt.png?height=300px" alt="velo_rqt.png"></p>
<p><img src="/kr/ros2_foxy/images17/veloc_rqt.png?height=300px" alt="veloc_rqt.png"></p>
<h3 id="launch-file-분석">Launch file 분석</h3>
<ul>
<li><code>velodyne-all-nodes-VLP16-launch.py</code>를 분석해봅시다. velodyne_driver_node, velodyne_convert_node, velodyne_laserscan_node이 실행되며 velodyne_driver_node의 종료 시 launch 자체가 종료되도록 Event를 걸어주었습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> launch<span style="color:#f92672">.</span>LaunchDescription([
</span></span><span style="display:flex;"><span>    velodyne_driver_node,
</span></span><span style="display:flex;"><span>    velodyne_convert_node,
</span></span><span style="display:flex;"><span>    velodyne_laserscan_node,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    launch<span style="color:#f92672">.</span>actions<span style="color:#f92672">.</span>RegisterEventHandler(
</span></span><span style="display:flex;"><span>        event_handler<span style="color:#f92672">=</span>launch<span style="color:#f92672">.</span>event_handlers<span style="color:#f92672">.</span>OnProcessExit(
</span></span><span style="display:flex;"><span>            target_action<span style="color:#f92672">=</span>velodyne_driver_node,
</span></span><span style="display:flex;"><span>            on_exit<span style="color:#f92672">=</span>[launch<span style="color:#f92672">.</span>actions<span style="color:#f92672">.</span>EmitEvent(
</span></span><span style="display:flex;"><span>                event<span style="color:#f92672">=</span>launch<span style="color:#f92672">.</span>events<span style="color:#f92672">.</span>Shutdown())],
</span></span><span style="display:flex;"><span>        )),
</span></span><span style="display:flex;"><span>    ])
</span></span></code></pre></div><ul>
<li><code>velodyne-all-nodes-VLP16-composed-launch.py</code>에서는 component_container와 velodyne_driver::VelodyneDriver, velodyne_pointcloud::Convert, velodyne_laserscan::VelodyneLaserScan 3개의 composition이 동작합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>	container <span style="color:#f92672">=</span> ComposableNodeContainer(
</span></span><span style="display:flex;"><span>	  name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_container&#39;</span>,
</span></span><span style="display:flex;"><span>	  namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>	  package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;rclcpp_components&#39;</span>,
</span></span><span style="display:flex;"><span>	  executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;component_container&#39;</span>,
</span></span><span style="display:flex;"><span>	  composable_node_descriptions<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>	    ComposableNode(
</span></span><span style="display:flex;"><span>	      package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_driver&#39;</span>,
</span></span><span style="display:flex;"><span>	      plugin<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_driver::VelodyneDriver&#39;</span>,
</span></span><span style="display:flex;"><span>	      name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_driver_node&#39;</span>,
</span></span><span style="display:flex;"><span>	      parameters<span style="color:#f92672">=</span>[driver_params]),
</span></span><span style="display:flex;"><span>	    ComposableNode(
</span></span><span style="display:flex;"><span>	      package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_pointcloud&#39;</span>,
</span></span><span style="display:flex;"><span>	      plugin<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_pointcloud::Convert&#39;</span>,
</span></span><span style="display:flex;"><span>	      name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_convert_node&#39;</span>,
</span></span><span style="display:flex;"><span>	      parameters<span style="color:#f92672">=</span>[convert_params]),
</span></span><span style="display:flex;"><span>	    ComposableNode(
</span></span><span style="display:flex;"><span>	      package<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_laserscan&#39;</span>,
</span></span><span style="display:flex;"><span>	      plugin<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_laserscan::VelodyneLaserScan&#39;</span>,
</span></span><span style="display:flex;"><span>	      name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;velodyne_laserscan_node&#39;</span>,
</span></span><span style="display:flex;"><span>	      parameters<span style="color:#f92672">=</span>[laserscan_params]),
</span></span><span style="display:flex;"><span>	  ],
</span></span><span style="display:flex;"><span>	  output<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;both&#39;</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> LaunchDescription([container])
</span></span></code></pre></div><blockquote>
<p>이제 방금 전의 실행 코드들(velodyne_driver_node, velodyne_convert_node, velodyne_laserscan_node)을 분석해 봅시다.</p>
</blockquote>
<h3 id="velodyne_driver_node">velodyne_driver_node</h3>
<ul>
<li>velodyne package의 <code>CMakeLists.txt</code>에서 velodyne_driver_node의 코드를 확인할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>add_executable(velodyne_driver_node src<span style="color:#f92672">/</span>driver<span style="color:#f92672">/</span>velodyne_node<span style="color:#f92672">.</span>cpp)
</span></span><span style="display:flex;"><span>ament_target_dependencies(velodyne_driver_node rclcpp)
</span></span><span style="display:flex;"><span>target_link_libraries(velodyne_driver_node velodyne_driver)
</span></span><span style="display:flex;"><span>install(TARGETS velodyne_driver_node DESTINATION lib<span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">$</span>{PROJECT_NAME})
</span></span></code></pre></div><ul>
<li>velodyne_node.cpp 자체는 일반적인 rclcpp node programming이 구현되어 있습니다. (대신 NodeOptions을 매개변수로 전달하는데 이는 VelodyneDriver가 Composition형태로 구현되어 있기 때문입니다.)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;rclcpp/rclcpp.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;memory&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;velodyne_driver/driver.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span> argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Force flush of the stdout buffer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  setvbuf(stdout, <span style="color:#66d9ef">nullptr</span>, _IONBF, BUFSIZ);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>spin(std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>velodyne_driver<span style="color:#f92672">::</span>VelodyneDriver<span style="color:#f92672">&gt;</span>(rclcpp<span style="color:#f92672">::</span>NodeOptions()));
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>shutdown();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>VelodyneDriver::VelodyneDriver</code>에서는 velodyne sdk =&gt; ROS 2로의 형태 변환이 이루어집니다. Composition을 고려한 형태로 Node 프로그래밍 되어있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> velodyne_driver
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VelodyneDriver</span> <span style="color:#66d9ef">final</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> rclcpp<span style="color:#f92672">::</span>Node
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">explicit</span> VelodyneDriver(<span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>NodeOptions <span style="color:#f92672">&amp;</span> options);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">~</span>VelodyneDriver() <span style="color:#66d9ef">override</span>;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> poll();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pollThread</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// configuration parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">config_</span>;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>Input<span style="color:#f92672">&gt;</span> input_;
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>Publisher<span style="color:#f92672">&lt;</span>velodyne_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>VelodyneScan<span style="color:#f92672">&gt;::</span>SharedPtr output_;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> last_azimuth_;
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>}  <span style="color:#75715e">// namespace velodyne_driver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif  </span><span style="color:#75715e">// VELODYNE_DRIVER__DRIVER_HPP_
</span></span></span></code></pre></div><ul>
<li>velodyne sdk =&gt; ROS 2로의 데이터 형태 변환은 <code>std::thread</code> 통해 구현되어 있습니다. ROS 2와의 충돌을 막기 위해 소멸자에서 join하는 방식을 사용하였습니다.</li>
</ul>

<div class="notices note" ><p>사실 이렇게 하면 이벤트 발생 시 다시 deadlock 문제가 발생합니다. 저라면 일전의 callback group &amp; executor를 사용했을 것 같습니다.</p>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span> poll_thread_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// node 생성자에서 thread 시작
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VelodyneDriver<span style="color:#f92672">::</span>VelodyneDriver(<span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>NodeOptions <span style="color:#f92672">&amp;</span> options)
</span></span><span style="display:flex;"><span><span style="color:#f92672">:</span> rclcpp<span style="color:#f92672">::</span>Node(<span style="color:#e6db74">&#34;velodyne_driver_node&#34;</span>, options),
</span></span><span style="display:flex;"><span>  diagnostics_(<span style="color:#66d9ef">this</span>, <span style="color:#ae81ff">0.2</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  poll_thread_ <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span>(<span style="color:#f92672">&amp;</span>VelodyneDriver<span style="color:#f92672">::</span>pollThread, <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// thread 함수에서 무한 poll 호출
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> VelodyneDriver<span style="color:#f92672">::</span>pollThread()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>future_status status;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    poll();
</span></span><span style="display:flex;"><span>    status <span style="color:#f92672">=</span> future_.wait_for(std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>seconds(<span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (status <span style="color:#f92672">==</span> std<span style="color:#f92672">::</span>future_status<span style="color:#f92672">::</span>timeout);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// poll 함수가 마치 ROS 2 callback 처럼 동작
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> VelodyneDriver<span style="color:#f92672">::</span>poll()
</span></span></code></pre></div><ul>
<li>velodyne_driver =&gt; ROS 2로의 데이터 변환을 정리해보았습니다. (poll 함수의 내용입니다.)</li>
</ul>
<ol>
<li>velodyne driver 데이터를 std::unique_ptr<!-- raw HTML omitted --> input으로 파싱</li>
<li>input에서 config으로 데이터 변환</li>
<li>config_에서 std::unique_ptr&lt;velodyne_msgs::msg::VelodyneScan&gt; scan으로 데이터 변환</li>
<li>output_-&gt;publish(std::move(scan));</li>
</ol>

<div class="notices tip" ><p>⇒ 상당히 메모리 형변환이 잦은데 이전 코드에서의 레거시가 있는 것 같습니다.</p>
</div>

<ul>
<li>diagnostic_updater ⇒ 중간중간 보이는 diagnostic 관련 코드들은 ROS 2의 diagnostic_updater API로 device drivers의 여러 상태를 topic 형태로 publish할 수 있는 기능입니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>diagnostic_updater<span style="color:#f92672">::</span>Updater diagnostics_;
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>diagnostic_updater<span style="color:#f92672">::</span>TopicDiagnostic<span style="color:#f92672">&gt;</span> diag_topic_;
</span></span></code></pre></div><h3 id="velodyne_convert_node">velodyne_convert_node</h3>
<blockquote>
<p>rviz2에서 보았던 것처럼 제대로 된 Pointcloud topic을 위해서 velodyne_driver에서의 raw data들을 누적하고, 다시 sensor_msgs/msg/PointCloud2로 변환하는 작업이 필요합니다. velodyne_convert_node에서 이 내용이 구현되어 있습니다.</p>
</blockquote>
<p><img src="/kr/ros2_foxy/images17/velo1.png?height=300px" alt="velo1.png"></p>
<ul>
<li>velodyne_pointcloud package의 CMakeLists.txt에서 velodyne_convert_node의 코드를 확인할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>add_executable(velodyne_convert_node src<span style="color:#f92672">/</span>conversions<span style="color:#f92672">/</span>convert_node<span style="color:#f92672">.</span>cpp)
</span></span><span style="display:flex;"><span>ament_target_dependencies(velodyne_convert_node rclcpp)
</span></span><span style="display:flex;"><span>target_link_libraries(velodyne_convert_node convert)
</span></span><span style="display:flex;"><span>install(TARGETS velodyne_convert_node
</span></span><span style="display:flex;"><span>  DESTINATION lib<span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">$</span>{PROJECT_NAME}
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><ul>
<li>convert_node.cpp 자체는 단순 Node 생성 후 spin을 담고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span> argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Force flush of the stdout buffer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  setvbuf(stdout, <span style="color:#66d9ef">nullptr</span>, _IONBF, BUFSIZ);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>init(argc, argv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// handle callbacks until shut down
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  rclcpp<span style="color:#f92672">::</span>spin(
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>velodyne_pointcloud<span style="color:#f92672">::</span>Convert<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      rclcpp<span style="color:#f92672">::</span>NodeOptions()));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>shutdown();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Convert 클래스는 velodyne_msgs::msg::VelodyneScan topic을 subscribe하여 누적하고, sensor_msgs::msg::PointCloud2 topic으로 다시 publish합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> velodyne_pointcloud
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Convert</span> <span style="color:#66d9ef">final</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> rclcpp<span style="color:#f92672">::</span>Node
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">explicit</span> Convert(<span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>NodeOptions <span style="color:#f92672">&amp;</span> options);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> processScan(<span style="color:#66d9ef">const</span> velodyne_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>VelodyneScan<span style="color:#f92672">::</span>SharedPtr scanMsg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>velodyne_rawdata<span style="color:#f92672">::</span>RawData<span style="color:#f92672">&gt;</span> data_;
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>Subscription<span style="color:#f92672">&lt;</span>velodyne_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>VelodyneScan<span style="color:#f92672">&gt;::</span>SharedPtr velodyne_scan_;
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>Publisher<span style="color:#f92672">&lt;</span>sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>PointCloud2<span style="color:#f92672">&gt;::</span>SharedPtr output_;
</span></span><span style="display:flex;"><span>  tf2_ros<span style="color:#f92672">::</span>Buffer tf_buffer_;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>velodyne_rawdata<span style="color:#f92672">::</span>DataContainerBase<span style="color:#f92672">&gt;</span> container_ptr_;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>}  <span style="color:#75715e">// namespace velodyne_pointcloud
</span></span></span></code></pre></div><ul>
<li>velodyne_packets의 subscribe callback으로 processScan이 바인딩되어있으며, processScan에서는 일전 언급한 데이터 누적과 publish가 이루어집니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// subscribe to VelodyneScan packets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>velodyne_scan_ <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>create_subscription<span style="color:#f92672">&lt;</span>velodyne_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>VelodyneScan<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;velodyne_packets&#34;</span>, rclcpp<span style="color:#f92672">::</span>QoS(<span style="color:#ae81ff">10</span>),
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>bind(<span style="color:#f92672">&amp;</span>Convert<span style="color:#f92672">::</span>processScan, <span style="color:#66d9ef">this</span>, std<span style="color:#f92672">::</span>placeholders<span style="color:#f92672">::</span>_1));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> Convert<span style="color:#f92672">::</span>processScan(<span style="color:#66d9ef">const</span> velodyne_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>VelodyneScan<span style="color:#f92672">::</span>SharedPtr scanMsg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// allocate a point cloud with same time and frame ID as raw data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  container_ptr_<span style="color:#f92672">-&gt;</span>setup(scanMsg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// process each packet provided by the driver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (size_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> scanMsg<span style="color:#f92672">-&gt;</span>packets.size(); <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>    data_<span style="color:#f92672">-&gt;</span>unpack(scanMsg<span style="color:#f92672">-&gt;</span>packets[i], <span style="color:#f92672">*</span>container_ptr_);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// publish the accumulated cloud message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  diag_topic_<span style="color:#f92672">-&gt;</span>tick(scanMsg<span style="color:#f92672">-&gt;</span>header.stamp);
</span></span><span style="display:flex;"><span>  output_<span style="color:#f92672">-&gt;</span>publish(container_ptr_<span style="color:#f92672">-&gt;</span>finishCloud());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>velodyne_convert_node에서 tf2 데이터를 다루는 부분이 구현되어 있습니다. 하지만 편의를 위해 별도의 컨테이너를 만들고 구현은 추상화해둔 모습을 확인할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>tf2_ros<span style="color:#f92672">::</span>Buffer tf_buffer_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (organize_cloud) {
</span></span><span style="display:flex;"><span>  container_ptr_ <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>OrganizedCloudXYZIR<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>    min_range, max_range, target_frame, fixed_frame,
</span></span><span style="display:flex;"><span>    data_<span style="color:#f92672">-&gt;</span>numLasers(), data_<span style="color:#f92672">-&gt;</span>scansPerPacket(), tf_buffer_);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>  container_ptr_ <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>PointcloudXYZIR<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>    min_range, max_range, target_frame, fixed_frame,
</span></span><span style="display:flex;"><span>    data_<span style="color:#f92672">-&gt;</span>scansPerPacket(), tf_buffer_);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>DataContainerBase 클래스에서는 tf2 lookupTransform을 통해 scan data의 좌표를 미리 계산해둡니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>velodyne_rawdata<span style="color:#f92672">::</span>DataContainerBase<span style="color:#f92672">&gt;</span> container_ptr_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DataContainerBase</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> computeTransformation(<span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>Time <span style="color:#f92672">&amp;</span> time)
</span></span><span style="display:flex;"><span>	  {
</span></span><span style="display:flex;"><span>	    geometry_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>TransformStamped transform;
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>nanoseconds dur(time.nanoseconds());
</span></span><span style="display:flex;"><span>	      std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>time_point<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>system_clock, std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>nanoseconds<span style="color:#f92672">&gt;</span> time(dur);
</span></span><span style="display:flex;"><span>	      transform <span style="color:#f92672">=</span> tf_buffer_.lookupTransform(config_.target_frame, cloud.header.frame_id, time);
</span></span><span style="display:flex;"><span>	    } <span style="color:#66d9ef">catch</span> (tf2<span style="color:#f92672">::</span>LookupException <span style="color:#f92672">&amp;</span> e) {
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	    } <span style="color:#66d9ef">catch</span> (tf2<span style="color:#f92672">::</span>ExtrapolationException <span style="color:#f92672">&amp;</span> e) {
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    tf2<span style="color:#f92672">::</span>Quaternion quaternion(
</span></span><span style="display:flex;"><span>	      transform.transform.rotation.x,
</span></span><span style="display:flex;"><span>	      transform.transform.rotation.y,
</span></span><span style="display:flex;"><span>	      transform.transform.rotation.z,
</span></span><span style="display:flex;"><span>	      transform.transform.rotation.w);
</span></span><span style="display:flex;"><span>	    Eigen<span style="color:#f92672">::</span>Quaternionf rotation(quaternion.w(), quaternion.x(), quaternion.y(), quaternion.z());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    Eigen<span style="color:#f92672">::</span>Vector3f eigen_origin;
</span></span><span style="display:flex;"><span>	    tf2<span style="color:#f92672">::</span>Vector3 origin(
</span></span><span style="display:flex;"><span>	      transform.transform.translation.x,
</span></span><span style="display:flex;"><span>	      transform.transform.translation.y,
</span></span><span style="display:flex;"><span>	      transform.transform.translation.z);
</span></span><span style="display:flex;"><span>	    vectorTfToEigen(origin, eigen_origin);
</span></span><span style="display:flex;"><span>	    Eigen<span style="color:#f92672">::</span>Translation3f translation(eigen_origin);
</span></span><span style="display:flex;"><span>	    transformation <span style="color:#f92672">=</span> translation <span style="color:#f92672">*</span> rotation;
</span></span><span style="display:flex;"><span>	  }
</span></span></code></pre></div><h3 id="velodyne_laserscan_node">velodyne_laserscan_node</h3>
<blockquote>
<p>velodyne_laserscan_node는 sensor_msgs::msg::PointCloud2 data를 sensor_msgs::msg::LaserScan로 변환 후 /scan topic으로 publish 하는 node입니다. 3D pointcloud만 사용한다면 일반적으로 필요 없는 기능입니다.</p>
</blockquote>
<ul>
<li>클래스 header file을 통해 간단히 기능만 리뷰해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> velodyne_laserscan
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VelodyneLaserScan</span> <span style="color:#66d9ef">final</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> rclcpp<span style="color:#f92672">::</span>Node
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">explicit</span> VelodyneLaserScan(<span style="color:#66d9ef">const</span> rclcpp<span style="color:#f92672">::</span>NodeOptions <span style="color:#f92672">&amp;</span> options);
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> recvCallback(<span style="color:#66d9ef">const</span> sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>PointCloud2<span style="color:#f92672">::</span>SharedPtr msg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>Subscription<span style="color:#f92672">&lt;</span>sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>PointCloud2<span style="color:#f92672">&gt;::</span>SharedPtr sub_;
</span></span><span style="display:flex;"><span>  rclcpp<span style="color:#f92672">::</span>Publisher<span style="color:#f92672">&lt;</span>sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>LaserScan<span style="color:#f92672">&gt;::</span>SharedPtr pub_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uint16_t</span> ring_count_{<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> ring_;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">double</span> resolution_;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}  <span style="color:#75715e">// namespace velodyne_laserscan
</span></span></span></code></pre></div><ol>
<li>PointCloud2 topic을 subscribe 받고</li>
<li>이 데이터를 LaserScan으로 변환합니다. (subscribe callback)</li>
<li>마지막으로 변환된 데이터를 scan topic으로 다시 publish합니다.</li>
</ol>
<ul>
<li>코드를 분석하면서 보시다시피 모든 Node 구현은 Composition을 고려하여 만들어졌습니다. 따라서 CMakeLists.txt를 보면 아래와 같이 rclcpp_components_register_nodes 키워드들을 통해 같은 코드로 Composition을 생성할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>target_link_libraries(velodyne_driver velodyne_input)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># install runtime and library files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>install(TARGETS velodyne_driver
</span></span><span style="display:flex;"><span>  ARCHIVE DESTINATION lib
</span></span><span style="display:flex;"><span>  LIBRARY DESTINATION lib
</span></span><span style="display:flex;"><span>  RUNTIME DESTINATION bin
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rclcpp_components_register_nodes(velodyne_driver <span style="color:#e6db74">&#34;velodyne_driver::VelodyneDriver&#34;</span>)
</span></span></code></pre></div><h3 id="velodyne_msgs">velodyne_msgs</h3>
<blockquote>
<p>velodyne_msgs 패키지에는 VelodynePacket, VelodyneScan라는 두 종류의 custom message를 정의하고 있습니다. 이는 주로 velodyne 자체의 프로토콜 패킷을 다루기 위한 것으로 ROS 2 데이터 변환 시 중간 데이터 구조로 사용됩니다.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; VelodynePacket.msg
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Raw Velodyne LIDAR packet.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>builtin_interfaces/Time stamp              <span style="color:#75715e"># packet timestamp</span>
</span></span><span style="display:flex;"><span>uint8<span style="color:#f92672">[</span>1206<span style="color:#f92672">]</span> data        <span style="color:#75715e"># packet contents</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; VelodyneScan.msg
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Velodyne LIDAR scan packets.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std_msgs/Header header         <span style="color:#75715e"># standard ROS message header</span>
</span></span><span style="display:flex;"><span>VelodynePacket<span style="color:#f92672">[]</span> packets        <span style="color:#75715e"># vector of raw packets</span>
</span></span></code></pre></div><h2 id="orbbec-astra-camera-ros-2-패키지-분석">orbbec astra camera ROS 2 패키지 분석</h2>
<p><img src="/kr/ros2_foxy/images17/Untitled15.png?height=300px" alt="Untitled15.png"></p>
<p>이번 시간에는 Orbbec Astra+ Development Kit의 ROS 2 실행과 분석을 진행해보겠습니다. 실제 사용될 카메라와 코드이므로 좀 더 자세하게 분석해보려 합니다. 이전 센서 패키지들과 비교하면서 따라와 주세요!</p>
<h3 id="개발환경-설정">개발환경 설정</h3>
<ul>
<li>필요한 apt package들과 ROS 2 package들을 설치합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install libgflags-dev nlohmann-json3-dev
</span></span><span style="display:flex;"><span>sudo apt install ros-foxy-image-transport ros-foxy-image-publisher
</span></span></code></pre></div><ul>
<li>빌드 종속성인 glog을 설치합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget -c https://github.com/google/glog/archive/refs/tags/v0.6.0.tar.gz  -O glog-0.6.0.tar.gz
</span></span><span style="display:flex;"><span>tar -xzvf glog-0.6.0.tar.gz
</span></span><span style="display:flex;"><span>cd glog-0.6.0
</span></span><span style="display:flex;"><span>mkdir build <span style="color:#f92672">&amp;&amp;</span> cd build
</span></span><span style="display:flex;"><span>cmake .. <span style="color:#f92672">&amp;&amp;</span> make -j4
</span></span><span style="display:flex;"><span>sudo make install
</span></span><span style="display:flex;"><span>sudo ldconfig  <span style="color:#75715e"># Refreshing the link library</span>
</span></span></code></pre></div><ul>
<li>다음으로, 빌드 종속성인 magic_enum을 설치합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget -c https://github.com/Neargye/magic_enum/archive/refs/tags/v0.8.0.tar.gz -O  magic_enum-0.8.0.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tar -xzvf magic_enum-0.8.0.tar.gz
</span></span><span style="display:flex;"><span>cd magic_enum-0.8.0
</span></span><span style="display:flex;"><span>mkdir build <span style="color:#f92672">&amp;&amp;</span> cd build
</span></span><span style="display:flex;"><span>cmake .. <span style="color:#f92672">&amp;&amp;</span> make -j4
</span></span><span style="display:flex;"><span>sudo make install
</span></span><span style="display:flex;"><span>sudo ldconfig <span style="color:#75715e"># Refreshing the link library</span>
</span></span></code></pre></div><p>이번 실습을 위해 사용된 코드는 2022-07-15 버전 Orbbec SDK Beta for ROS입니다. ( 이후 업데이트 시 코드 변경이 있을 수 있어 명확히 명시하겠습니다. ⇒ <a href="https://orbbec3d.com/index/download.html">download link</a>)</p>
<p><img src="/kr/ros2_foxy/images17/Untitled16.png?height=300px" alt="Untitled16.png"></p>
<ul>
<li>다운로드 받은 source code를 원하는 workspace에 위치시킨 뒤, 개발문서에서 요구하는 usb rule 추가 작업을 진행합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd orbbec_camera/scripts
</span></span><span style="display:flex;"><span>sudo bash install.sh
</span></span><span style="display:flex;"><span>sudo udevadm control --reload-rules <span style="color:#f92672">&amp;&amp;</span> sudo udevadm trigger
</span></span></code></pre></div><ul>
<li>해당 작업 후 혹시 모를 오류를 방지하기 위해 재부팅을 권장드리며, 카메라를 연결한 뒤 장치 인식이 되는지 확인해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls /dev | grep Astra
</span></span><span style="display:flex;"><span>Astra+
</span></span><span style="display:flex;"><span>Astra+_rgb
</span></span></code></pre></div><ul>
<li>소스코드를 빌드하며, 공식 문서에서는 Release build를 제시하고 있어 그대로 진행해 보겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd ~/ros2_ws/src
</span></span><span style="display:flex;"><span>colcon build --event-handlers  console_direct+  --cmake-args  -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release
</span></span></code></pre></div>
<div class="notices note" ><p>빌드 중 오류가 발생했다면 패키지를 하나하나씩 빌드하며 원인을 분석해봅니다.</p>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>colcon build --packages-select orbbec_camera_msgs --event-handlers  console_direct+  --cmake-args  -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release
</span></span><span style="display:flex;"><span>source install/local_setup.bash
</span></span><span style="display:flex;"><span>colcon build --packages-select orbbec_camera --event-handlers  console_direct+  --cmake-args  -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release
</span></span><span style="display:flex;"><span>source install/local_setup.bash
</span></span></code></pre></div><h3 id="getting-started">Getting started</h3>
<blockquote>
<p>빌드가 완료되었다면 기본 예시를 사용해봅시다.</p>
</blockquote>
<ul>
<li>제공되는 초기 코드 parameter가 아닌, default parameter를 사용하겠습니다. launch file에서 아래와 같이 parameter를 설정을 제거하고 실행합시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> launch <span style="color:#f92672">import</span> LaunchDescription
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> launch_ros.actions <span style="color:#f92672">import</span> Node
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ament_index_python <span style="color:#f92672">import</span> get_package_share_directory
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_launch_description</span>():
</span></span><span style="display:flex;"><span>    ob_params_file <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>        get_package_share_directory(<span style="color:#e6db74">&#34;orbbec_camera&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/params/astra_plus_params.yaml&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> LaunchDescription(
</span></span><span style="display:flex;"><span>        [
</span></span><span style="display:flex;"><span>            Node(
</span></span><span style="display:flex;"><span>                package<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;orbbec_camera&#34;</span>,
</span></span><span style="display:flex;"><span>                namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;camera&#34;</span>,
</span></span><span style="display:flex;"><span>                name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;camera&#34;</span>,
</span></span><span style="display:flex;"><span>                executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;orbbec_camera_node&#34;</span>,
</span></span><span style="display:flex;"><span>                output<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;screen&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># parameters=[ob_params_file],</span>
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><ul>
<li>astra_plus.launch 예제를 실행해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cd <span style="color:#f92672">&lt;</span>my_ws<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>source install<span style="color:#f92672">/</span>local_setup<span style="color:#f92672">.</span>bash
</span></span><span style="display:flex;"><span>ros2 launch orbbec_camera astra_plus<span style="color:#f92672">.</span>launch<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>[orbbec_camera_node<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] [WARN] [<span style="color:#ae81ff">1683197732.405664220</span>] [camera<span style="color:#f92672">.</span>camera]: Using default profile instead<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>[orbbec_camera_node<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] [WARN] [<span style="color:#ae81ff">1683197732.405680938</span>] [camera<span style="color:#f92672">.</span>camera]: default FPS <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>[orbbec_camera_node<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] [INFO] [<span style="color:#ae81ff">1683197732.413525012</span>] [camera<span style="color:#f92672">.</span>camera]:  stream color <span style="color:#f92672">is</span> enabled <span style="color:#f92672">-</span> width: <span style="color:#ae81ff">2048</span>, height: <span style="color:#ae81ff">1536</span>, fps: <span style="color:#ae81ff">30</span>, Format: OB_FORMAT_MJPG
</span></span><span style="display:flex;"><span>[orbbec_camera_node<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] [WARN] [<span style="color:#ae81ff">1683197732.427355527</span>] [camera<span style="color:#f92672">.</span>camera]: Publishing dynamic camera transforms (<span style="color:#f92672">/</span>tf) at <span style="color:#ae81ff">10</span> Hz
</span></span></code></pre></div>
<div class="notices note" ><p>custom interface들을 사용하기 때문에 workspace sourcing이 반드시 필요합니다.</p>
</div>

<ul>
<li>publish되고 있는 topic들은 다음과 같습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ros2 topic list
</span></span><span style="display:flex;"><span>/camera/color/camera_info
</span></span><span style="display:flex;"><span>/camera/color/image_raw
</span></span><span style="display:flex;"><span>/camera/depth/camera_info
</span></span><span style="display:flex;"><span>/camera/depth/color/points
</span></span><span style="display:flex;"><span>/camera/depth/image_raw
</span></span><span style="display:flex;"><span>/camera/depth/points
</span></span><span style="display:flex;"><span>/camera/extrinsic/depth_to_color
</span></span><span style="display:flex;"><span>/camera/ir/camera_info
</span></span><span style="display:flex;"><span>/camera/ir/image_raw
</span></span><span style="display:flex;"><span>/clicked_point
</span></span><span style="display:flex;"><span>/goal_pose
</span></span><span style="display:flex;"><span>/initialpose
</span></span><span style="display:flex;"><span>/parameter_events
</span></span><span style="display:flex;"><span>/rosout
</span></span><span style="display:flex;"><span>/tf
</span></span><span style="display:flex;"><span>/tf_static
</span></span></code></pre></div><ul>
<li>특이한 점으로, 카메라 사이 좌표계 값을 depth_to_color라는 이름의 topic으로 publish하고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> ros2 topic echo <span style="color:#f92672">--</span>qos<span style="color:#f92672">-</span>durability<span style="color:#f92672">=</span>transient_local <span style="color:#f92672">/</span>camera<span style="color:#f92672">/</span>extrinsic<span style="color:#f92672">/</span>depth_to_color  <span style="color:#f92672">--</span>qos<span style="color:#f92672">-</span>profile<span style="color:#f92672">=</span>services_default
</span></span><span style="display:flex;"><span>header:
</span></span><span style="display:flex;"><span>  stamp:
</span></span><span style="display:flex;"><span>    sec: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    nanosec: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  frame_id: depth_to_color_extrinsics
</span></span><span style="display:flex;"><span>rotation:
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#ae81ff">0.9999811053276062</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.006122155115008354</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0005165112670511007</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#ae81ff">0.006124507170170546</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#ae81ff">0.9999702572822571</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#ae81ff">0.004682439845055342</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#ae81ff">0.0004878292966168374</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.004685514606535435</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#ae81ff">0.9999889135360718</span>
</span></span><span style="display:flex;"><span>translation:
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">25.19551658630371</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">0.30450138449668884</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#ae81ff">1.0939441919326782</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span></code></pre></div><ul>
<li>rviz2를 통해 데이터를 시각화해봅시다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled17.png?height=300px" alt="Untitled17.png"></p>

<div class="notices note" ><p>주의해야 할 점으로, pointcloud2 topic의 DDS QoS를 아래와 같이 잘 맞춰주어야 합니다.</p>
</div>

<p><img src="/kr/ros2_foxy/images17/Untitled18.png?height=200px" alt="Untitled18.png"></p>

<div class="notices note" ><p>더불어, color pointcloud2 topic의 색상을 확인하기 위해서는 rviz2 옵션을 아래와 같이 맞춰주어야 합니다.</p>
</div>

<p><img src="/kr/ros2_foxy/images17/Untitled19.png?height=200px" alt="Untitled19.png"></p>
<blockquote>
<p>혹은, 제가 제공드리는 rviz파일을 사용하여 configuration 하셔도 좋습니다. ⇒ <a href="https://drive.google.com/file/d/1heFUJDr7Q2N9jWhP_jYCV9EG_KTUjiQq/view?usp=sharing">astra rviz download</a></p>
</blockquote>
<ul>
<li>카메라 센서인 만큼 tf2를 다룰 시 조심해야 할 부분이 있습니다. tf2 tree는 다음과 같습니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled20.png?height=300px" alt="Untitled20.png"></p>
<ul>
<li>rviz2를 통해 확인해보면, optical frame들은 회전된 camera 좌표 체계를 갖는 것을 확인 가능합니다.</li>
</ul>
<p><img src="/kr/ros2_foxy/images17/Untitled21.png?height=300px" alt="Untitled21.png"></p>
<ul>
<li>마지막으로, astra node의 parameter들을 조회해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ros2 param list
</span></span><span style="display:flex;"><span>/camera/camera:
</span></span><span style="display:flex;"><span>  camera_link_frame_id
</span></span><span style="display:flex;"><span>  color_format
</span></span><span style="display:flex;"><span>  color_fps
</span></span><span style="display:flex;"><span>  color_frame_id
</span></span><span style="display:flex;"><span>  color_height
</span></span><span style="display:flex;"><span>  color_optical_frame_id
</span></span><span style="display:flex;"><span>  color_width
</span></span><span style="display:flex;"><span>  d2c_mode
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ros2 param get /camera/camera color_format
</span></span><span style="display:flex;"><span>String value is: YUYV
</span></span></code></pre></div><blockquote>
<p>해당 parameter들에 따라 코드 실행에 어떤 변화가 있는지 분석을 통해 살펴보겠습니다.</p>
</blockquote>
<h3 id="코드-분석-1">코드 분석</h3>
<ul>
<li>launch file을 통해 확인했던 orbbec_camera_node가 어떻게 생성되었는지 추적해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Node(
</span></span><span style="display:flex;"><span>    package<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;orbbec_camera&#34;</span>,
</span></span><span style="display:flex;"><span>    namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;camera&#34;</span>,
</span></span><span style="display:flex;"><span>    name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;camera&#34;</span>,
</span></span><span style="display:flex;"><span>    executable<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;orbbec_camera_node&#34;</span>,
</span></span><span style="display:flex;"><span>    output<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;screen&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># parameters=[ob_params_file],</span>
</span></span><span style="display:flex;"><span>),
</span></span></code></pre></div><ul>
<li>CMakeLists.txt를 살펴보면 rclcpp_components_register_node를 통해 생성되는 orbbec_camera_node를 확인할 수 있습니다. (component와 executable을 모두 빌드하기 위함입니다.)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ament_target_dependencies<span style="color:#f92672">(</span><span style="color:#e6db74">${</span>PROJECT_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">${</span>dependencies<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>rclcpp_components_register_node<span style="color:#f92672">(</span><span style="color:#e6db74">${</span>PROJECT_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>  PLUGIN <span style="color:#e6db74">&#34;orbbec_camera::OBCameraNodeFactory&#34;</span>
</span></span><span style="display:flex;"><span>  EXECUTABLE orbbec_camera_node
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><ul>
<li>orbbec_camera_node을 구성하는 코드들은 다음과 같습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>add_library<span style="color:#f92672">(</span><span style="color:#e6db74">${</span>PROJECT_NAME<span style="color:#e6db74">}</span> SHARED
</span></span><span style="display:flex;"><span>  src/dynamic_params.cpp
</span></span><span style="display:flex;"><span>  src/ob_camera_node_factory.cpp
</span></span><span style="display:flex;"><span>  src/ob_camera_node.cpp
</span></span><span style="display:flex;"><span>  src/ros_param_backend.cpp
</span></span><span style="display:flex;"><span>  src/ros_service.cpp
</span></span><span style="display:flex;"><span>  src/utils.cpp
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><ul>
<li>File별 기능을 분석하면 다음과 같습니다.</li>
</ul>
<table>
<thead>
<tr>
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ros_param_backend</td>
<td>parameter 변경 시 특정 callback이 실행되도록 binding 해주는 decorator입니다.</td>
</tr>
<tr>
<td>dynamic_params</td>
<td>ROS 2에서 제공되는 기본적인 set_parameter와 유사한 역할을 수행하는 각종 setParameter API들을 구현한 부분입니다. (아마도 별도의 parameter 변경 reject 로직을 구현하고 싶었던 것 같습니다.)</td>
</tr>
<tr>
<td>ob_camera_node</td>
<td>일반적인 ROS 2 Node의 로직과, orbbec sdk의 pipeline을 융합하여 구현한 코드입니다. 실질적인 topic publish, service server들이 구현되어 있습니다.</td>
</tr>
<tr>
<td>ros_service</td>
<td>service server들에 대한 cpp 구현을 별도로 분리한 코드입니다.</td>
</tr>
<tr>
<td>ob_camera_node_factory</td>
<td>ob_camera_node에서 구현한 OBCameraNode node를 포인터로 갖는 별도의 Component를 구현하였습니다. (이 부분은 ROS 2 구현 측면에서 다소 미숙한 부분이라고 볼 수 있습니다.)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>주요 구현은 ob_camera_node에 작성되어 있습니다. 해당 파일 내 메소드들을 호출 계층 구조에 따라 정리하면 아래와 같습니다.</p>
</blockquote>
<ul>
<li>
<p>ob_camera_node</p>
<ul>
<li>Constructor
<ul>
<li>setupTopics
<ul>
<li>getParameters</li>
<li>setupDevices</li>
<li>setupProfiles</li>
<li>setupDefaultStreamCalibData
<ul>
<li>findDefaultCameraParam</li>
<li>updateStreamCalibData</li>
</ul>
</li>
<li>setupCameraCtrlServices</li>
<li>setupPublishers</li>
<li>publishStaticTransforms</li>
</ul>
</li>
<li>startPipeline
<ul>
<li>ob::Pipeline 실행</li>
<li>frameSetCallback
<ul>
<li>publishColorFrame</li>
<li>publishDepthFrame</li>
<li>publishIRFrame</li>
<li>publishPointCloud
<ul>
<li>publishColorPointCloud</li>
<li>publishDepthPointCloud</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>setupTopics에서 호출되는 함수들은 다음과 같은 역할을 갖습니다.</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>getParameters</td>
<td>dynamic_params에 구현된 setParam를 사용하여 각종 매개변수들을 파싱하고, 세팅합니다.</td>
</tr>
<tr>
<td>setupDevices</td>
<td>orbbec sdk를 사용하여 camera profile, stream data등에 대한 정보를 조회하고 저장합니다.</td>
</tr>
<tr>
<td>setupProfiles</td>
<td>getParameters와 setupDevices에서 얻은 정보를 바탕으로 orbbec 카메라를 셋업합니다. d2c_mode등 orbbec만의 고유 설정들을 셋업하는 코드가 구현되어 있습니다.</td>
</tr>
<tr>
<td>setupDefaultStreamCalibData</td>
<td>내부적으로 findDefaultCameraParam / updateStreamCalibData라는 메소드를 호출하며, 카메라 calibration data를 받아 셋업하는 부분입니다.</td>
</tr>
<tr>
<td>setupCameraCtrlServices</td>
<td>topic이 아닌 service server들에 대한 선언과 callback mapping들이 이루어집니다.</td>
</tr>
<tr>
<td>setupPublishers</td>
<td>depth/color/points, depth/points, camera_info, extrinsic/depth_to_color, image_raw 등의 topic publisher들이 선언되고 세팅됩니다.</td>
</tr>
<tr>
<td>publishStaticTransforms</td>
<td>dynamic<em>tf_broadcaster</em>와 static<em>tf_broadcaster</em>라는 두개의 tf2 broadcast가 구현되어 있습니다. dynamic<em>tf_broadcaster</em>의 경우 publishDynamicTransforms라는 메소드를 별도 thread로 실행합니다. (하지만 실제 카메라 내부에서 동적으로 변화하는 tf2는 없습니다.)</td>
</tr>
</tbody>
</table>
<ul>
<li>대부분 설정과 관련된 구현이지만, ROS 2 구현 측면에서 setupPublishers를 살펴보겠습니다.</li>
</ul>
<p>QoS profile을 적용한 topic publisher들과 tf broadcaster가 생성되고 있습니다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>setupPublishers() {
</span></span><span style="display:flex;"><span>  static_tf_broadcaster_ <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>tf2_ros<span style="color:#f92672">::</span>StaticTransformBroadcaster<span style="color:#f92672">&gt;</span>(node_);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">using</span> PointCloud2 <span style="color:#f92672">=</span> sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>PointCloud2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">using</span> CameraInfo <span style="color:#f92672">=</span> sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>CameraInfo;
</span></span><span style="display:flex;"><span>  point_cloud_publisher_ <span style="color:#f92672">=</span> node_<span style="color:#f92672">-&gt;</span>create_publisher<span style="color:#f92672">&lt;</span>PointCloud2<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;depth/color/points&#34;</span>, rclcpp<span style="color:#f92672">::</span>QoS{<span style="color:#ae81ff">1</span>}.best_effort().keep_last(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>  depth_point_cloud_publisher_ <span style="color:#f92672">=</span> node_<span style="color:#f92672">-&gt;</span>create_publisher<span style="color:#f92672">&lt;</span>PointCloud2<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;depth/points&#34;</span>, rclcpp<span style="color:#f92672">::</span>QoS{<span style="color:#ae81ff">1</span>}.best_effort().keep_last(<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> stream_index : IMAGE_STREAMS) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string name <span style="color:#f92672">=</span> stream_name_[stream_index.first];
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string topic <span style="color:#f92672">=</span> name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/image_raw&#34;</span>;
</span></span><span style="display:flex;"><span>    image_publishers_[stream_index] <span style="color:#f92672">=</span> image_transport<span style="color:#f92672">::</span>create_publisher(node_, topic);
</span></span><span style="display:flex;"><span>    topic <span style="color:#f92672">=</span> name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/camera_info&#34;</span>;
</span></span><span style="display:flex;"><span>    camera_info_publishers_[stream_index] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        node_<span style="color:#f92672">-&gt;</span>create_publisher<span style="color:#f92672">&lt;</span>CameraInfo<span style="color:#f92672">&gt;</span>(topic, rclcpp<span style="color:#f92672">::</span>QoS{<span style="color:#ae81ff">1</span>}.best_effort());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  extrinsics_publisher_ <span style="color:#f92672">=</span> node_<span style="color:#f92672">-&gt;</span>create_publisher<span style="color:#f92672">&lt;</span>orbbec_camera_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Extrinsics<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;extrinsic/depth_to_color&#34;</span>, rclcpp<span style="color:#f92672">::</span>QoS{<span style="color:#ae81ff">1</span>}.transient_local());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>publishStaticTransforms 메소드는 다음과 같습니다. dynamic transform이라는 구현이 보이는데, 사실 카메라 내부적으로는 움직이는 부분이 없습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>publishStaticTransforms() {
</span></span><span style="display:flex;"><span>  calcAndPublishStaticTransform();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (tf_publish_rate_ <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    tf_thread_ <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_shared<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span><span style="color:#66d9ef">thread</span><span style="color:#f92672">&gt;</span>([<span style="color:#66d9ef">this</span>]() { publishDynamicTransforms(); });
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    static_tf_broadcaster_<span style="color:#f92672">-&gt;</span>sendTransform(static_tf_msgs_);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>코드 확인 결과, transform의 의미보다 시간 동기화를 위해 구현해둔 것으로 보입니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>publishDynamicTransforms() {
</span></span><span style="display:flex;"><span>  RCLCPP_WARN(logger_, <span style="color:#e6db74">&#34;Publishing dynamic camera transforms (/tf) at %g Hz&#34;</span>, tf_publish_rate_);
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>mutex mu;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>unique_lock<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>mutex<span style="color:#f92672">&gt;</span> lock(mu);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (rclcpp<span style="color:#f92672">::</span>ok() <span style="color:#f92672">&amp;&amp;</span> is_running_) {
</span></span><span style="display:flex;"><span>    tf_cv_.wait_for(lock, std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>milliseconds((<span style="color:#66d9ef">int</span>)(<span style="color:#ae81ff">1000.0</span> <span style="color:#f92672">/</span> tf_publish_rate_)),
</span></span><span style="display:flex;"><span>                    [<span style="color:#66d9ef">this</span>] { <span style="color:#66d9ef">return</span> (<span style="color:#f92672">!</span>(is_running_)); });
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      rclcpp<span style="color:#f92672">::</span>Time t <span style="color:#f92672">=</span> node_<span style="color:#f92672">-&gt;</span>now();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> msg : static_tf_msgs_) {
</span></span><span style="display:flex;"><span>        msg.header.stamp <span style="color:#f92672">=</span> t;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      dynamic_tf_broadcaster_<span style="color:#f92672">-&gt;</span>sendTransform(static_tf_msgs_);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>startPipeline에서 호출되는 함수들은 다음과 같은 역할을 갖습니다.</li>
</ul>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ob::Pipeline 실행</td>
<td>orbbec sdk로부터 pipeline을 다루는 핸들러를 받아 image stream을 시작합니다.</td>
</tr>
<tr>
<td>frameSetCallback</td>
<td>setupPublishers에서 설정한 각종 topic publisher들이 실질적인 topic publish를 수행하는 부분입니다.</td>
</tr>
</tbody>
</table>
<ul>
<li>코드를 확인해보면, orbbec SDK의 pipeline을 실행한 뒤, frame callback과 binding하고 있는 모습을 확인 가능합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>startPipeline() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (pipeline_ <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>    pipeline_.reset();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  pipeline_ <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>Pipeline<span style="color:#f92672">&gt;</span>(device_);
</span></span><span style="display:flex;"><span>  pipeline_<span style="color:#f92672">-&gt;</span>start(config_, [<span style="color:#66d9ef">this</span>](std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>FrameSet<span style="color:#f92672">&gt;</span> frame_set) {
</span></span><span style="display:flex;"><span>    frameSetCallback(std<span style="color:#f92672">::</span>move(frame_set));
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>frame이 갱신될 떄마다 실행되는 frameSetCallback에서는 갱신된 이미지 데이터를 사용하여 각종 topic publish를 진행합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>frameSetCallback(std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>FrameSet<span style="color:#f92672">&gt;</span> frame_set) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> color_frame <span style="color:#f92672">=</span> frame_set<span style="color:#f92672">-&gt;</span>colorFrame();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> depth_frame <span style="color:#f92672">=</span> frame_set<span style="color:#f92672">-&gt;</span>depthFrame();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> ir_frame <span style="color:#f92672">=</span> frame_set<span style="color:#f92672">-&gt;</span>irFrame();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (color_frame <span style="color:#f92672">&amp;&amp;</span> enable_[COLOR]) {
</span></span><span style="display:flex;"><span>    publishColorFrame(color_frame);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (depth_frame <span style="color:#f92672">&amp;&amp;</span> enable_[DEPTH]) {
</span></span><span style="display:flex;"><span>    publishDepthFrame(depth_frame);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ir_frame <span style="color:#f92672">&amp;&amp;</span> enable_[INFRA0]) {
</span></span><span style="display:flex;"><span>    publishIRFrame(ir_frame);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  publishPointCloud(frame_set);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>publishColorFrame / publishDepthFrame / publishIRFrame에서는 cv::Mat 형식의 데이터를 ROS 2 Image msg로 변환하여 publish하고 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>publishColorFrame(std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>ColorFrame<span style="color:#f92672">&gt;</span> frame) {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  sensor_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Image<span style="color:#f92672">::</span>SharedPtr img;
</span></span><span style="display:flex;"><span>  img <span style="color:#f92672">=</span> cv_bridge<span style="color:#f92672">::</span>CvImage(std_msgs<span style="color:#f92672">::</span>msg<span style="color:#f92672">::</span>Header(), encoding_.at(stream), image).toImageMsg();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  img<span style="color:#f92672">-&gt;</span>width <span style="color:#f92672">=</span> width;
</span></span><span style="display:flex;"><span>  img<span style="color:#f92672">-&gt;</span>height <span style="color:#f92672">=</span> height;
</span></span><span style="display:flex;"><span>  img<span style="color:#f92672">-&gt;</span>is_bigendian <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>  img<span style="color:#f92672">-&gt;</span>step <span style="color:#f92672">=</span> width <span style="color:#f92672">*</span> unit_step_size_[stream];
</span></span><span style="display:flex;"><span>  img<span style="color:#f92672">-&gt;</span>header.frame_id <span style="color:#f92672">=</span> optical_frame_id_[COLOR];
</span></span><span style="display:flex;"><span>  img<span style="color:#f92672">-&gt;</span>header.stamp <span style="color:#f92672">=</span> timestamp;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> image_publisher <span style="color:#f92672">=</span> image_publishers_.at(stream);
</span></span><span style="display:flex;"><span>  image_publisher.publish(img);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>publishPointCloud에서는 특정 조건에 따라 color pointcloud, depth point cloud를 준비시킵니다. 이 부분 때문에 parameter설정이 중요합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>publishPointCloud(std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>FrameSet<span style="color:#f92672">&gt;</span> frame_set) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (align_depth_ <span style="color:#f92672">&amp;&amp;</span> (format_[COLOR] <span style="color:#f92672">==</span> OB_FORMAT_YUYV <span style="color:#f92672">||</span> format_[COLOR] <span style="color:#f92672">==</span> OB_FORMAT_I420)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (frame_set<span style="color:#f92672">-&gt;</span>depthFrame() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span> <span style="color:#f92672">&amp;&amp;</span> frame_set<span style="color:#f92672">-&gt;</span>colorFrame() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>        publishColorPointCloud(frame_set);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (frame_set<span style="color:#f92672">-&gt;</span>depthFrame() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>      publishDepthPointCloud(frame_set);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><ul>
<li>pointcloud를 publish하는 로직을 살펴보면 공통적으로 아래와 같은 iterator 구현을 확인할 수 있습니다. 이는 ROS 2의 PointCloud2 type에서 제공하는 API로 손쉽게 각 point data를 append 할 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  sensor_msgs<span style="color:#f92672">::</span>PointCloud2Iterator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> iter_x(point_cloud_msg_, <span style="color:#e6db74">&#34;x&#34;</span>);
</span></span><span style="display:flex;"><span>  sensor_msgs<span style="color:#f92672">::</span>PointCloud2Iterator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> iter_y(point_cloud_msg_, <span style="color:#e6db74">&#34;y&#34;</span>);
</span></span><span style="display:flex;"><span>  sensor_msgs<span style="color:#f92672">::</span>PointCloud2Iterator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> iter_z(point_cloud_msg_, <span style="color:#e6db74">&#34;z&#34;</span>);
</span></span><span style="display:flex;"><span>  size_t valid_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (size_t point_idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; point_idx <span style="color:#f92672">&lt;</span> point_size; point_idx<span style="color:#f92672">++</span>, points<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">valid_pixel</span>(points<span style="color:#f92672">-&gt;</span>z <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (valid_pixel) {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>iter_x <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span>(points<span style="color:#f92672">-&gt;</span>x <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000.0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>iter_y <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span>(points<span style="color:#f92672">-&gt;</span>y <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000.0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>iter_z <span style="color:#f92672">=</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span>(points<span style="color:#f92672">-&gt;</span>z <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000.0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">++</span>iter_x;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">++</span>iter_y;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">++</span>iter_z;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">++</span>valid_count;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><ul>
<li>마지막으로 ros_service.cpp 코드에는 각종 설정을 service로 제어할 수 있는 로직이 구현되어 있습니다. 자세한 내용을 살펴보지는 않겠지만, service server를 설정하고 binding되는 callback을 구현하는 부분이 반복됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>service_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;set_&#34;</span> <span style="color:#f92672">+</span> stream_name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_exposure&#34;</span>;
</span></span><span style="display:flex;"><span>set_exposure_srv_[stream_index] <span style="color:#f92672">=</span> node_<span style="color:#f92672">-&gt;</span>create_service<span style="color:#f92672">&lt;</span>SetInt32<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>    service_name,
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">this</span>, stream_index <span style="color:#f92672">=</span> stream_index](<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>SetInt32<span style="color:#f92672">::</span>Request<span style="color:#f92672">&gt;</span> request,
</span></span><span style="display:flex;"><span>                                        std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>SetInt32<span style="color:#f92672">::</span>Response<span style="color:#f92672">&gt;</span> response) {
</span></span><span style="display:flex;"><span>      setExposureCallback(request, response, stream_index);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> OBCameraNode<span style="color:#f92672">::</span>setExposureCallback(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>SetInt32<span style="color:#f92672">::</span>Request<span style="color:#f92672">&gt;&amp;</span> request,
</span></span><span style="display:flex;"><span>                                       std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>SetInt32<span style="color:#f92672">::</span>Response<span style="color:#f92672">&gt;&amp;</span> response,
</span></span><span style="display:flex;"><span>                                       <span style="color:#66d9ef">const</span> stream_index_pair<span style="color:#f92672">&amp;</span> stream_index) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> stream <span style="color:#f92672">=</span> stream_index.first;
</span></span><span style="display:flex;"><span>  ...
</span></span></code></pre></div><ul>
<li>OBCameraNodeFactory는 OBCameraNode, ob::Device, ob::DeviceInfo 인스턴스를 스마트 포인터로 포함하고 있습니다. 대부분의 구현들도 해당 스마트 포인터 내부의 메소드를 호출하는 식으로 구성됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDevice</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getDevice</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>DeviceList<span style="color:#f92672">&gt;&amp;</span> list);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">updateDeviceInfo</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deviceConnectCallback</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>DeviceList<span style="color:#f92672">&gt;&amp;</span> device_list);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deviceDisconnectCallback</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>DeviceList<span style="color:#f92672">&gt;&amp;</span> device_list);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printDeviceInfo</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>DeviceInfo<span style="color:#f92672">&gt;&amp;</span> device_info);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>OBCameraNode<span style="color:#f92672">&gt;</span> ob_camera_node_;
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>Device<span style="color:#f92672">&gt;</span> device_;
</span></span><span style="display:flex;"><span>std<span style="color:#f92672">::</span>shared_ptr<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>DeviceInfo<span style="color:#f92672">&gt;</span> device_info_;
</span></span></code></pre></div>
<div class="notices note" ><p>이 부분은 구조적으로 다소 비효율적이라고 생각합니다. orbbec 관련 인스턴스를 클래스 변수로 갖는 것은 이해가 되지만, 저라면 Node를 스마트 포인터로 갖지 않고, Composition 형태로 바로 구현했을 것 같습니다.</p>
</div>

<blockquote>
<p>orbbec astra plus model의 ROS 2 패키지 분석을 끝으로 모든 예시 분석을 마쳤습니다. 실제 ROS 2 package 개발에 대한 안목이 생기셨으리라 생각합니다.</p>
</blockquote>
<h2 id="orbbec-gemini-2-ros-2-패키지-분석">orbbec gemini 2 ROS 2 패키지 분석</h2>
<blockquote>
<p>이번에는 Orbbec의 또다른 rgbd camera인 Gemini 2를 ROS 2 연동해보겠습니다.</p>
</blockquote>

<div class="notices note" ><p>일전 Astra Plus를 분석하며 종속성 설치 등 많은 부분을 이미 해두었으므로 중복되는 설정은 제외하였습니다.</p>
</div>

<p><img src="/kr/ros2_foxy/images17/Untitled22.png?height=400px" alt="Untitled22.png"></p>
<ul>
<li>Astra Plus package와 Gemini 2 package의 이름이 동일합니다! 따라서 새로운 Workspace를 생성한 뒤 별도 빌드를 해주겠습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>cd <span style="color:#f92672">~/</span>
</span></span><span style="display:flex;"><span>mkdir <span style="color:#f92672">-</span>p gemini_ws<span style="color:#f92672">/</span>src
</span></span><span style="display:flex;"><span>cd <span style="color:#f92672">~/</span>gemini_ws
</span></span><span style="display:flex;"><span>colon build
</span></span></code></pre></div>
<div class="notices note" ><p>만약 두 package를 같은 workspace에서 사용하고 싶다면 소스코드에서 패키지 이름을 모조리 찾아내 변경하면 됩니다.</p>
</div>

<ul>
<li>Gemini2의 인식을 위해 udev-rules를 다시 수정해야 합니다. udev-rules에 대한 설명은 <a href="https://chhanz.github.io/linux/2022/09/19/udev-rule/">링크</a>로 대체하겠으며, 여러분들께서는 하단 터미널 명령어를 따라하시기만 하면 됩니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>cd <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>udev<span style="color:#f92672">/</span>rules.d
</span></span><span style="display:flex;"><span>sudo rm <span style="color:#f92672">-</span>rf <span style="color:#ae81ff">99</span><span style="color:#f92672">-</span>obsensor<span style="color:#f92672">-</span>libusb.rules
</span></span></code></pre></div><ul>
<li>이제 새로운 udev-rules를 추가해야 합니다. 하지만 Orbbec에서 제공하는 rule이 적절치 않아 이번 예시를 위해 일부 제가 수정하였습니다. ⇒ <code>OrbbecSDK_ROS2/orbbec_camera/scripts99-obsensor-libusb.rules</code> 수정</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span># UVC Modules
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>SUBSYSTEMS==&#34;usb&#34;, ATTRS{idVendor}==&#34;2bc5&#34;, ATTRS{idProduct}==&#34;0670&#34;, MODE:=&#34;0666&#34;,  OWNER:=&#34;root&#34;, GROUP:=&#34;video&#34;, SYMLINK+=&#34;orbbec_gemini_2&#34;
</span></span></code></pre></div><ul>
<li>새로운 rule을 로컬 환경에 적용합시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>cd <span style="color:#f92672">&lt;your-ws&gt;</span>/OrbbecSDK_ROS2/orbbec_camera/scripts
</span></span><span style="display:flex;"><span>sudo bash install.sh
</span></span><span style="display:flex;"><span>sudo udevadm control --reload-rules <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span> sudo udevadm trigger
</span></span></code></pre></div><ul>
<li>이제 Gemini2를 연결하면 아래와 같이 인식되는 모습을 볼 수 있습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>cd <span style="color:#f92672">/</span>dev
</span></span><span style="display:flex;"><span>ls <span style="color:#f92672">|</span> grep gem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;</span> result
</span></span><span style="display:flex;"><span>orbbec_gemini_2
</span></span></code></pre></div><ul>
<li>예시 실행 전, color point cloud를 보고 싶다면 <code>gemini2.launch.xml</code> 파일의 parameter를 아래와 같이 수정해야 합니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;launch&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- unique camera name--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;camera_name&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;camera&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- Hardware depth registration --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;depth_registration&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;serial_number&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;device_num&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;vendor_id&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;0x2bc5&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;product_id&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;enable_point_cloud&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- from --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- &lt;arg name=&#34;enable_colored_point_cloud&#34; default=&#34;false&#34;/&gt; --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- to --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;enable_colored_point_cloud&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;True&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;point_cloud_qos&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;default&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span></code></pre></div><ul>
<li>패키지를 빌드하고 소싱합시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>colcon build <span style="color:#f92672">--</span>event<span style="color:#f92672">-</span>handlers  console_direct<span style="color:#f92672">+</span>  <span style="color:#f92672">--</span>cmake<span style="color:#f92672">-</span>args  <span style="color:#f92672">-</span>DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>Release
</span></span><span style="display:flex;"><span>source install<span style="color:#f92672">/</span>local_setup.bash
</span></span></code></pre></div><ul>
<li>gemini2 launch를 실행하고, rviz2로 시각화해봅시다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span># Terminal 1
</span></span><span style="display:flex;"><span>ros2 launch orbbec_camera gemini2.launch.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Terminal 2
</span></span><span style="display:flex;"><span>rviz2
</span></span></code></pre></div><blockquote>
<p>여러분들이 직접 rviz2 구성을 해보셔도 좋고, 제가 제공드리는 파일을 사용하셔도 됩니다!</p>
</blockquote>
<p>📁<a href="https://drive.google.com/file/d/1XA9re1yk86zNvH3NNx1boL68eAVhVWom/view?usp=share_link">gemini2.rviz</a></p>
<p><img src="/kr/ros2_foxy/images17/Untitled23.png?height=400px" alt="Untitled23.png"></p>

<div class="notices note" ><p>노트북, Edge Device 사용 시, color point cloud 시각화를 실행하면 급격히 성능이 저하될 수 있습니다. (우측 하단 frame rate를 확인해보세요!)</p>
</div>

<p><img src="/kr/ros2_foxy/images17/Untitled24.png?height=500px" alt="Untitled24.png"></p>
<ul>
<li>예제 실행 시 동작하는 topic list, tf2 tree는 다음과 같습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> ros2 topic list
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>color<span style="color:#f92672">/</span>camera_info
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>color<span style="color:#f92672">/</span>image_raw
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>depth<span style="color:#f92672">/</span>camera_info
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>depth<span style="color:#f92672">/</span>color<span style="color:#f92672">/</span>points
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>depth<span style="color:#f92672">/</span>image_raw
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>depth<span style="color:#f92672">/</span>points
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>ir<span style="color:#f92672">/</span>camera_info
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>ir<span style="color:#f92672">/</span>image_raw
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>parameter_events
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>rosout
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>tf
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>tf_static
</span></span></code></pre></div><p><img src="/kr/ros2_foxy/images17/Untitled25.png?height=300px" alt="Untitled25.png"></p>

<div class="notices note" ><p>IMU에 대한 tf2와 topic이 없는 점은 많이 아쉽습니다.</p>
</div>

<ul>
<li>혹시나 parameter로 IMU on/off를 제어하는가 싶었지만 param list 결과 없었습니다.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> ros2 param list
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>camera:
</span></span><span style="display:flex;"><span>  camera_link_frame_id
</span></span><span style="display:flex;"><span>  color_camera_info_qos
</span></span><span style="display:flex;"><span>  color_format
</span></span><span style="display:flex;"><span>  color_fps
</span></span><span style="display:flex;"><span>  color_frame_id
</span></span><span style="display:flex;"><span>  color_height
</span></span><span style="display:flex;"><span>  color_info_url
</span></span><span style="display:flex;"><span>  color_optical_frame_id
</span></span><span style="display:flex;"><span>  color_qos
</span></span><span style="display:flex;"><span>  color_width
</span></span><span style="display:flex;"><span>  depth_camera_info_qos
</span></span><span style="display:flex;"><span>  depth_format
</span></span><span style="display:flex;"><span>  depth_fps
</span></span><span style="display:flex;"><span>  depth_frame_id
</span></span><span style="display:flex;"><span>  depth_height
</span></span><span style="display:flex;"><span>  depth_optical_frame_id
</span></span><span style="display:flex;"><span>  depth_qos
</span></span><span style="display:flex;"><span>  depth_registration
</span></span><span style="display:flex;"><span>  depth_width
</span></span><span style="display:flex;"><span>  device_num
</span></span><span style="display:flex;"><span>  enable_color
</span></span><span style="display:flex;"><span>  enable_colored_point_cloud
</span></span><span style="display:flex;"><span>  enable_depth
</span></span><span style="display:flex;"><span>  enable_ir
</span></span><span style="display:flex;"><span>  enable_point_cloud
</span></span><span style="display:flex;"><span>  enable_publish_extrinsic
</span></span><span style="display:flex;"><span>  ir_camera_info_qos
</span></span><span style="display:flex;"><span>  ir_format
</span></span><span style="display:flex;"><span>  ir_fps
</span></span><span style="display:flex;"><span>  ir_frame_id
</span></span><span style="display:flex;"><span>  ir_height
</span></span><span style="display:flex;"><span>  ir_info_url
</span></span><span style="display:flex;"><span>  ir_optical_frame_id
</span></span><span style="display:flex;"><span>  ir_qos
</span></span><span style="display:flex;"><span>  ir_width
</span></span><span style="display:flex;"><span>  log_level
</span></span><span style="display:flex;"><span>  point_cloud_qos
</span></span><span style="display:flex;"><span>  publish_tf
</span></span><span style="display:flex;"><span>  serial_number
</span></span><span style="display:flex;"><span>  tf_publish_rate
</span></span><span style="display:flex;"><span>  use_sim_time
</span></span></code></pre></div><h3 id="코드-분석-2">코드 분석</h3>
<blockquote>
<p>코드 분석에 앞서, launch file을 먼저 언급하자면, 일전 astra plus package와 두드러진 차이를 보이고 있습니다. 이러한 xml 문법은 ROS 1 시절 사용되었던 문법으로 사실 자주 사용되지는 않습니다.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;launch&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">&lt;!-- unique camera name--&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;arg</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;camera_name&#34;</span> <span style="color:#a6e22e">default=</span><span style="color:#e6db74">&#34;camera&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;group&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;node</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;camera&#34;</span> <span style="color:#a6e22e">pkg=</span><span style="color:#e6db74">&#34;orbbec_camera&#34;</span> <span style="color:#a6e22e">exec=</span><span style="color:#e6db74">&#34;orbbec_camera_node&#34;</span> <span style="color:#a6e22e">output=</span><span style="color:#e6db74">&#34;screen&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;param</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;camera_name&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;$(var camera_name)&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;remap</span> <span style="color:#a6e22e">from=</span><span style="color:#e6db74">&#34;/$(var camera_name)/depth/color/points&#34;</span> <span style="color:#a6e22e">to=</span><span style="color:#e6db74">&#34;/$(var camera_name)/depth_registered/points&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/node&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/group&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/launch&gt;</span>
</span></span></code></pre></div>
<div class="notices note" ><p>더불어 한눈에 보아도 parameter들이 지저분하게 나열되어 있는 모습이 확인됩니다. 저라면 <strong>yaml file</strong>로 분리했을 것 같습니다!</p>
</div>

<blockquote>
<p>대부분의 코드들은 이미 분석하였기 때문에 이번에는 새롭게 추가되거나 변경된 내용을 위주로 분석해보겠습니다.</p>
</blockquote>
<ul>
<li>각 File별 기능은 다음과 같습니다.</li>
</ul>
<table>
<thead>
<tr>
<th>Code</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>list_devices_node.cpp</td>
<td>실행중인 모든 디바이스들을 조회합니다. multi camera를 위한 디버깅 툴로 유추됩니다.</td>
</tr>
<tr>
<td>main.cpp</td>
<td>일반적인 Node / Spin 구조의 main문으로 사실 ob_camera_node_factory를 통해 Composition으로 구현해두었기 때문에 불필요하다고 생각합니다.</td>
</tr>
<tr>
<td>ob_cleanup_shm.cpp</td>
<td>Astra에서 Node / SDK 사이 프로세싱을 thread로 처리한 것과 달리 Gemini에서는 세마포어를 사용합니다. 이에 따른 유틸리티 코드입니다.</td>
</tr>
<tr>
<td>ob_camera_node.cpp</td>
<td>실질적인 topic publish, service server들이 구현되어 있던 코드입니다. 기능은 동일하지만 구조에서 차이가 발생하였습니다.</td>
</tr>
<tr>
<td>ob_camera_node_factory.cpp</td>
<td>세마포어를 사용함에 따른 구현상의 작은 변화가 발생하였습니다.</td>
</tr>
</tbody>
</table>

<div class="notices note" ><p>list_devices_node.cpp의 빌드 결과물인 list_devices_node의 실행 결과입니다.</p>
</div>

<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>ros2 run orbbec_camera list_devices_node
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>[I20230510 19:48:22.675072 28664 DeviceManager.cpp:375] Orbbec Gemini 2 Depth Camera
</span></span><span style="display:flex;"><span>[I20230510 19:48:22.675125 28664 DeviceManager.cpp:375] Orbbec Gemini 2 IR Camera
</span></span><span style="display:flex;"><span>[I20230510 19:48:22.675169 28664 DeviceManager.cpp:375] Orbbec Gemini 2 RGB Camera
</span></span><span style="display:flex;"><span>[I20230510 19:48:22.675212 28664 DeviceManager.cpp:375] Orbbec Gemini Data Channel
</span></span><span style="display:flex;"><span>[I20230510 19:48:22.675287 28664 DeviceManager.cpp:375] Orbbec Gemini 2 IMU
</span></span></code></pre></div><blockquote>
<p>ob_camera_node.cpp의 구조를 분석해보겠습니다. 대부분의 구조는 동일하며 이름의 변경과 구현상의 차이만 있을 뿐 Astra plus와 일맥상통합니다.</p>
</blockquote>
<ul>
<li>
<p>OBCameraNode</p>
<ul>
<li>setupDefaultImageFormat</li>
<li>setupTopics
<ul>
<li>getParameters (몇가지 parameter가 추가되었습니다.)</li>
<li>setupDevices</li>
<li>setupProfiles</li>
<li><del>setupDefaultStreamCalibData</del></li>
<li>setupCameraCtrlServices</li>
<li>setupPublishers</li>
<li>publishStaticTransforms</li>
</ul>
</li>
<li><del>startPipeline</del> ⇒ startStreams
<ul>
<li>setupPipelineConfig</li>
<li>onNewFrameSetCallback
<ul>
<li>color_frame</li>
<li>depth_frame</li>
<li>ir_frame</li>
<li>publishPointCloud</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>onNewFrameSetCallback에서 구현상 변경이 발생하였으며, Orbbec SDK와 ROS 2 Topic을 연동하는 onNewFrameCallback 매핑이 이루어졌습니다.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> color_frame <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>dynamic_pointer_cast<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>Frame<span style="color:#f92672">&gt;</span>(frame_set<span style="color:#f92672">-&gt;</span>colorFrame());
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> depth_frame <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>dynamic_pointer_cast<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>Frame<span style="color:#f92672">&gt;</span>(frame_set<span style="color:#f92672">-&gt;</span>depthFrame());
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">auto</span> ir_frame <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>dynamic_pointer_cast<span style="color:#f92672">&lt;</span>ob<span style="color:#f92672">::</span>Frame<span style="color:#f92672">&gt;</span>(frame_set<span style="color:#f92672">-&gt;</span>irFrame());
</span></span><span style="display:flex;"><span>onNewFrameCallback(color_frame, COLOR);
</span></span><span style="display:flex;"><span>onNewFrameCallback(depth_frame, DEPTH);
</span></span><span style="display:flex;"><span>onNewFrameCallback(ir_frame, INFRA0);
</span></span><span style="display:flex;"><span>publishPointCloud(frame_set);
</span></span></code></pre></div>

<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/kr/ros2_foxy/lecture16/" title="Lecture16. Useful ROS 2 Examples (Misc)"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/kr/ros2_foxy/lecture18/" title="Lecture18. Point Cloud Deep Learning Example (PointNet)" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1685267036"></script>
    <script src="/js/perfect-scrollbar.min.js?1685267036"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1685267036"></script>
    <script src="/js/jquery.sticky.js?1685267036"></script>
    <script src="/js/featherlight.min.js?1685267036"></script>
    <script src="/js/highlight.pack.js?1685267036"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1685267036"></script>
    <script src="/js/learn.js?1685267036"></script>
    <script src="/js/hugo-learn.js?1685267036"></script>
    
        
            <script src="https://unpkg.com/mermaid@8.8.0/dist/mermaid.min.js"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

